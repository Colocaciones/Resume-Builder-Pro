<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrativo - UAGM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<!-- Scripts Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
       .header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #c8102e 100%);
    color: white;
    padding: 25px 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    position: relative;
    overflow: hidden;
    animation: gradientShift 15s ease infinite;
    background-size: 200% 200%;
}

.header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
    pointer-events: none;
}

@keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.header-left {
    display: flex;
    align-items: center;
    gap: 20px;
    position: relative;
    z-index: 2;
}

.header-left img {
    height: 70px;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
    transition: transform 0.3s ease;
}

.header-left img:hover {
    transform: scale(1.05) rotate(-2deg);
}

.header-title {
    font-size: 26px;
    font-weight: 800;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    letter-spacing: 0.5px;
}

.header-subtitle {
    font-size: 14px;
    opacity: 0.95;
    font-weight: 500;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 20px;
    position: relative;
    z-index: 2;
}

.user-info {
    text-align: right;
    padding: 10px 15px;
    background: rgba(255,255,255,0.15);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
}

.logout-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 2px solid rgba(255,255,255,0.3);
    padding: 12px 20px;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-weight: 600;
    backdrop-filter: blur(10px);
}

.logout-btn:hover {
    background: rgba(255,255,255,0.35);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    border-color: rgba(255,255,255,0.5);
}
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        
        .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
    animation: fadeInUp 0.8s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.stat-card {
    background: white;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    text-align: center;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    border: 2px solid transparent;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #c8102e 100%);
    transform: scaleX(0);
    transition: transform 0.4s ease;
}

.stat-card:hover::before {
    transform: scaleX(1);
}

.stat-card:hover {
    transform: translateY(-10px) scale(1.03);
    box-shadow: 0 15px 40px rgba(200,16,46,0.2);
    border-color: rgba(200,16,46,0.2);
}

.stat-icon {
    font-size: 52px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
}

.stat-card:hover .stat-icon {
    transform: scale(1.15) rotate(5deg);
}

.stat-card.offers .stat-icon { 
    color: #17a2b8;
    text-shadow: 0 0 20px rgba(23,162,184,0.3);
}

.stat-card.participants .stat-icon { 
    color: #28a745;
    text-shadow: 0 0 20px rgba(40,167,69,0.3);
}

.stat-card.applications .stat-icon { 
    color: #ffc107;
    text-shadow: 0 0 20px rgba(255,193,7,0.3);
}

.stat-card.companies .stat-icon { 
    color: #6f42c1;
    text-shadow: 0 0 20px rgba(111,66,193,0.3);
}

.stat-number {
    font-size: 42px;
    font-weight: 800;
    color: #2d3748;
    display: block;
    background: linear-gradient(135deg, #2d3748 0%, #c8102e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    transition: transform 0.3s ease;
}

.stat-card:hover .stat-number {
    transform: scale(1.1);
}

.stat-label {
    font-size: 16px;
    color: #6c757d;
    margin-top: 8px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 13px;
}
        
        .main-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
    animation: fadeIn 0.6s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.section {
    background: white;
    border-radius: 20px;
    padding: 35px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: box-shadow 0.3s ease;
    border: 1px solid rgba(0,0,0,0.05);
}

.section:hover {
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 3px solid transparent;
    background: linear-gradient(to right, #e2e8f0, transparent);
    border-image: linear-gradient(90deg, #c8102e, transparent) 1;
    border-image-slice: 1;
}

.section-title {
    font-size: 26px;
    color: #2d3748;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 800;
}

.section-title i {
    color: #c8102e;
    font-size: 28px;
    filter: drop-shadow(0 2px 4px rgba(200,16,46,0.3));
}

.section-actions {
    display: flex;
    gap: 12px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 50px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    transform: translate(-50%, -50%);
    transition: width 0.5s, height 0.5s;
}

.btn:hover::before {
    width: 300px;
    height: 300px;
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.btn:active {
    transform: translateY(-1px);
}

.btn-primary { 
    background: linear-gradient(135deg, #c8102e 0%, #8b0b1f 100%);
    color: white; 
}

.btn-primary:hover { 
    background: linear-gradient(135deg, #a00d26 0%, #6d0918 100%);
}

.btn-success { 
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    color: white; 
}

.btn-success:hover { 
    background: linear-gradient(135deg, #218838 0%, #145523 100%);
}

.btn-info { 
    background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
    color: white; 
}

.btn-info:hover { 
    background: linear-gradient(135deg, #138496 0%, #0c5460 100%);
}

.btn-warning { 
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
    color: #212529; 
    font-weight: 700;
}

.btn-warning:hover { 
    background: linear-gradient(135deg, #e0a800 0%, #c69500 100%);
}

.btn-secondary { 
    background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
    color: white; 
}

.btn-secondary:hover { 
    background: linear-gradient(135deg, #5a6268 0%, #3d4246 100%);
}

.btn-danger { 
    background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
    color: white; 
}

.btn-danger:hover { 
    background: linear-gradient(135deg, #c82333 0%, #a71d2a 100%);
}
        
        .tabs {
    display: flex;
    margin-bottom: 30px;
    border-bottom: none;
    gap: 10px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 15px;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
}

.tab {
    flex: 1;
    padding: 15px 20px;
    background: transparent;
    border: none;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border-radius: 12px;
    color: #6c757d;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.tab i {
    font-size: 16px;
    transition: transform 0.3s ease;
}

.tab.active {
    background: linear-gradient(135deg, #c8102e 0%, #8b0b1f 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(200,16,46,0.3);
    transform: translateY(-2px);
}

.tab.active i {
    transform: scale(1.2);
}

.tab:not(.active):hover {
    background: rgba(200, 16, 46, 0.1);
    color: #c8102e;
    transform: translateY(-2px);
}

.tab:not(.active):hover i {
    transform: scale(1.1);
}
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 20px;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 2px 15px rgba(0,0,0,0.05);
}

.data-table th,
.data-table td {
    padding: 16px 12px;
    text-align: left;
    border-bottom: 1px solid #f1f3f5;
}

.data-table th {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    font-weight: 700;
    color: #495057;
    position: sticky;
    top: 0;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.5px;
    border-bottom: 3px solid #c8102e;
}

.data-table tbody tr {
    transition: all 0.3s ease;
}

.data-table tbody tr:hover {
    background: linear-gradient(90deg, rgba(200,16,46,0.05) 0%, transparent 100%);
    transform: scale(1.01);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

.status-badge {
    padding: 6px 14px;
    border-radius: 50px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.status-active { 
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    color: #0c5460; 
}

.status-expired { 
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24; 
}

.status-expiring { 
    background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
    color: #856404; 
}

.status-pending { 
    background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%);
    color: #383d41; 
}

.status-approved { 
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724; 
}

.actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.btn-small {
    padding: 8px 14px;
    font-size: 12px;
    border-radius: 8px;
    min-width: auto;
}

.btn-small:hover {
    transform: translateY(-2px) scale(1.05);
}

.search-filter-bar {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
    flex-wrap: wrap;
    align-items: center;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
}

.search-input {
    flex: 1;
    min-width: 250px;
    padding: 12px 18px;
    border: 2px solid #e2e8f0;
    border-radius: 50px;
    font-size: 14px;
    transition: all 0.3s ease;
    background: white;
}

.search-input:focus {
    outline: none;
    border-color: #c8102e;
    box-shadow: 0 0 0 4px rgba(200,16,46,0.1);
    transform: translateY(-2px);
}

.filter-select {
    padding: 12px 18px;
    border: 2px solid #e2e8f0;
    border-radius: 50px;
    font-size: 14px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
}

.filter-select:focus {
    outline: none;
    border-color: #c8102e;
    box-shadow: 0 0 0 4px rgba(200,16,46,0.1);
}

.filter-select:hover {
    border-color: #c8102e;
}

.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
    backdrop-filter: blur(5px);
    display: none;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background: white;
    border-radius: 20px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideInUp 0.3s ease;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 30px;
    border-bottom: 1px solid #e2e8f0;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 20px 20px 0 0;
}

.modal-body {
    padding: 30px;
}

.modal-footer {
    padding: 25px 30px;
    border-top: 1px solid #e2e8f0;
    background: #f8f9fa;
    border-radius: 0 0 20px 20px;
    display: flex;
    justify-content: end;
    gap: 12px;
}

.close {
    position: absolute;
    top: 25px;
    right: 30px;
    color: #aaa;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.close:hover {
    color: #c8102e;
    background: rgba(200,16,46,0.1);
    transform: rotate(90deg);
}

.no-data {
    text-align: center;
    padding: 80px 20px;
    color: #6c757d;
}

.no-data i {
    font-size: 72px;
    margin-bottom: 25px;
    opacity: 0.3;
    color: #c8102e;
}

.no-data h3 {
    font-size: 24px;
    margin-bottom: 10px;
    color: #2d3748;
}

.quick-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.quick-stat {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    border-left: 5px solid #c8102e;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.quick-stat:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(200,16,46,0.15);
}

.quick-stat-number {
    font-size: 32px;
    font-weight: 800;
    background: linear-gradient(135deg, #c8102e 0%, #8b0b1f 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.quick-stat-label {
    font-size: 11px;
    color: #6c757d;
    text-transform: uppercase;
    margin-top: 8px;
    font-weight: 700;
    letter-spacing: 0.5px;
}
        
        @media (max-width: 1024px) {
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <img src="logo blanco.png" alt="UAGM Logo">
            <div>
                <div class="header-title">Dashboard Administrativo</div>
                <div class="header-subtitle">Portal de Empleos UAGM</div>
            </div>
        </div>
        <div class="header-right">
    <div class="notifications-container">
        <button class="notification-bell" onclick="toggleNotifications()">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
        </button>
        
        <div class="notifications-dropdown" id="notificationsDropdown">
            <div class="notifications-header">
                <h4>Notificaciones</h4>
                <button class="mark-all-read" onclick="markAllAsRead()">Marcar como le칤das</button>
            </div>
            <div class="notifications-list" id="notificationsList">
                <!-- Las notificaciones se generan din치micamente -->
            </div>
        </div>
    </div>
    
    <div class="user-info">
        <div style="font-weight: 600;">Administrador</div>
        <div style="font-size: 12px; opacity: 0.8;">Oficina de Carreras y Colocaciones</div>
    </div>
    <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Salir
    </button>
</div>
    </div>

    <div class="container">
        <!-- Estad칤sticas Principales -->
        <div class="stats-grid">
            <div class="stat-card offers">
                <div class="stat-icon">
                    <i class="fas fa-briefcase"></i>
                </div>
                <span class="stat-number" id="totalOffers">0</span>
                <div class="stat-label">Ofertas Totales</div>
            </div>
            
            <div class="stat-card participants">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <span class="stat-number" id="totalParticipants">0</span>
                <div class="stat-label">Participantes Registrados</div>
            </div>
            
            <div class="stat-card applications">
                <div class="stat-icon">
                    <i class="fas fa-paper-plane"></i>
                </div>
                <span class="stat-number" id="totalApplications">0</span>
                <div class="stat-label">Solicitudes Pendientes</div>
            </div>
            
            <div class="stat-card companies">
                <div class="stat-icon">
                    <i class="fas fa-building"></i>
                </div>
                <span class="stat-number" id="totalCompanies">0</span>
                <div class="stat-label">Empresas Activas</div>
            </div>
<div class="stat-card" style="border-left: 4px solid #6f42c1;">
                <div class="stat-icon" style="color: #6f42c1;">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <span class="stat-number" id="totalAppointments">0</span>
                <div class="stat-label">Citas Programadas</div>
            </div>
<div class="stat-card" style="border-left: 4px solid #28a745;">
                <div class="stat-icon" style="color: #28a745;">
                    <i class="fas fa-trophy"></i>
                </div>
                <span class="stat-number" id="totalPlacements">0</span>
                <div class="stat-label">Colocados</div>
            </div>

<div class="stat-card" style="border-left: 4px solid #17a2b8;">
               <div class="stat-icon" style="color: #17a2b8;">
                   <i class="fas fa-file-alt"></i>
                </div>
                <span class="stat-number" id="totalResumeRegistrations">0</span>
                <div class="stat-label">Registros Resume Builder</div>
            </div>
<div class="stat-card" style="border-left: 4px solid #28a745;">
    <div class="stat-icon" style="color: #28a745;">
        <i class="fas fa-clipboard-check"></i>
    </div>
    <span class="stat-number" id="totalFollowups">0</span>
    <div class="stat-label">Seguimientos Manpower</div>
            </div>

        </div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Panel de Control
                    </h2>
                    <div class="section-actions">
                        <button class="btn btn-success" onclick="exportAllData()">
                            <i class="fas fa-download"></i> Exportar Todo
                        </button>
                        <button class="btn btn-info" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('offers')">
                        <i class="fas fa-briefcase"></i> Ofertas de Empleo
                    </button>
                    <button class="tab" onclick="switchTab('participants')">
                        <i class="fas fa-users"></i> Participantes
                    </button>
                    <button class="tab" onclick="switchTab('applications')">
                        <i class="fas fa-paper-plane"></i> Solicitudes
                    </button>
                    <button class="tab" onclick="switchTab('reports')">
                        <i class="fas fa-chart-bar"></i> Reportes
                    </button>
                    <button class="tab" onclick="switchTab('appointments')">
                        <i class="fas fa-calendar-alt"></i> Citas
                    </button>
                    <button class="tab" onclick="switchTab('pending')">
                        <i class="fas fa-clock"></i> Solicitudes Pendientes
   		    <span class="pending-badge" id="pendingCount" style="background: #ff4757; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; margin-left: 5px; display: none;">0</span>
		    </button>
                    <button class="tab" onclick="switchTab('placements')">
                        <i class="fas fa-trophy"></i> Colocados
                    </button>
                    <button class="tab" onclick="switchTab('resumes')">
                        <i class="fas fa-file-alt"></i> Resume Builder
                    </button>
                    <button class="tab" onclick="switchTab('followups')">
                        <i class="fas fa-clipboard-check"></i> Seguimientos Manpower
                    </button>
                </div>

                <!-- Tab Ofertas -->
                <div class="tab-content active" id="offersContent">
                    <div class="quick-stats">
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="activeOffers">0</div>
                            <div class="quick-stat-label">Ofertas Activas</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="expiringSoon">0</div>
                            <div class="quick-stat-label">Vencen Pronto</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="expiredOffers">0</div>
                            <div class="quick-stat-label">Vencidas</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="newThisMonth">0</div>
                            <div class="quick-stat-label">Nuevas Este Mes</div>
                        </div>
                    </div>

                    <div class="search-filter-bar">
                        <input type="text" class="search-input" id="offersSearch" placeholder="游댌 Buscar ofertas..." oninput="filterOffers()">
                        <select class="filter-select" id="offersStatusFilter" onchange="filterOffers()">
                            <option value="">Todos los Estados</option>
                            <option value="active">Activas</option>
                            <option value="expiring">Vencen Pronto</option>
                            <option value="expired">Vencidas</option>
                        </select>
<select class="filter-select" id="offersSortFilter" onchange="filterOffers()">
    <option value="">Ordenar por...</option>
    <option value="newest">M치s Recientes</option>
    <option value="oldest">M치s Antiguas</option>
    <option value="deadline-asc">Vencen Primero</option>
    <option value="deadline-desc">Vencen 칔ltimo</option>
</select>
                        <button class="btn btn-primary" onclick="exportOffersData()">
                            <i class="fas fa-file-excel"></i> Exportar
                        </button>
                    </div>

                    <div id="offersTableContainer">
                        <!-- Tabla se genera din치micamente -->
                    </div>
                </div>

                <!-- Tab Participantes -->
                <div class="tab-content" id="participantsContent">
                    <div class="quick-stats">
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="newParticipants">0</div>
                            <div class="quick-stat-label">Nuevos Participantes</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="returningParticipants">0</div>
                            <div class="quick-stat-label">Participantes de Seguimiento</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="graduationCandidates">0</div>
                            <div class="quick-stat-label">Candidatos a Graduaci칩n</div>
                        </div>
                    </div>

                    <div class="search-filter-bar">
                        <input type="text" class="search-input" id="participantsSearch" placeholder="游댌 Buscar participantes..." oninput="filterParticipants()">
                        <select class="filter-select" id="participantsCampusFilter" onchange="filterParticipants()">
                            <option value="">Todos los Recintos</option>
                            <option value="cupey">Recinto de Cupey</option>
                            <option value="bayamon">Centro Universitario de Bayam칩n</option>
                            <option value="aguadilla">Centro Universitario de Aguadilla</option>
                        </select>
                        <select class="filter-select" id="participantsTypeFilter" onchange="filterParticipants()">
                            <option value="">Todos los Tipos</option>
                            <option value="new">Nuevos</option>
                            <option value="returning">Seguimiento</option>
                        </select>
                        <button class="btn btn-primary" onclick="exportParticipantsData()">
                            <i class="fas fa-file-excel"></i> Exportar
                        </button>
                    </div>

                    <div id="participantsTableContainer">
                        <!-- Tabla se genera din치micamente -->
                    </div>
                </div>

                <!-- Tab Solicitudes -->
                <div class="tab-content" id="applicationsContent">
                    <div class="quick-stats">
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="pendingApplications">0</div>
                            <div class="quick-stat-label">Pendientes</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="processedApplications">0</div>
                            <div class="quick-stat-label">Procesadas</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="todayApplications">0</div>
                            <div class="quick-stat-label">Hoy</div>
                        </div>
                    </div>

                    <div class="search-filter-bar">
                        <input type="text" class="search-input" id="applicationsSearch" placeholder="游댌 Buscar solicitudes..." oninput="filterApplications()">
                        <select class="filter-select" id="applicationsStatusFilter" onchange="filterApplications()">
    <option value="">Todos los Estados</option>
    <option value="pending">Pendientes</option>
    <option value="processed">Procesadas</option>
    <option value="referred">Referidas</option>
    <option value="approved_sent">Referidos Enviados</option>
    <option value="rejected">Rechazadas</option>
</select>
                        <button class="btn btn-primary" onclick="exportApplicationsData()">
                            <i class="fas fa-file-excel"></i> Exportar
                        </button>
                    </div>

                    <div id="applicationsTableContainer">
                        <!-- Tabla se genera din치micamente -->
                    </div>
                </div>

                <!-- Tab Reportes -->
                <div class="tab-content" id="reportsContent">
                    <div class="quick-stats">
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="placementRate">0%</div>
                            <div class="quick-stat-label">Tasa de Colocaci칩n</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="avgApplications">0</div>
                            <div class="quick-stat-label">Promedio Solicitudes</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="activeCompanies">0</div>
                            <div class="quick-stat-label">Empresas Activas</div>
                        </div>
                    </div>

                    <div class="search-filter-bar">
                        <select class="filter-select" id="reportsDateFilter" onchange="updateReports()">
                            <option value="month">Este Mes</option>
                            <option value="quarter">Este Trimestre</option>
                            <option value="year">Este A침o</option>
                            <option value="all">Todo el Tiempo</option>
                        </select>
                        <button class="btn btn-success" onclick="generateMonthlyReport()">
                            <i class="fas fa-file-pdf"></i> Reporte Mensual
                        </button>
                        <button class="btn btn-info" onclick="generateDetailedReport()">
                            <i class="fas fa-chart-pie"></i> Reporte Detallado
                        </button>
                    </div>

                    <div id="reportsContainer">
                        <div class="no-data">
                            <i class="fas fa-chart-bar"></i>
                            <h3>Reportes y Estad칤sticas</h3>
                            <p>Selecciona un per칤odo para generar reportes detallados</p>
                        </div>
                    </div>
                </div>
<!-- Tab Citas -->
<div class="tab-content" id="appointmentsContent">
    <div class="quick-stats">
        <div class="quick-stat">
            <div class="quick-stat-number" id="todayAppointments">0</div>
            <div class="quick-stat-label">Citas Hoy</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="upcomingAppointments">0</div>
            <div class="quick-stat-label">Pr칩ximas Citas</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="completedAppointments">0</div>
            <div class="quick-stat-label">Completadas</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="manpowerAppointments">0</div>
            <div class="quick-stat-label">Con Manpower</div>
        </div>
    </div>

    <div class="search-filter-bar">
        <input type="text" class="search-input" id="appointmentsSearch" placeholder="游댌 Buscar citas..." oninput="filterAppointments()">
        <select class="filter-select" id="appointmentsStatusFilter" onchange="filterAppointments()">
            <option value="">Todos los Estados</option>
            <option value="scheduled">Programadas</option>
            <option value="completed">Completadas</option>
            <option value="cancelled">Canceladas</option>
        </select>
        <select class="filter-select" id="appointmentsDateFilter" onchange="filterAppointments()">
            <option value="">Todas las Fechas</option>
            <option value="today">Hoy</option>
            <option value="week">Esta Semana</option>
            <option value="month">Este Mes</option>
        </select>
        <button class="btn btn-primary" onclick="exportAppointmentsData()">
            <i class="fas fa-file-excel"></i> Exportar
        </button>
    </div>

    <div id="appointmentsTableContainer">
        <!-- Tabla se genera din치micamente -->
    </div>
</div>

<!-- Tab Solicitudes Pendientes -->
<div class="tab-content" id="pendingContent">
    <div class="quick-stats">
        <div class="quick-stat">
            <div class="quick-stat-number" id="pendingApplications">0</div>
            <div class="quick-stat-label">Pendientes Revisi칩n</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="approvedToday">0</div>
            <div class="quick-stat-label">Aprobadas Hoy</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="rejectedToday">0</div>
            <div class="quick-stat-label">Rechazadas Hoy</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="avgReviewTime">0h</div>
            <div class="quick-stat-label">Tiempo Promedio</div>
        </div>
    </div>

    <div class="search-filter-bar">
        <input type="text" class="search-input" id="pendingSearch" placeholder="游댌 Buscar solicitudes pendientes..." oninput="filterPendingApplications()">
        <select class="filter-select" id="pendingDateFilter" onchange="filterPendingApplications()">
            <option value="">Todas las Fechas</option>
            <option value="today">Hoy</option>
            <option value="week">Esta Semana</option>
            <option value="month">Este Mes</option>
        </select>
        <button class="btn btn-primary" onclick="exportPendingData()">
            <i class="fas fa-file-excel"></i> Exportar
        </button>
    </div>

    <div id="pendingApplicationsContainer">
        <!-- Las solicitudes pendientes se cargan aqu칤 -->
    </div>
</div>

<!-- Tab Colocados -->
                <div class="tab-content" id="placementsContent">
                    <div class="quick-stats">
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="directPlacements">0</div>
                            <div class="quick-stat-label">Seguimiento Directo</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="indirectPlacements">0</div>
                            <div class="quick-stat-label">Seguimiento Indirecto</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="thisMonthPlacements">0</div>
                            <div class="quick-stat-label">Este Mes</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number" id="placementRate">0%</div>
                            <div class="quick-stat-label">Tasa de Colocaci칩n</div>
                        </div>
                    </div>

                    <div class="search-filter-bar">
                        <input type="text" class="search-input" id="placementsSearch" placeholder="游댌 Buscar colocados..." oninput="filterPlacements()">
                        <select class="filter-select" id="placementsTypeFilter" onchange="filterPlacements()">
                            <option value="">Todos los Tipos</option>
                            <option value="directo">Seguimiento Directo</option>
                            <option value="indirecto">Seguimiento Indirecto</option>
                        </select>
                        <select class="filter-select" id="placementsDateFilter" onchange="filterPlacements()">
                            <option value="">Todas las Fechas</option>
                            <option value="month">Este Mes</option>
                            <option value="quarter">Este Trimestre</option>
                            <option value="year">Este A침o</option>
                        </select>
                        <button class="btn btn-success" onclick="showAddPlacementModal()">
                            <i class="fas fa-plus"></i> Registrar Colocado
                        </button>
                        <button class="btn btn-primary" onclick="exportPlacementsData()">
                            <i class="fas fa-file-excel"></i> Exportar
                        </button>
                    </div>

                    <div id="placementsTableContainer">
                        <!-- Tabla se genera din치micamente -->
                    </div>
                </div>

<!-- Tab Resume Builder -->
<div class="tab-content" id="resumesContent">
    <div class="quick-stats">
        <div class="quick-stat">
            <div class="quick-stat-number" id="newResumeRegistrations">0</div>
            <div class="quick-stat-label">Nuevos Participantes</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="returningResumeRegistrations">0</div>
            <div class="quick-stat-label">Seguimiento</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="studentRegistrations">0</div>
            <div class="quick-stat-label">Estudiantes</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="thisMonthResumes">0</div>
            <div class="quick-stat-label">Este Mes</div>
        </div>
    </div>

    <div class="search-filter-bar">
        <input type="text" class="search-input" id="resumesSearch" placeholder="游댌 Buscar registros..." oninput="filterResumeRegistrations()">
        <select class="filter-select" id="resumesTypeFilter" onchange="filterResumeRegistrations()">
            <option value="">Todos los Tipos</option>
            <option value="Nuevo">Nuevos</option>
            <option value="Participante de Seguimiento (He recibido los servicios anteriormente)">Seguimiento</option>
        </select>
        <select class="filter-select" id="resumesUserTypeFilter" onchange="filterResumeRegistrations()">
            <option value="">Todos los Usuarios</option>
            <option value="Estudiante">Estudiantes</option>
            <option value="Exalumno">Exalumnos</option>
            <option value="Comunidad">Comunidad</option>
        </select>
        <select class="filter-select" id="resumesDateFilter" onchange="filterResumeRegistrations()">
            <option value="">Todas las Fechas</option>
            <option value="today">Hoy</option>
            <option value="week">Esta Semana</option>
            <option value="month">Este Mes</option>
        </select>
        <button class="btn btn-primary" onclick="exportResumeRegistrationsData()">
            <i class="fas fa-file-excel"></i> Exportar
        </button>
    </div>

    <div id="resumeRegistrationsTableContainer">
        <!-- Tabla se genera din치micamente -->
    </div>
</div>

<!-- Tab Seguimientos Manpower -->
<div class="tab-content" id="followupsContent">
    <div class="quick-stats">
        <div class="quick-stat">
            <div class="quick-stat-number" id="newFollowups">0</div>
            <div class="quick-stat-label">Nuevos Participantes</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="returningFollowups">0</div>
            <div class="quick-stat-label">Seguimiento</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="thisMonthFollowups">0</div>
            <div class="quick-stat-label">Este Mes</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number" id="citadosFollowups">0</div>
            <div class="quick-stat-label">Citados</div>
        </div>
    </div>

    <div class="search-filter-bar">
        <input type="text" class="search-input" id="followupsSearch" placeholder="游댌 Buscar seguimientos..." oninput="filterFollowups()">
        <select class="filter-select" id="followupsTypeFilter" onchange="filterFollowups()">
            <option value="">Todos los Tipos</option>
            <option value="new">Nuevos</option>
            <option value="returning">Seguimiento</option>
        </select>
        <select class="filter-select" id="followupsParticipantTypeFilter" onchange="filterFollowups()">
            <option value="">Tipo Participante</option>
            <option value="citado">Citado</option>
            <option value="walk-in">Walk-in</option>
        </select>
        <select class="filter-select" id="followupsDateFilter" onchange="filterFollowups()">
            <option value="">Todas las Fechas</option>
            <option value="today">Hoy</option>
            <option value="week">Esta Semana</option>
            <option value="month">Este Mes</option>
        </select>
        <button class="btn btn-primary" onclick="exportFollowupsData()">
            <i class="fas fa-file-excel"></i> Exportar
        </button>
    </div>

    <div id="followupsTableContainer">
        <!-- Tabla se genera din치micamente -->
    </div>
</div>

    <!-- Modal para Ver Detalles -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Detalles</h3>
                <span class="close" onclick="closeDetailsModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Contenido din치mico -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetailsModal()">Cerrar</button>
                <button class="btn btn-primary" id="modalAction" style="display: none;">
                    Acci칩n
                </button>
            </div>
        </div>
    </div>
<!-- Modal para Registrar Colocado -->
    <div id="placementModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="placementModalTitle">Registrar Nuevo Colocado</h3>
                <span class="close" onclick="closePlacementModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="placementForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Participante *</label>
                            <input type="text" id="placement-participantName" required placeholder="Nombre completo">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="placement-email" placeholder="correo@ejemplo.com">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Empresa donde fue colocado *</label>
                            <input type="text" id="placement-company" required placeholder="Nombre de la empresa">
                        </div>
                        <div class="form-group">
                            <label>Posici칩n obtenida *</label>
                            <input type="text" id="placement-position" required placeholder="T칤tulo del puesto">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha de colocaci칩n *</label>
                            <input type="date" id="placement-date" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo de colocaci칩n *</label>
                            <select id="placement-trackingType" required>
                                <option value="">Seleccionar...</option>
                                <option value="directo">Seguimiento Directo</option>
                                <option value="indirecto">Seguimiento Indirecto</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de posici칩n *</label>
                            <select id="placement-positionType" required>
                                <option value="">Seleccionar...</option>
                                <option value="part-time">Part Time</option>
                                <option value="full-time">Full Time</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Modalidad *</label>
                            <select id="placement-modality" required>
                                <option value="">Seleccionar...</option>
                                <option value="regular">Posici칩n Regular</option>
                                <option value="temporera">Posici칩n Temporera</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de persona *</label>
                            <select id="placement-personType" required onchange="toggleStudentFields()">
                                <option value="">Seleccionar...</option>
                                <option value="estudiante">Estudiante</option>
                                <option value="exalumno">Exalumno</option>
                                <option value="comunidad">Comunidad</option>
                            </select>
                        </div>
                        <div class="form-group" id="studentIdGroup" style="display: none;">
                            <label>ID de estudiante</label>
                            <input type="text" id="placement-studentId" placeholder="ID del estudiante">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Grado obtenido/en curso *</label>
                            <select id="placement-degree" required>
                                <option value="">Seleccionar...</option>
                                <option value="bachillerato">Bachillerato</option>
                                <option value="maestria">Maestr칤a</option>
                                <option value="asociado">Grado Asociado</option>
                                <option value="doctorado">Doctorado</option>
                                <option value="cuarto">Cuarto A침o</option>
                                <option value="certificado">Certificado T칠cnico</option>
                                <option value="11mo">11mo o menos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Concentraci칩n *</label>
                            <input type="text" id="placement-concentration" required placeholder="츼rea de estudios">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Divisi칩n acad칠mica *</label>
                            <select id="placement-division" required>
                                <option value="">Seleccionar...</option>
                                <option value="liberales">Artes Liberales</option>
                                <option value="negocios">Negocios</option>
                                <option value="tecnologia">Ciencias y Tecnolog칤a</option>
                                <option value="salud">Ciencias de la Salud</option>
                                <option value="tecnicos">Programas T칠cnicos</option>
                            </select>
                        </div>
                        <div class="form-group" id="graduationDateGroup" style="display: none;">
                            <label id="graduationDateLabel">Fecha de graduaci칩n</label>
                            <input type="date" id="placement-graduationDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notas adicionales</label>
                        <textarea id="placement-notes" rows="3" placeholder="Informaci칩n adicional sobre la colocaci칩n..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePlacementModal()">Cancelar</button>
                <button class="btn btn-success" onclick="savePlacement()">
                    <i class="fas fa-save"></i> Guardar Colocado
                </button>
            </div>
        </div>
    </div>

<!-- Modal para Ver Historial del Participante -->
<div id="participantHistoryModal" class="modal">
    <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
        <div class="modal-header">
            <h3 id="historyModalTitle">游늶 Historial del Participante</h3>
            <span class="close" onclick="closeHistoryModal()">&times;</span>
        </div>
        
        <div class="modal-body" style="max-height: calc(90vh - 200px); overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <div>
                    <h4 style="margin: 0; color: #2d3748;" id="historyParticipantName">Nombre del Participante</h4>
                    <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 14px;" id="historyParticipantEmail">email@ejemplo.com</p>
                </div>
                <div style="text-align: right;">
                    <button class="btn btn-success btn-small" onclick="generateParticipantHistoryPDF()" style="margin-right: 10px;">
                        <i class="fas fa-file-pdf"></i> Generar PDF
                    </button>
                    <button class="btn btn-info btn-small" onclick="showAddManualNoteModal()">
                        <i class="fas fa-plus"></i> Agregar Nota
                    </button>
                </div>
            </div>
            
            <div id="historyTimelineContainer">
                <!-- Timeline se genera aqu칤 -->
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeHistoryModal()">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal para Agregar Nota Manual al Historial -->
<div id="manualNoteModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>游닇 Agregar Nota al Historial</h3>
            <span class="close" onclick="closeManualNoteModal()">&times;</span>
        </div>
        
        <div class="modal-body">
            <form id="manualNoteForm">
                <div class="form-group">
                    <label>Participante:</label>
                    <input type="text" id="note-participantName" readonly style="background: #f8f9fa;">
                </div>
                
                <div class="form-group">
                    <label>Tipo de nota:</label>
                    <select id="note-type" required>
                        <option value="">Seleccionar tipo...</option>
                        <option value="service">Servicio prestado</option>
                        <option value="followup">Seguimiento</option>
                        <option value="general">Nota general</option>
                        <option value="achievement">Logro/Avance</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Descripci칩n: *</label>
                    <textarea id="note-description" rows="5" required placeholder="Ej: Estudiante solicit칩 orientaci칩n sobre b칰squeda de empleo. Se le proporcion칩 informaci칩n sobre..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Fecha del evento:</label>
                    <input type="date" id="note-date" required>
                </div>
            </form>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeManualNoteModal()">Cancelar</button>
            <button class="btn btn-success" onclick="saveManualNote()">
                <i class="fas fa-save"></i> Guardar Nota
            </button>
        </div>
    </div>
</div>

<!-- Modal para Editar Cita -->
<div id="editAppointmentModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="editAppointmentModalTitle">Editar Cita</h3>
            <span class="close" onclick="closeEditAppointmentModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editAppointmentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" id="edit-firstName" required>
                    </div>
                    <div class="form-group">
                        <label>Apellidos *</label>
                        <input type="text" id="edit-lastName" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="edit-email" required>
                    </div>
                    <div class="form-group">
                        <label>Tel칠fono *</label>
                        <input type="tel" id="edit-phone" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nueva Fecha de Cita *</label>
                        <input type="date" id="edit-appointmentDate" required>
                    </div>
                    <div class="form-group">
                        <label>Nueva Hora de Cita *</label>
                        <select id="edit-appointmentTime" required>
                            <option value="">Seleccionar hora...</option>
                            <option value="09:00">9:00 AM</option>
                            <option value="09:30">9:30 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="10:30">10:30 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="11:30">11:30 AM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="13:30">1:30 PM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="14:30">2:30 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="15:30">3:30 PM</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Concentraci칩n</label>
                        <input type="text" id="edit-concentration">
                    </div>
                    <div class="form-group">
                        <label>Recinto</label>
                        <select id="edit-campus">
                            <option value="cupey">Recinto de Cupey</option>
                            <option value="bayamon">Centro Universitario de Bayam칩n</option>
                            <option value="aguadilla">Centro Universitario de Aguadilla</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Raz칩n del cambio *</label>
                    <textarea id="edit-changeReason" rows="3" required placeholder="Ej: Participante no pudo asistir, conflicto de horarios, etc."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Descripci칩n adicional</label>
                    <textarea id="edit-description" rows="2"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEditAppointmentModal()">Cancelar</button>
            <button class="btn btn-success" onclick="saveAppointmentChanges()">
                <i class="fas fa-save"></i> Guardar Cambios
            </button>
        </div>
    </div>
</div>

<script>
        // Configuraci칩n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBFgSuKNJMUoVcKgHjsqOsInArSPBsb32A",
            authDomain: "uagm-portal-de-empleo-17aed.firebaseapp.com",
            projectId: "uagm-portal-de-empleo-17aed",
            storageBucket: "uagm-portal-de-empleo-17aed.firebasestorage.app",
            messagingSenderId: "582147767835",
            appId: "1:582147767835:web:546ab8f2557b6da6ccc2be"
        };

        // Variables globales Firebase
        let app, db, auth, storage;
        let isFirebaseInitialized = false;

        function initializeFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                storage = firebase.storage();
                console.log('Firebase inicializado correctamente en dashboard');
                return true;
            } catch (error) {
                console.error('Error inicializando Firebase:', error);
                return false;
            }
        }

        const FirebaseHelper = {
            async getDocs(collection) {
                try {
                    const snapshot = await db.collection(collection).get();
                    const docs = [];
                    snapshot.forEach(doc => {
                        docs.push({ id: doc.id, ...doc.data() });
                    });
                    return { success: true, docs };
                } catch (error) {
                    console.error('Error obteniendo documentos:', error);
                    return { success: false, error };
                }
            }
        };

        // Variables globales
        let offers = [];
        let participants = [];
        let applications = [];
        let appointments = [];
        let placements = [];
        let allOffersHistory = [];
        let resumeRegistrations = [];
        let followups = [];
        let participantHistory = []; // Array para guardar todo el historial de participantes

// Variables para mantener estado de filtros
let currentFilters = {
    offers: { search: '', status: '', sort: '' },
    participants: { search: '', campus: '', type: '' },
    applications: { search: '', status: '' },
    appointments: { search: '', status: '', date: '' },
    placements: { search: '', type: '', date: '' },
    resumes: { search: '', type: '', userType: '', date: '' },
    followups: { search: '', type: '', participantType: '', date: '' }
};

// Sistema de notificaciones
let notifications = JSON.parse(localStorage.getItem('adminNotifications')) || [];
let lastCheckedOffers = localStorage.getItem('lastCheckedOffers') ? parseInt(localStorage.getItem('lastCheckedOffers')) : 0;
let lastCheckedParticipants = localStorage.getItem('lastCheckedParticipants') ? parseInt(localStorage.getItem('lastCheckedParticipants')) : 0;
let lastCheckedApplications = localStorage.getItem('lastCheckedApplications') ? parseInt(localStorage.getItem('lastCheckedApplications')) : 0;
let lastCheckedAppointments = localStorage.getItem('lastCheckedAppointments') ? parseInt(localStorage.getItem('lastCheckedAppointments')) : 0;

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', async function() {
    isFirebaseInitialized = initializeFirebase();
    
    // 1. PRIMERO cargar historial
    await loadParticipantHistory();
    
    // 2. LUEGO cargar datos
    await loadAllData();
    
    // 3. Inicializar historial faltante (solo ejecutar si es necesario)
    // DESCOMENTA ESTA L칈NEA SOLO UNA VEZ PARA ARREGLAR DATOS EXISTENTES:
    // await initializeParticipantHistoryOnce();
    
    updateExpiredOffers(); 
    updateStats();
    updateNotificationBadge();
    updatePendingCount();
    switchTab('offers');
    console.log('Dashboard Administrativo cargado correctamente');
});

       // Cargar todos los datos desde Firebase
        async function loadAllData() {
            try {
                if (isFirebaseInitialized) {
                    // Cargar ofertas desde Firebase
                    const offersResult = await FirebaseHelper.getDocs('jobOffers');
                    if (offersResult.success) {
                        offers = offersResult.docs;
 // Mantener hist칩rico completo de todas las ofertas
    allOffersHistory = [...offers];
                        console.log('Ofertas cargadas desde Firebase:', offers.length);
                    }

                    // Cargar participantes desde Firebase
                    const participantsResult = await FirebaseHelper.getDocs('participants');
                    if (participantsResult.success) {
                        participants = participantsResult.docs;
                        console.log('Participantes cargados desde Firebase:', participants.length);
                    }

// NO HACER NADA AQU칈 - Los registros hist칩ricos se crear치n solo cuando sea necesario
// El historial inicial se debe crear UNA SOLA VEZ cuando el participante se registra por primera vez


                    // Cargar aplicaciones desde Firebase
                    const applicationsResult = await FirebaseHelper.getDocs('applications');
                    if (applicationsResult.success) {
                        applications = applicationsResult.docs;
                        console.log('Aplicaciones cargadas desde Firebase:', applications.length);
                    }

                   // Cargar citas desde Firebase
                   const appointmentsResult = await FirebaseHelper.getDocs('appointments');
                   if (appointmentsResult.success) {
                       appointments = appointmentsResult.docs;
                       console.log('Citas cargadas desde Firebase:', appointments.length);
                       
                       // Registrar citas nuevas en el historial
                       for (const appointment of appointments) {
                           const hasHistory = participantHistory.some(h => 
                               h.eventType === 'appointment_scheduled' && 
                               h.data?.appointmentId === appointment.id
                           );
                           
                           if (!hasHistory) {
                               // Buscar participante por email o nombre
                               const participant = participants.find(p => 
                                   p.email === appointment.email || 
                                   (p.firstName === appointment.firstName && p.lastName === appointment.lastName)
                               );
                               
                               if (participant) {
                                   await addToParticipantHistory(participant.id, {
                                       eventType: 'appointment_scheduled',
                                       eventTitle: 'Cita Programada',
                                       description: `Program칩 cita: ${appointment.serviceType === 'orientacion-manpower' ? 'Orientaci칩n con Manpower' : appointment.serviceType}`,
                                       data: {
                                           participantName: `${appointment.firstName} ${appointment.lastName}`,
                                           appointmentDate: appointment.appointmentDate,
                                           appointmentTime: appointment.appointmentTime,
                                           serviceType: appointment.serviceType,
                                           campus: appointment.campus,
                                           concentration: appointment.concentration,
                                           appointmentId: appointment.id,
                                           status: appointment.status
                                       }
                                   });
                               }
                           }
                       }
                   }

// Cargar colocados desde Firebase
                   const placementsResult = await FirebaseHelper.getDocs('placements');
                   if (placementsResult.success) {
                       placements = placementsResult.docs;
                       console.log('Colocados cargados desde Firebase:', placements.length);
                   }

// Cargar registros de Resume Builder desde Firebase
const resumeRegsResult = await FirebaseHelper.getDocs('resumeRegistrations');
if (resumeRegsResult.success) {
    resumeRegistrations = resumeRegsResult.docs;
    console.log('Registros Resume Builder cargados desde Firebase:', resumeRegistrations.length);
}

// Cargar seguimientos de Manpower desde Firebase
const followupsResult = await FirebaseHelper.getDocs('followups');
if (followupsResult.success) {
    followups = followupsResult.docs;
    console.log('Seguimientos Manpower cargados desde Firebase:', followups.length);
}

// Registrar eventos de Resume Builder para registros sin historial
                    if (resumeRegsResult.success && resumeRegistrations.length > 0) {
                        for (const reg of resumeRegistrations) {
                            const hasHistory = participantHistory.some(h => 
                                h.eventType === 'resume_builder' && 
                                h.data?.registrationId === reg.id
                            );
                            
                            if (!hasHistory) {
                                // Buscar participante por email o nombre
                                const participant = participants.find(p => 
                                    p.email === reg.email || 
                                    (p.firstName === reg.firstName && p.lastName === reg.lastName)
                                );
                                
                                if (participant) {
                                    await addToParticipantHistory(participant.id, {
                                        eventType: 'resume_builder',
                                        eventTitle: 'Registro Resume Builder',
                                        description: `Solicit칩 servicio de redacci칩n de resum칠`,
                                        data: {
                                            participantName: `${reg.firstName} ${reg.lastName}`,
                                            participantType: reg.participantType,
                                            userType: reg.userType,
                                            campus: reg.campus,
                                            registrationId: reg.id,
                                            registrationDate: reg.registrationDate
                                        }
                                    });
                                }
                            }
                        }
                    }

                } else {
                    throw new Error('Firebase no inicializado');
                }
           } catch (error) {
    console.error('Error cargando desde Firebase, usando localStorage:', error);

    // Fallback a localStorage
    offers = JSON.parse(localStorage.getItem('jobOffers')) || [];
    participants = JSON.parse(localStorage.getItem('participants')) || [];
    applications = JSON.parse(localStorage.getItem('applications')) || [];
    appointments = JSON.parse(localStorage.getItem('appointments')) || [];
    placements = JSON.parse(localStorage.getItem('placements')) || [];
    resumeRegistrations = JSON.parse(localStorage.getItem('resumeRegistrations')) || [];
    followups = JSON.parse(localStorage.getItem('followups')) || [];
}
// Verificar notificaciones despu칠s de cargar datos
        setTimeout(() => {
            checkForNewItems();
        }, 1000);

        }

// Funci칩n para marcar ofertas vencidas en el hist칩rico
function updateExpiredOffers() {
    const today = new Date();
    
    offers.forEach(offer => {
        if (new Date(offer.deadline) < today) {
            // Agregar al hist칩rico si no est치 ya marcada como vencida
            const existingInHistory = allOffersHistory.find(h => h.id === offer.id);
            if (existingInHistory && !existingInHistory.expiredAt) {
                existingInHistory.expiredAt = new Date().toISOString();
                existingInHistory.status = 'expired';
            }
        }
    });
}        

// Actualizar estad칤sticas principales
        function updateStats() {
            const today = new Date();
            
            // Estad칤sticas de ofertas
            const activeOffers = offers.filter(offer => getOfferStatus(offer.deadline) === 'active').length;
            const expiringSoon = offers.filter(offer => getOfferStatus(offer.deadline) === 'expiring').length;
            const expiredOffers = offers.filter(offer => getOfferStatus(offer.deadline) === 'expired').length;
            const thisMonth = offers.filter(offer => {
                const offerDate = new Date(offer.createdAt || offer.today);
                return offerDate.getMonth() === today.getMonth() && 
                       offerDate.getFullYear() === today.getFullYear();
            }).length;

            // Estad칤sticas de participantes
            const newParticipants = participants.filter(p => p.participantType === 'new').length;
            const returningParticipants = participants.filter(p => p.participantType === 'returning').length;
            const graduationCandidates = participants.filter(p => p.graduationCandidate === 'yes').length;

            // Estad칤sticas de aplicaciones
            const pendingApplications = applications.filter(app => app.status === 'pending').length;
            const processedApplications = applications.filter(app => app.status !== 'pending').length;
            const todayApplications = applications.filter(app => {
                const appDate = new Date(app.appliedAt);
                return appDate.toDateString() === today.toDateString();
            }).length;

            // Empresas 칰nicas
            const uniqueCompanies = [...new Set(offers.map(offer => offer.companyName))].length;

            // Actualizar elementos del DOM
            document.getElementById('totalOffers').textContent = offers.length;
            document.getElementById('totalParticipants').textContent = participants.length;
            document.getElementById('totalApplications').textContent = pendingApplications;
            document.getElementById('totalCompanies').textContent = uniqueCompanies;
document.getElementById('totalAppointments').textContent = appointments.length;
document.getElementById('totalPlacements').textContent = placements.length;
        
        // Stats r치pidas citas
const todayAppointments = appointments.filter(app => {
    const [year, month, day] = app.appointmentDate.split('-');
    const appDate = new Date(year, month - 1, day);
    return appDate.toDateString() === today.toDateString();
}).length;

const upcomingAppointments = appointments.filter(app => {
    const [year, month, day] = app.appointmentDate.split('-');
    const appDate = new Date(year, month - 1, day);
    return appDate > today && app.status === 'scheduled';
}).length;
        
        const completedAppointments = appointments.filter(app => app.status === 'completed').length;
        const manpowerAppointments = appointments.filter(app => app.serviceType === 'orientacion-manpower').length;
        
        document.getElementById('todayAppointments').textContent = todayAppointments;
        document.getElementById('upcomingAppointments').textContent = upcomingAppointments;
        document.getElementById('completedAppointments').textContent = completedAppointments;
        document.getElementById('manpowerAppointments').textContent = manpowerAppointments;

            // Stats r치pidas ofertas
            document.getElementById('activeOffers').textContent = activeOffers;
            document.getElementById('expiringSoon').textContent = expiringSoon;
            document.getElementById('expiredOffers').textContent = expiredOffers;
            document.getElementById('newThisMonth').textContent = thisMonth;

            // Stats r치pidas participantes
            document.getElementById('newParticipants').textContent = newParticipants;
            document.getElementById('returningParticipants').textContent = returningParticipants;
            document.getElementById('graduationCandidates').textContent = graduationCandidates;

            // Stats r치pidas aplicaciones
            document.getElementById('pendingApplications').textContent = pendingApplications;
            document.getElementById('processedApplications').textContent = processedApplications;
            document.getElementById('todayApplications').textContent = todayApplications;

            // Stats reportes
            const placementRate = participants.length > 0 ? Math.round((processedApplications / participants.length) * 100) : 0;
            const avgApplications = participants.length > 0 ? Math.round(applications.length / participants.length) : 0;
            
            document.getElementById('placementRate').textContent = placementRate + '%';
            document.getElementById('avgApplications').textContent = avgApplications;
            document.getElementById('activeCompanies').textContent = uniqueCompanies;
// Actualizar contador de pendientes en la interfaz
        updatePendingCount();

// Stats para colocados
        const directPlacements = placements.filter(p => p.trackingType === 'directo').length;
        const indirectPlacements = placements.filter(p => p.trackingType === 'indirecto').length;
        const thisMonthPlacements = placements.filter(p => {
            const placementDate = new Date(p.placementDate);
            return placementDate.getMonth() === today.getMonth() && 
                   placementDate.getFullYear() === today.getFullYear();
        }).length;
        const totalParticipantsForRate = participants.length + placements.length;
        const currentPlacementRate = totalParticipantsForRate > 0 ? Math.round((placements.length / totalParticipantsForRate) * 100) : 0;
        
        // Actualizar elementos de colocados
        if (document.getElementById('directPlacements')) {
            document.getElementById('directPlacements').textContent = directPlacements;
        }
        if (document.getElementById('indirectPlacements')) {
            document.getElementById('indirectPlacements').textContent = indirectPlacements;
        }
        if (document.getElementById('thisMonthPlacements')) {
            document.getElementById('thisMonthPlacements').textContent = thisMonthPlacements;
        }
        if (document.getElementById('placementRate')) {
            document.getElementById('placementRate').textContent = currentPlacementRate + '%';
        }

// Stats para Resume Builder
const totalResumeRegs = resumeRegistrations.length;
const newResumeRegs = resumeRegistrations.filter(r => r.participantType === 'Nuevo').length;
const returningResumeRegs = resumeRegistrations.filter(r => r.participantType && r.participantType.includes('Seguimiento')).length;
const studentRegs = resumeRegistrations.filter(r => r.userType === 'Estudiante').length;
const thisMonthResumes = resumeRegistrations.filter(r => {
    const regDate = new Date(r.registrationDate);
    return regDate.getMonth() === today.getMonth() && 
           regDate.getFullYear() === today.getFullYear();
}).length;

// Actualizar elementos Resume Builder
if (document.getElementById('totalResumeRegistrations')) {
    document.getElementById('totalResumeRegistrations').textContent = totalResumeRegs;
}
if (document.getElementById('newResumeRegistrations')) {
    document.getElementById('newResumeRegistrations').textContent = newResumeRegs;
}
if (document.getElementById('returningResumeRegistrations')) {
    document.getElementById('returningResumeRegistrations').textContent = returningResumeRegs;
}
if (document.getElementById('studentRegistrations')) {
    document.getElementById('studentRegistrations').textContent = studentRegs;
}
if (document.getElementById('thisMonthResumes')) {
    document.getElementById('thisMonthResumes').textContent = thisMonthResumes;
}



// Stats para Seguimientos Manpower
const totalFollowups = followups.length;
const newFollowups = followups.filter(f => f.participantType === 'new').length;
const returningFollowups = followups.filter(f => f.participantType === 'returning').length;
const citadosFollowups = followups.filter(f => f.type === 'citado').length;
const thisMonthFollowups = followups.filter(f => {
    const fDate = new Date(f.createdAt);
    return fDate.getMonth() === today.getMonth() && 
           fDate.getFullYear() === today.getFullYear();
}).length;

// Actualizar elementos Seguimientos
if (document.getElementById('totalFollowups')) {
    document.getElementById('totalFollowups').textContent = totalFollowups;
}
if (document.getElementById('newFollowups')) {
    document.getElementById('newFollowups').textContent = newFollowups;
}
if (document.getElementById('returningFollowups')) {
    document.getElementById('returningFollowups').textContent = returningFollowups;
}
if (document.getElementById('citadosFollowups')) {
    document.getElementById('citadosFollowups').textContent = citadosFollowups;
}
if (document.getElementById('thisMonthFollowups')) {
    document.getElementById('thisMonthFollowups').textContent = thisMonthFollowups;
}        
        // Stats para solicitudes pendientes
        const pendingAppsCount = applications.filter(app => app.status === 'pending').length;
        const approvedToday = applications.filter(app => 
            app.status === 'approved_sent' && 
            new Date(app.adminReview?.reviewedAt || '').toDateString() === today.toDateString()
        ).length;
        const rejectedToday = applications.filter(app => 
            app.status === 'rejected' && 
            new Date(app.adminReview?.reviewedAt || '').toDateString() === today.toDateString()
        ).length;
        
        if (document.getElementById('pendingApplications')) {
            document.getElementById('pendingApplications').textContent = pendingAppsCount;
        }
        if (document.getElementById('approvedToday')) {
            document.getElementById('approvedToday').textContent = approvedToday;
        }
        if (document.getElementById('rejectedToday')) {
            document.getElementById('rejectedToday').textContent = rejectedToday;
        }
        if (document.getElementById('avgReviewTime')) {
            document.getElementById('avgReviewTime').textContent = '2h'; // Puedes calcular esto despu칠s
        }
        }

        // Obtener estado de oferta
        function getOfferStatus(deadline) {
            const today = new Date();
            const deadlineDate = new Date(deadline);
            const diffTime = deadlineDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return 'expired';
            if (diffDays <= 7) return 'expiring';
            return 'active';
        }

       // Cambiar entre tabs
function switchTab(tabName) {
    currentTab = tabName;
    
    // Actualizar tabs activos
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // Activar tab correspondiente
    const tabIndex = ['offers', 'participants', 'applications', 'reports', 'appointments', 'pending', 'placements', 'resumes', 'followups'].indexOf(tabName);
    if (tabIndex !== -1) {
        document.querySelectorAll('.tab')[tabIndex].classList.add('active');
    }
    document.getElementById(tabName + 'Content').classList.add('active');
    
    // Cargar contenido espec칤fico
    switch(tabName) {
        case 'offers':
            loadOffersTable();
            break;
        case 'participants':
            loadParticipantsTable();
            break;
        case 'applications':
            loadApplicationsTable();
            break;
        case 'reports':
            updateReports();
            break;
        case 'appointments':
            loadAppointmentsTable();
            break;
        case 'pending':
            loadPendingApplicationsTable();
            break;
case 'placements':
            loadPlacementsTable();
            break;
case 'resumes':
    loadResumeRegistrationsTable();
    break;

case 'followups':
    loadFollowupsTable();
    break;

    }
}

        // Cargar tabla de ofertas
        function loadOffersTable() {
            const container = document.getElementById('offersTableContainer');
            
            if (offers.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-briefcase"></i>
                        <h3>No hay ofertas registradas</h3>
                        <p>Las ofertas publicadas por patronos aparecer치n aqu칤</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Empresa</th>
                            <th>Posici칩n</th>
                            <th>Ubicaci칩n</th>
                            <th>Salario</th>
                            <th>Tipo</th>
                            <th>Sector</th>
                            <th>Fecha L칤mite</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            offers.forEach(offer => {
                const status = getOfferStatus(offer.deadline);
                const statusClass = status === 'expired' ? 'status-expired' : 
                                  status === 'expiring' ? 'status-expiring' : 'status-active';
                const statusText = status === 'expired' ? 'Vencida' : 
                                 status === 'expiring' ? 'Vence Pronto' : 'Activa';

                html += `
                    <tr>
                       <td>${offer.today ? new Date(offer.today + 'T00:00:00').toLocaleDateString() : 'Sin fecha'}</td>
                        <td><strong>${offer.companyName}</strong><br><small>${offer.contactPerson}</small></td>
                        <td>${offer.position}</td>
                        <td>${offer.location}</td>
                        <td>${offer.salary}</td>
                        <td><span class="status-badge">${getTypeLabel(offer.positionType)}</span></td>
<td>${getSectorLabel(offer.academicDivision)}</td>
<td>${new Date(offer.deadline).toLocaleDateString('es-PR', { timeZone: 'America/Puerto_Rico' })}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <div class="actions">
                                 <button class="btn btn-info btn-small" onclick="viewOfferDetails('${offer.id}')" title="Ver detalles">
                                     <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-success btn-small" onclick="generateOfferPDF('${offer.id}')" title="Generar PDF">
                                     <i class="fas fa-file-pdf"></i>
                                </button>
                                <button class="btn btn-warning btn-small" onclick="editOffer('${offer.id}')" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
				<button class="btn btn-warning btn-small" onclick="generatePromoURL('${offer.id}')" title="Generar URL promocional">
    				    <i class="fas fa-bullhorn"></i>
				</button>
                                <button class="btn btn-danger btn-small" onclick="deleteOffer('${offer.id}')" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                             </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Cargar tabla de participantes
        function loadParticipantsTable() {
        console.log("Ejecutando loadParticipantsTable");
            const container = document.getElementById('participantsTableContainer');
            
            if (participants.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-users"></i>
                        <h3>No hay participantes registrados</h3>
                        <p>Los participantes registrados aparecer치n aqu칤</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha Registro</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Tel칠fono</th>
                            <th>Recinto</th>
                            <th>Concentraci칩n</th>
                            <th>A침o</th>
                            <th>Tipo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            participants.forEach(participant => {
                const campusLabels = {
                    'cupey': 'Cupey',
                    'bayamon': 'Bayam칩n',
                    'aguadilla': 'Aguadilla'
                };

                const typeLabels = {
                    'new': 'Nuevo',
                    'returning': 'Seguimiento'
                };

                html += `
                    <tr>
                        <td>${new Date(participant.registeredAt).toLocaleDateString()}</td>
                        <td><strong>${participant.firstName} ${participant.lastName}</strong><br><small>ID: ${participant.studentId}</small></td>
                        <td>${participant.email}</td>
                        <td>${participant.phone}</td>
                        <td>${campusLabels[participant.campus] || participant.campus}</td>
                        <td>${participant.concentration}</td>
                        <td>${participant.studyYear}</td>
                        <td><span class="status-badge status-active">${typeLabels[participant.participantType]}</span></td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-info btn-small" onclick="viewParticipantDetails('${participant.id}')" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-warning btn-small" onclick="viewParticipantHistory('${participant.id}')" title="Ver historial">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button class="btn btn-success btn-small" onclick="downloadResume('${participant.id}')" title="Descargar resum칠">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteParticipant('${participant.id}')" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Cargar tabla de aplicaciones
        function loadApplicationsTable() {
            const container = document.getElementById('applicationsTableContainer');
            
            if (applications.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-paper-plane"></i>
                        <h3>No hay solicitudes registradas</h3>
                        <p>Las solicitudes de participantes aparecer치n aqu칤</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Participante</th>
                            <th>Empresa</th>
                            <th>Posici칩n</th>
                            <th>Contacto</th>
                            <th>Estado</th>
			    <th>Tipo Estudiante</th>
                            <th>Concentraci칩n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            applications.forEach(application => {
                const statusLabels = {
    'pending': 'Pendiente',
    'processed': 'Procesada',
    'referred': 'Referida',
    'approved_sent': 'Referido Enviado',
    'rejected': 'Rechazada'
};

                const statusClasses = {
    'pending': 'status-pending',
    'processed': 'status-approved',
    'referred': 'status-active',
    'approved_sent': 'status-approved',
    'rejected': 'status-expired'
};

                html += `
                    <tr>
                        <td>${new Date(application.appliedAt).toLocaleDateString()}</td>
                        <td><strong>${application.participantName}</strong><br><small>${application.participantEmail}</small></td>
                        <td>${application.companyName}</td>
                        <td>${application.offerTitle}</td>
                        <td>${application.participantPhone}</td>
                        <td><span class="status-badge ${statusClasses[application.status]}">${statusLabels[application.status]}</span></td>
                        <td>${getStudentTypeLabel(application.participantData?.studentType || getParticipantData(application.participantId)?.studentType || 'N/A')}</td>
                        <td>${application.participantData?.concentration || getParticipantData(application.participantId)?.concentration || 'N/A'}</td>
                        <td>
    <div class="actions">
        <button class="btn btn-info btn-small" onclick="viewApplicationDetails('${application.id}')" title="Ver detalles">
            <i class="fas fa-eye"></i>
        </button>
        ${application.status === 'pending' ? `
            <button class="btn btn-success btn-small" onclick="processApplication('${application.id}')" title="Procesar">
                <i class="fas fa-check"></i>
            </button>
        ` : ''}
        ${application.status === 'approved_sent' ? `
    <button class="btn btn-warning btn-small" onclick="viewReferralDetails('${application.id}')" title="Ver seguimiento">
        <i class="fas fa-eye-slash"></i>
    </button>
` : ''}
${application.status === 'rejected' ? `
    <button class="btn btn-danger btn-small" onclick="viewRejectionDetails('${application.id}')" title="Ver raz칩n del rechazo">
        <i class="fas fa-times-circle"></i>
    </button>
` : ''}
        <button class="btn btn-danger btn-small" onclick="deleteApplication('${application.id}')" title="Eliminar">
            <i class="fas fa-trash"></i>
        </button>
    </div>
</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Obtener etiqueta de tipo
        function getTypeLabel(type) {
            const labels = {
                'part-time': 'Part-Time',
                'full-time': 'Full-Time',
                'regular': 'Regular',
                'temporary': 'Temporero'
            };
            return labels[type] || type;
        }

// Obtener etiqueta de servicio solicitado
function getServiceLabel(service) {
    if (!service) return 'No especificado';
    
    const labels = {
        'orientacion': 'Orientaci칩n de servicios y temas de Empleabilidad',
        'interesado': 'Interesado en listado de Ofertas de Empleo',
        'referido': 'Referido a puesto laboral',
        'colocado': 'Colocados en Empleo',
        'resume': 'Redacci칩n y Revisi칩n de Resum칠',
        'carta': 'Redacci칩n Carta de Presentaci칩n o Agradecimiento',
        'talleres': 'Talleres Profesionales',
        'eventos': 'Eventos de Empleabilidad',
        'manpower': 'Servicios Manpower',
        'divulgacion': 'Divulgaci칩n de ofertas de empleo'
    };
    
    return labels[service] || service;
}

// Obtener etiqueta de sector industrial
function getSectorLabel(sector) {
    const labels = {
        'administracion': 'Administraci칩n',
        'finanzas': 'Finanzas',
        'salud': 'Salud',
        'ciencias': 'Ciencias',
        'tecnologia': 'Tecnolog칤a',
        'ventas': 'Ventas',
        'mercadeo': 'Mercadeo',
        'servicios': 'Servicios al Cliente',
        'operaciones': 'Operaciones',
        'ingenieria': 'Ingenier칤a',
        'hospitalidad': 'Hospitalidad',
        'educacion': 'Educaci칩n',
        'todos': 'Todos los sectores'
    };
    return labels[sector] || 'No especificado';
}

// Ver detalles de oferta
        function viewOfferDetails(offerId) {
            const offer = offers.find(o => o.id === offerId);
            if (!offer) return;

            currentModalData = { type: 'offer', data: offer };

            const activities = offer.activities ? offer.activities.map(act => {
                const labels = {
                    'feria': 'Ferias de Empleo',
                    'mesas': 'Mesas de reclutamiento',
                    'talleres': 'Ofrecimiento de Talleres',
                    'no': 'No participan en actividades'
                };
                return labels[act] || act;
            }).join(', ') : 'No especificadas';

            document.getElementById('modalTitle').textContent = `Oferta: ${offer.position} - ${offer.companyName}`;
            document.getElementById('modalBody').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
                    <div>
                        <h4 style="color: #c8102e; margin-bottom: 15px;">Informaci칩n de la Empresa</h4>
                        <p><strong>Empresa:</strong> ${offer.companyName}</p>
                        <p><strong>Tipo:</strong> ${offer.patronType === 'new' ? 'Patrono Nuevo' : 'Patrono Existente'}</p>
                        <p><strong>Contacto:</strong> ${offer.contactPerson}</p>
                        <p><strong>Posici칩n del Contacto:</strong> ${offer.contactPosition || 'No especificada'}</p>
                        <p><strong>Tel칠fono:</strong> ${offer.phone}</p>
                        <p><strong>Email:</strong> ${offer.email}</p>
                        <p><strong>Recibida por:</strong> ${offer.receivedThrough}</p>
                    </div>
                    <div>
                        <h4 style="color: #c8102e; margin-bottom: 15px;">Detalles del Puesto</h4>
                        <p><strong>Posici칩n:</strong> ${offer.position}</p>
                        <p><strong>Tipo:</strong> ${getTypeLabel(offer.positionType)}</p>
<p><strong>Sector Industrial:</strong> ${getSectorLabel(offer.academicDivision)}</p>
<p><strong>Salario:</strong> ${offer.salary}</p>
                        <p><strong>Ubicaci칩n:</strong> ${offer.location}</p>
                        <p><strong>Fecha L칤mite:</strong> ${new Date(offer.deadline).toLocaleDateString()}</p>
                        <p><strong>Estado:</strong> <span class="status-badge ${getOfferStatus(offer.deadline) === 'expired' ? 'status-expired' : getOfferStatus(offer.deadline) === 'expiring' ? 'status-expiring' : 'status-active'}">${getOfferStatus(offer.deadline) === 'expired' ? 'Vencida' : getOfferStatus(offer.deadline) === 'expiring' ? 'Vence Pronto' : 'Activa'}</span></p>
                    </div>
                </div>
                
                ${offer.jobDescription ? `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #c8102e; margin-bottom: 10px;">Descripci칩n del Empleo</h4>
                    <p style="background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${offer.jobDescription}</p>
                </div>
                ` : ''}
                
                ${offer.schedule ? `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #c8102e; margin-bottom: 10px;">Horarios y D칤as de Trabajo</h4>
                    <p style="background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${offer.schedule}</p>
                </div>
                ` : ''}
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #c8102e; margin-bottom: 10px;">Requisitos de la Posici칩n</h4>
                    <p style="background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${offer.requirements}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #c8102e; margin-bottom: 10px;">Actividades de Reclutamiento</h4>
                    <p style="background: #f8f9fa; padding: 15px; border-radius: 6px;">${activities}</p>
                </div>
                
                ${offer.notes ? `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #c8102e; margin-bottom: 10px;">Notas Adicionales</h4>
                    <p style="background: #fff3cd; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${offer.notes}</p>
                </div>
                ` : ''}
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #6c757d;">
                    <p><strong>Creada:</strong> ${new Date(offer.createdAt || offer.today).toLocaleString()}</p>
                    ${offer.updatedAt && offer.updatedAt !== offer.createdAt ? `<p><strong>칔ltima actualizaci칩n:</strong> ${new Date(offer.updatedAt).toLocaleString()}</p>` : ''}
                </div>
            `;

            document.getElementById('detailsModal').style.display = 'flex';
        }

        // Ver detalles de participante
        function viewParticipantDetails(participantId) {
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return;

            currentModalData = { type: 'participant', data: participant };

            const campusLabels = {
                'cupey': 'Recinto de Cupey',
                'bayamon': 'Centro Universitario de Bayam칩n',
                'aguadilla': 'Centro Universitario de Aguadilla'
            };

            const studentTypeLabels = {
                'student': 'Estudiante',
                'alumni': 'Exalumno',
                'community': 'Comunidad'
            };

            const scheduleLabels = {
                'diurno': 'Diurno',
                'nocturno': 'Nocturno'
            };

            const degreeLabels = {
                '11mo': '11mo 칩 menos',
                'cuarto': 'Cuarto A침o',
                'certificado': 'Certificado',
                'asociado': 'Grado Asociado',
                'bachillerato': 'Bachillerato',
                'maestria': 'Maestr칤a',
                'doctorado': 'Doctorado'
            };

            const divisionLabels = {
                'negocios': 'Negocios, Turismo y Emprendimiento',
                'salud': 'Ciencias de la Salud',
                'liberales': 'Artes Liberales',
                'tecnologia': 'Ciencias y Tecnolog칤a',
                'tecnicos': 'Programas T칠cnicos'
            };

            document.getElementById('modalTitle').textContent = `Participante: ${participant.firstName} ${participant.lastName}`;
document.getElementById('modalBody').innerHTML = `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 25px;">
        <div>
            <h4 style="color: #c8102e; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0;">
                游녻 INFORMACI칍N PERSONAL
            </h4>
            <p style="margin: 8px 0;"><strong>Nombre:</strong> ${participant.firstName} ${participant.lastName}</p>
            <p style="margin: 8px 0;"><strong>Tipo:</strong> ${participant.participantType === 'new' ? 'Nuevo' : 'Participante de Seguimiento'}</p>
            <p style="margin: 8px 0;"><strong>Email:</strong> ${participant.email}</p>
            <p style="margin: 8px 0;"><strong>Tel칠fono:</strong> ${participant.phone}</p>
            <p style="margin: 8px 0;"><strong>Ciudad:</strong> ${participant.city}</p>
            <p style="margin: 8px 0;"><strong>Fecha de Registro:</strong> ${new Date(participant.registeredAt).toLocaleDateString()}</p>
        </div>
        
        <div>
            <h4 style="color: #c8102e; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0;">
                游늶 SERVICIO SOLICITADO
            </h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #c8102e;">
                <p style="margin: 0; font-weight: 600; color: #2d3748;">
                    ${getServiceLabel(participant.requestedServices)}
                </p>
            </div>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 25px;">
        <div>
            <h4 style="color: #c8102e; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0;">
                游꿉 INFORMACI칍N ACAD칄MICA
            </h4>
            <p style="margin: 8px 0;"><strong>Tipo de Estudiante:</strong> ${studentTypeLabels[participant.studentType]}</p>
            <p style="margin: 8px 0;"><strong>Recinto:</strong> ${campusLabels[participant.campus]}</p>
            <p style="margin: 8px 0;"><strong>ID Estudiante:</strong> ${participant.studentId}</p>
            <p style="margin: 8px 0;"><strong>Horario:</strong> ${scheduleLabels[participant.schedule]}</p>
            <p style="margin: 8px 0;"><strong>A침o de Estudios:</strong> ${participant.studyYear}</p>
            <p style="margin: 8px 0;"><strong>Concentraci칩n:</strong> ${participant.concentration}</p>
        </div>
        
        <div>
            <h4 style="color: #c8102e; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0;">
                游닄 INFORMACI칍N ADICIONAL
            </h4>
            <p style="margin: 8px 0;"><strong>Candidato a Graduaci칩n:</strong> ${participant.graduationCandidate === 'yes' ? 'S칤' : 'No'}</p>
            <p style="margin: 8px 0;"><strong>Grado Acad칠mico:</strong> ${degreeLabels[participant.academicDegree]}</p>
            <p style="margin: 8px 0;"><strong>Divisi칩n Acad칠mica:</strong> ${divisionLabels[participant.academicDivision]}</p>
        </div>
    </div>
    
    <div style="margin-bottom: 25px;">
        <h4 style="color: #c8102e; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0;">
            游늯 DOCUMENTOS
        </h4>
        <p style="margin: 8px 0;">
    <strong>Resum칠:</strong> 
    ${participant.resume && participant.resume.startsWith('http') 
        ? '<span style="color: #22c55e; font-weight: 600;">九 Resum칠 adjuntado</span>' 
        : '<span style="color: #94a3b8;">No disponible</span>'}
</p>
        <button class="btn btn-info btn-small" onclick="downloadResume('${participant.id}')">
            <i class="fas fa-download"></i> Descargar Resum칠
        </button>
    </div>
    
    <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
        <h4 style="color: #c8102e; margin-bottom: 15px;">
            游늵 ACTIVIDAD DEL PARTICIPANTE
        </h4>
        <div id="participantActivity">Cargando actividad...</div>
    </div>
`;


            // Cargar actividad del participante
            setTimeout(() => {
                const participantApplications = applications.filter(app => app.participantId === participant.id);
                let activityHtml = '';
                
                if (participantApplications.length > 0) {
                    activityHtml = '<ul>';
                    participantApplications.forEach(app => {
                        activityHtml += `
                            <li style="margin-bottom: 10px;">
                                <strong>${app.offerTitle}</strong> en <em>${app.companyName}</em>
                                <br><small>Aplicado el ${new Date(app.appliedAt).toLocaleDateString()} - Estado: ${app.status}</small>
                            </li>
                        `;
                    });
                    activityHtml += '</ul>';
                } else {
                    activityHtml = '<p style="color: #6c757d; font-style: italic;">No hay aplicaciones registradas</p>';
                }
                
                document.getElementById('participantActivity').innerHTML = activityHtml;
            }, 500);

// Mostrar bot칩n de PDF en el modal
const modalAction = document.getElementById('modalAction');
modalAction.style.display = 'inline-flex';
modalAction.innerHTML = '<i class="fas fa-file-pdf"></i> Descargar PDF del Expediente';
modalAction.onclick = () => generateParticipantPDF(participant.id);
modalAction.className = 'btn btn-success';

            document.getElementById('detailsModal').style.display = 'flex';
        }

        // Ver detalles de aplicaci칩n
        function viewApplicationDetails(applicationId) {
            const application = applications.find(app => app.id === applicationId);
            if (!application) return;

            currentModalData = { type: 'application', data: application };

            // Buscar informaci칩n completa del participante y oferta
            const participant = participants.find(p => p.id === application.participantId);
            const offer = offers.find(o => o.id === application.offerId);

            document.getElementById('modalTitle').textContent = `Solicitud: ${application.offerTitle}`;
            document.getElementById('modalBody').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
                    <div>
                        <h4 style="color: #c8102e; margin-bottom: 15px;">Informaci칩n del Participante</h4>
                        <p><strong>Nombre:</strong> ${application.participantName}</p>
                        <p><strong>Email:</strong> ${application.participantEmail}</p>
                        <p><strong>Tel칠fono:</strong> ${application.participantPhone}</p>
                        ${participant ? `
                            <p><strong>ID Estudiante:</strong> ${participant.studentId}</p>
                            <p><strong>Concentraci칩n:</strong> ${participant.concentration}</p>
                            <p><strong>Recinto:</strong> ${participant.campus}</p>
                        ` : ''}
                    </div>
                    <div>
                        <h4 style="color: #c8102e; margin-bottom: 15px;">Informaci칩n de la Oferta</h4>
                        <p><strong>Empresa:</strong> ${application.companyName}</p>
                        <p><strong>Posici칩n:</strong> ${application.offerTitle}</p>
                        ${offer ? `
                            <p><strong>Contacto Empresa:</strong> ${offer.contactPerson}</p>
                            <p><strong>Email Empresa:</strong> ${offer.email}</p>
                            <p><strong>Tel칠fono Empresa:</strong> ${offer.phone}</p>
                        ` : ''}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #c8102e; margin-bottom: 15px;">Detalles de la Solicitud</h4>
                    <p><strong>Fecha de Aplicaci칩n:</strong> ${new Date(application.appliedAt).toLocaleString()}</p>
                    <p><strong>Estado:</strong> <span class="status-badge ${
                        application.status === 'pending' ? 'status-pending' : 
                        application.status === 'processed' ? 'status-approved' : 
                        application.status === 'approved_sent' ? 'status-approved' : 
                        application.status === 'rejected' ? 'status-expired' : 'status-active'
                    }">${
                        application.status === 'pending' ? 'Pendiente' : 
                        application.status === 'processed' ? 'Procesada' : 
                        application.status === 'approved_sent' ? 'Referido Enviado' : 
                        application.status === 'rejected' ? 'Rechazada' : 'Referida'
                    }</span></p>
                </div>
                
                ${application.status === 'pending' ? `
                <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h5 style="color: #856404; margin-bottom: 10px;">Acciones Disponibles</h5>
                    <p style="color: #856404; margin-bottom: 15px;">Esta solicitud est치 pendiente de procesamiento.</p>
                    <button class="btn btn-success" onclick="processApplication('${application.id}')">
                        <i class="fas fa-check"></i> Marcar como Procesada
                    </button>
                </div>
                ` : ''}
            `;

            // Mostrar bot칩n de acci칩n en el modal si es necesario
            const modalAction = document.getElementById('modalAction');
            if (application.status === 'pending') {
                modalAction.style.display = 'inline-flex';
                modalAction.innerHTML = '<i class="fas fa-paper-plane"></i> Procesar Solicitud';
                modalAction.onclick = () => processApplication(application.id);
            } else {
                modalAction.style.display = 'none';
            }

            document.getElementById('detailsModal').style.display = 'flex';
        }

        // Procesar aplicaci칩n
        async function processApplication(applicationId) {
    if (confirm('쮼st치s seguro de que quieres marcar esta solicitud como procesada?')) {
        try {
            const updatedData = {
                status: 'processed',
                processedAt: new Date().toISOString()
            };
            
            // Actualizar en Firebase
            if (isFirebaseInitialized) {
                const snapshot = await db.collection('applications')
                    .where('id', '==', applicationId)
                    .get();
                
                if (!snapshot.empty) {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.update(doc.ref, updatedData);
                    });
                    await batch.commit();
                    console.log('Aplicaci칩n procesada en Firebase:', applicationId);
                }
            }
            
            // Actualizar en memoria local
            const application = applications.find(app => app.id === applicationId);
            if (application) {
                application.status = 'processed';
                application.processedAt = new Date().toISOString();
            }
            
            // Actualizar localStorage como respaldo
            localStorage.setItem('applications', JSON.stringify(applications));
            
            // Actualizar estad칤sticas y tabla
            updateStats();
            loadApplicationsTable();
            closeDetailsModal();
            
            showNotification('Solicitud procesada exitosamente', 'success');
            
            // Registrar en historial
            await addToParticipantHistory(application.participantId, {
                eventType: 'application',
                eventTitle: 'Aplic칩 a Oferta',
                description: `Aplic칩 a "${application.offerTitle}" en ${application.companyName}`,
                data: {
                    participantName: application.participantName,
                    companyName: application.companyName,
                    offerTitle: application.offerTitle,
                    applicationId: application.id
                }
            });
            
        } catch (error) {
           
            console.error('Error procesando aplicaci칩n:', error);
            showNotification('Error procesando la solicitud. Intenta de nuevo.', 'error');
        }
    }
}

// Eliminar aplicaci칩n completamente
async function deleteApplication(applicationId) {
    const application = applications.find(app => app.id === applicationId);
    if (!application) return;
    
    if (confirm(`쮼st치s seguro de que quieres eliminar la solicitud de "${application.participantName}" para "${application.offerTitle}"?`)) {
        try {
            // Eliminar de Firebase
            if (isFirebaseInitialized) {
                const snapshot = await db.collection('applications')
                    .where('id', '==', applicationId)
                    .get();
                
                if (!snapshot.empty) {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    console.log('Aplicaci칩n eliminada de Firebase:', applicationId);
                }
            }
            
            // Eliminar de memoria local
            applications = applications.filter(app => app.id !== applicationId);
            
            // Actualizar localStorage como respaldo
            localStorage.setItem('applications', JSON.stringify(applications));
            
            // Actualizar interfaz
            updateStats();
            filterApplications();
            closeDetailsModal();
            showNotification('Solicitud eliminada exitosamente', 'success');

// Ajustar contador de aplicaciones
lastCheckedApplications = Math.max(0, applications.length);
localStorage.setItem('lastCheckedApplications', lastCheckedApplications.toString());
            
        } catch (error) {
            console.error('Error eliminando aplicaci칩n:', error);
            showNotification('Error eliminando la solicitud. Intenta de nuevo.', 'error');
        }
    }
}

        // Descargar resum칠 real desde Firebase Storage
        function downloadResume(participantId) {
            const participant = participants.find(p => p.id === participantId);
            if (participant && participant.resume) {
                if (participant.resume.startsWith('http')) {
                    // Es una URL de Storage, descargar archivo real
                    const link = document.createElement('a');
                    link.href = participant.resume;
                    link.download = participant.resumeFileName || `resume_${participant.firstName}_${participant.lastName}.pdf`;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showNotification(`Descargando resum칠 de ${participant.firstName} ${participant.lastName}`, 'success');
                } else {
                    // Es solo el nombre del archivo (datos viejos)
                    showNotification('Resum칠 no disponible para descarga', 'warning');
                }
            } else {
                showNotification('No hay resum칠 disponible', 'warning');
            }
        }

        // Cerrar modal de detalles
        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
            document.getElementById('modalAction').style.display = 'none';
            currentModalData = null;
        }

// Eliminar participante
        async function deleteParticipant(participantId) {
    const participant = participants.find(p => p.id === participantId);
    if (!participant) return;
    
    if (confirm(`쮼st치s seguro de que quieres eliminar al participante "${participant.firstName} ${participant.lastName}"?`)) {
        try {
            // Eliminar de Firebase
            if (isFirebaseInitialized) {
                const snapshot = await db.collection('participants')
                    .where('id', '==', participantId)
                    .get();
                
                if (!snapshot.empty) {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    console.log('Participante eliminado de Firebase:', participantId);
                }
            }
            
            // Eliminar de memoria local
            participants = participants.filter(p => p.id !== participantId);
            
                        
            // Actualizar localStorage como respaldo
            localStorage.setItem('participants', JSON.stringify(participants));
            localStorage.setItem('applications', JSON.stringify(applications));
            
            // Actualizar interfaz
            updateStats();
            filterParticipants();
            showNotification('Participante eliminado exitosamente', 'success');

// Ajustar contador de participantes  
lastCheckedParticipants = Math.max(0, participants.length);
localStorage.setItem('lastCheckedParticipants', lastCheckedParticipants.toString());
            
        } catch (error) {
            console.error('Error eliminando participante:', error);
            showNotification('Error eliminando el participante. Intenta de nuevo.', 'error');
        }
    }
}
        // Editar oferta (redirigir al gestor de ofertas)
        function editOffer(offerId) {
    const offer = offers.find(o => o.id === offerId);
    if (!offer) return;

    currentModalData = { type: 'editOffer', data: offer };
    
    document.getElementById('modalTitle').textContent = 'Editar Oferta de Empleo';
    document.getElementById('modalBody').innerHTML = `
        <form id="editOfferForm">
            <div class="form-row">
                <div class="form-group">
                    <label>Empresa:</label>
                    <input type="text" id="edit-companyName" value="${offer.companyName}" required>
                </div>
                <div class="form-group">
                    <label>Posici칩n:</label>
                    <input type="text" id="edit-position" value="${offer.position}" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Ubicaci칩n:</label>
                    <input type="text" id="edit-location" value="${offer.location}" required>
                </div>
                <div class="form-group">
                    <label>Salario:</label>
                    <input type="text" id="edit-salary" value="${offer.salary}" required>
                </div>
            </div>
            
<div class="form-group">
    <label>Sector Industrial:</label>
    <select id="edit-academicDivision" required>
        <option value="">Seleccionar...</option>
        <option value="administracion" ${offer.academicDivision === 'administracion' ? 'selected' : ''}>Administraci칩n</option>
        <option value="finanzas" ${offer.academicDivision === 'finanzas' ? 'selected' : ''}>Finanzas</option>
        <option value="salud" ${offer.academicDivision === 'salud' ? 'selected' : ''}>Salud</option>
        <option value="ciencias" ${offer.academicDivision === 'ciencias' ? 'selected' : ''}>Ciencias</option>
        <option value="tecnologia" ${offer.academicDivision === 'tecnologia' ? 'selected' : ''}>Tecnolog칤a y Sistemas</option>
        <option value="ventas" ${offer.academicDivision === 'ventas' ? 'selected' : ''}>Ventas</option>
        <option value="mercadeo" ${offer.academicDivision === 'mercadeo' ? 'selected' : ''}>Mercadeo</option>
        <option value="servicios" ${offer.academicDivision === 'servicios' ? 'selected' : ''}>Servicios al Cliente</option>
        <option value="operaciones" ${offer.academicDivision === 'operaciones' ? 'selected' : ''}>Operaciones y Log칤stica</option>
        <option value="ingenieria" ${offer.academicDivision === 'ingenieria' ? 'selected' : ''}>Ingenier칤a y Manufactura</option>
        <option value="hospitalidad" ${offer.academicDivision === 'hospitalidad' ? 'selected' : ''}>Hospitalidad y Turismo</option>
        <option value="educacion" ${offer.academicDivision === 'educacion' ? 'selected' : ''}>Educaci칩n</option>
        <option value="todos" ${offer.academicDivision === 'todos' ? 'selected' : ''}>Todos los sectores</option>
               </select>
           </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Tipo de Posici칩n:</label>
                    <select id="edit-positionType" required>
                        <option value="part-time" ${offer.positionType === 'part-time' ? 'selected' : ''}>Part-Time</option>
                        <option value="full-time" ${offer.positionType === 'full-time' ? 'selected' : ''}>Full-Time</option>
                        <option value="regular" ${offer.positionType === 'regular' ? 'selected' : ''}>Regular</option>
                        <option value="temporary" ${offer.positionType === 'temporary' ? 'selected' : ''}>Temporero</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha L칤mite:</label>
                    <input type="date" id="edit-deadline" value="${offer.deadline}" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>Descripci칩n del Trabajo:</label>
                <textarea id="edit-jobDescription" rows="3">${offer.jobDescription || ''}</textarea>
            </div>
            
            <div class="form-group">
                <label>Requisitos:</label>
                <textarea id="edit-requirements" rows="3" required>${offer.requirements}</textarea>
            </div>
            
            <div class="form-group">
                <label>Horarios:</label>
                <textarea id="edit-schedule" rows="2">${offer.schedule || ''}</textarea>
            </div>
            
            <div class="form-group">
                <label>Notas Adicionales:</label>
                <textarea id="edit-notes" rows="2">${offer.notes || ''}</textarea>
            </div>
        </form>
    `;

    // Mostrar bot칩n de acci칩n
    const modalAction = document.getElementById('modalAction');
    modalAction.style.display = 'inline-flex';
    modalAction.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
    modalAction.onclick = () => saveOfferChanges(offerId);

    document.getElementById('detailsModal').style.display = 'flex';
}

async function saveOfferChanges(offerId) {
    const form = document.getElementById('editOfferForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Recopilar datos actualizados
    const updatedOffer = {
        companyName: document.getElementById('edit-companyName').value,
        position: document.getElementById('edit-position').value,
        location: document.getElementById('edit-location').value,
        salary: document.getElementById('edit-salary').value,
academicDivision: document.getElementById('edit-academicDivision').value,
        positionType: document.getElementById('edit-positionType').value,
        deadline: document.getElementById('edit-deadline').value,
        jobDescription: document.getElementById('edit-jobDescription').value,
        requirements: document.getElementById('edit-requirements').value,
        schedule: document.getElementById('edit-schedule').value,
        notes: document.getElementById('edit-notes').value,
        updatedAt: new Date().toISOString()
    };
    
    try {
        // Actualizar en Firebase
        if (isFirebaseInitialized) {
            const snapshot = await db.collection('jobOffers')
                .where('id', '==', offerId)
                .get();
            
            if (!snapshot.empty) {
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.update(doc.ref, updatedOffer);
                });
                await batch.commit();
                console.log('Oferta actualizada en Firebase:', offerId);
            }
        }
        
        // Actualizar en memoria local
        const offerIndex = offers.findIndex(o => o.id === offerId);
        if (offerIndex !== -1) {
            offers[offerIndex] = { ...offers[offerIndex], ...updatedOffer };
        }
        
        // Actualizar localStorage como respaldo
        localStorage.setItem('jobOffers', JSON.stringify(offers));
        
        // Actualizar interfaz
        updateStats();
        loadOffersTable();
        closeDetailsModal();
        showNotification('Oferta actualizada exitosamente', 'success');
        
    } catch (error) {
        console.error('Error actualizando oferta:', error);
        showNotification('Error actualizando la oferta. Intenta de nuevo.', 'error');
    }
}

// ===== SISTEMA DE PROMOCI칍N DE OFERTAS =====
function generatePromoURL(offerId) {
    const offer = offers.find(o => o.id === offerId);
    if (!offer) return;
    
    const baseURL = window.location.origin + window.location.pathname.replace('dashboard.html', 'portal-para-participantes.html');
    const promoURL = `${baseURL}?promo=${offerId}`;
    
    showPromoURLModal(offer, promoURL);
}

function showPromoURLModal(offer, promoURL) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.id = 'promoURLModal';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>游꿢 URL Promocional Generada</h3>
                <span class="close" onclick="closePromoModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #1565c0; margin-bottom: 10px;">游늶 Informaci칩n de la Oferta</h4>
                    <p><strong>Empresa:</strong> ${offer.companyName}</p>
                    <p><strong>Posici칩n:</strong> ${offer.position}</p>
                    <p><strong>Ubicaci칩n:</strong> ${offer.location}</p>
                    <p><strong>Salario:</strong> ${offer.salary}</p>
                </div>
                
                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #7b1fa2; margin-bottom: 10px;">游댕 URL Promocional</h4>
                    <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #ddd; word-break: break-all; font-family: monospace; font-size: 12px;">
                        ${promoURL}
                    </div>
                    <button class="btn btn-info" onclick="copyToClipboard('${promoURL}')" style="margin-top: 10px;">
                        游늶 Copiar URL
                    </button>
                </div>
                
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #2e7d32; margin-bottom: 10px;">游닎 Template de Email</h4>
                    <textarea id="emailTemplate" style="width: 100%; height: 200px; font-size: 12px; font-family: Arial;" readonly>Asunto: 游 Oportunidad de Empleo - ${offer.position} en ${offer.companyName}

Estimado/a candidato/a,

춰Tenemos una excelente oportunidad laboral que puede interesarte!

游끽 EMPRESA: ${offer.companyName}
游눺 POSICI칍N: ${offer.position}
游늸 UBICACI칍N: ${offer.location}
游눯 SALARIO: ${offer.salary}

游늶 Para aplicar y ver todos los detalles:
游녤 ${promoURL}

Esta oferta fue seleccionada especialmente y est치 disponible por tiempo limitado.

춰No pierdas esta oportunidad!

Saludos,
Oficina de Carreras y Colocaciones
Universidad Ana G. M칠ndez</textarea>
                    <button class="btn btn-success" onclick="copyEmailTemplate()" style="margin-top: 10px;">
                        游닎 Copiar Template
                    </button>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePromoModal()">Cerrar</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('URL copiada al portapapeles!', 'success');
    });
}

function copyEmailTemplate() {
    const template = document.getElementById('emailTemplate').value;
    navigator.clipboard.writeText(template).then(() => {
        showNotification('Template de email copiado!', 'success');
    });
}

function closePromoModal() {
    const modal = document.getElementById('promoURLModal');
    if (modal) modal.remove();
}
        // Eliminar oferta
        async function deleteOffer(offerId) {
    const offer = offers.find(o => o.id === offerId);
    if (!offer) return;
    
    if (confirm(`쮼st치s seguro de que quieres eliminar la oferta "${offer.position}" de "${offer.companyName}"?`)) {
 // Asegurar que est치 en el hist칩rico antes de eliminar
    const existingInHistory = allOffersHistory.find(h => h.id === offerId);
    if (!existingInHistory) {
        allOffersHistory.push({
            ...offer,
            deletedAt: new Date().toISOString(),
            deletedBy: 'admin'
        });
    } else if (!existingInHistory.deletedAt) {
        existingInHistory.deletedAt = new Date().toISOString();
        existingInHistory.deletedBy = 'admin';
    }
        try {
            // Eliminar de Firebase
            if (isFirebaseInitialized) {
                const snapshot = await db.collection('jobOffers')
                    .where('id', '==', offerId)
                    .get();
                
                if (!snapshot.empty) {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    console.log('Oferta eliminada de Firebase:', offerId);
                }
            }
            
            // Eliminar de memoria local
            offers = offers.filter(o => o.id !== offerId);
            
           
            // Actualizar localStorage como respaldo
            localStorage.setItem('jobOffers', JSON.stringify(offers));
            localStorage.setItem('applications', JSON.stringify(applications));
            
            // Actualizar interfaz
            updateStats();
            filterOffers();
            showNotification('Oferta eliminada exitosamente', 'success');

// Ajustar contador de ofertas
lastCheckedOffers = Math.max(0, offers.length);
localStorage.setItem('lastCheckedOffers', lastCheckedOffers.toString());
            
        } catch (error) {
            console.error('Error eliminando oferta:', error);
            showNotification('Error eliminando la oferta. Intenta de nuevo.', 'error');
        }
    }
}
// Filtrar ofertas
function filterOffers() {
    // Guardar valores actuales de los filtros
    currentFilters.offers.search = document.getElementById('offersSearch').value.toLowerCase();
    currentFilters.offers.status = document.getElementById('offersStatusFilter').value;
    currentFilters.offers.sort = document.getElementById('offersSortFilter').value;
    
    let filteredOffers = offers;
    
    // Filtro de b칰squeda
    if (currentFilters.offers.search) {
        filteredOffers = filteredOffers.filter(offer => 
            offer.companyName.toLowerCase().includes(currentFilters.offers.search) ||
            offer.position.toLowerCase().includes(currentFilters.offers.search) ||
            offer.location.toLowerCase().includes(currentFilters.offers.search) ||
            offer.contactPerson.toLowerCase().includes(currentFilters.offers.search)
        );
    }
    
    // Filtro de estado
    if (currentFilters.offers.status) {
        filteredOffers = filteredOffers.filter(offer => {
            const status = getOfferStatus(offer.deadline);
            return status === currentFilters.offers.status;
        });
    }
    
    // Ordenamiento
    if (currentFilters.offers.sort) {
        filteredOffers.sort((a, b) => {
            switch(currentFilters.offers.sort) {
                case 'newest':
                    return new Date(b.today || b.createdAt || '1900-01-01') - new Date(a.today || a.createdAt || '1900-01-01');
                case 'oldest':
                    return new Date(a.today || a.createdAt || '1900-01-01') - new Date(b.today || b.createdAt || '1900-01-01');
                case 'deadline-asc':
                    return new Date(a.deadline) - new Date(b.deadline);
                case 'deadline-desc':
                    return new Date(b.deadline) - new Date(a.deadline);
                default:
                    return 0;
            }
        });
    }
    
    displayFilteredOffers(filteredOffers);
}

        // Mostrar ofertas filtradas
        function displayFilteredOffers(filteredOffers) {
            const container = document.getElementById('offersTableContainer');
            
            if (filteredOffers.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-search"></i>
                        <h3>No se encontraron ofertas</h3>
                        <p>No hay ofertas que coincidan con los filtros aplicados</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Empresa</th>
                            <th>Posici칩n</th>
                            <th>Ubicaci칩n</th>
                            <th>Salario</th>
                            <th>Tipo</th>
                            <th>Fecha L칤mite</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredOffers.forEach(offer => {
                const status = getOfferStatus(offer.deadline);
                const statusClass = status === 'expired' ? 'status-expired' : 
                                  status === 'expiring' ? 'status-expiring' : 'status-active';
                const statusText = status === 'expired' ? 'Vencida' : 
                                 status === 'expiring' ? 'Vence Pronto' : 'Activa';

                html += `
                    <tr>
                        <td>${offer.today ? new Date(offer.today + 'T00:00:00').toLocaleDateString() : 'Sin fecha'}</td>
                        <td><strong>${offer.companyName}</strong><br><small>${offer.contactPerson}</small></td>
                        <td>${offer.position}</td>
                        <td>${offer.location}</td>
                        <td>${offer.salary}</td>
                        <td><span class="status-badge">${getTypeLabel(offer.positionType)}</span></td>
                        <td>${offer.deadline ? new Date(offer.deadline + 'T00:00:00').toLocaleDateString() : 'Sin fecha l칤mite'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
<td>
    <div class="actions">
        <button class="btn btn-info btn-small" onclick="viewOfferDetails('${offer.id}')" title="Ver detalles">
            <i class="fas fa-eye"></i>
        </button>
        <button class="btn btn-success btn-small" onclick="generateOfferPDF('${offer.id}')" title="Generar PDF">
            <i class="fas fa-file-pdf"></i>
        </button>
        <button class="btn btn-warning btn-small" onclick="editOffer('${offer.id}')" title="Editar">
            <i class="fas fa-edit"></i>
        </button>
	<button class="btn btn-warning btn-small" onclick="generatePromoURL('${offer.id}')" title="Generar URL promocional">
    	    <i class="fas fa-bullhorn"></i>
	</button>
        <button class="btn btn-danger btn-small" onclick="deleteOffer('${offer.id}')" title="Eliminar">
            <i class="fas fa-trash"></i>
        </button>
    </div>
</td>                   

 </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Filtrar participantes
function filterParticipants() {
    // Guardar valores actuales de los filtros
    currentFilters.participants.search = document.getElementById('participantsSearch').value.toLowerCase();
    currentFilters.participants.campus = document.getElementById('participantsCampusFilter').value;
    currentFilters.participants.type = document.getElementById('participantsTypeFilter').value;
    
    let filteredParticipants = participants;
    
    // Filtro de b칰squeda
    if (currentFilters.participants.search) {
        filteredParticipants = filteredParticipants.filter(participant => 
            `${participant.firstName} ${participant.lastName}`.toLowerCase().includes(currentFilters.participants.search) ||
            participant.email.toLowerCase().includes(currentFilters.participants.search) ||
            participant.studentId.toLowerCase().includes(currentFilters.participants.search) ||
            participant.concentration.toLowerCase().includes(currentFilters.participants.search)
        );
    }
    
    // Filtro de campus
    if (currentFilters.participants.campus) {
        filteredParticipants = filteredParticipants.filter(participant => 
            participant.campus === currentFilters.participants.campus
        );
    }
    
    // Filtro de tipo
    if (currentFilters.participants.type) {
        filteredParticipants = filteredParticipants.filter(participant => 
            participant.participantType === currentFilters.participants.type
        );
    }
    
    displayFilteredParticipants(filteredParticipants);
}

        // Mostrar participantes filtrados
        function displayFilteredParticipants(filteredParticipants) {
            const container = document.getElementById('participantsTableContainer');
            
            if (filteredParticipants.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-search"></i>
                        <h3>No se encontraron participantes</h3>
                        <p>No hay participantes que coincidan con los filtros aplicados</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha Registro</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Tel칠fono</th>
                            <th>Recinto</th>
                            <th>Concentraci칩n</th>
                            <th>A침o</th>
                            <th>Tipo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredParticipants.forEach(participant => {
                const campusLabels = {
                    'cupey': 'Cupey',
                    'bayamon': 'Bayam칩n',
                    'aguadilla': 'Aguadilla'
                };

                const typeLabels = {
                    'new': 'Nuevo',
                    'returning': 'Seguimiento'
                };

                html += `
                    <tr>
                        <td>${new Date(participant.registeredAt).toLocaleDateString()}</td>
                        <td><strong>${participant.firstName} ${participant.lastName}</strong><br><small>ID: ${participant.studentId}</small></td>
                        <td>${participant.email}</td>
                        <td>${participant.phone}</td>
                        <td>${campusLabels[participant.campus] || participant.campus}</td>
                        <td>${participant.concentration}</td>
                        <td>${participant.studyYear}</td>
                        <td><span class="status-badge status-active">${typeLabels[participant.participantType]}</span></td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-info btn-small" onclick="viewParticipantDetails('${participant.id}')" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-warning btn-small" onclick="viewParticipantHistory('${participant.id}')" title="Ver historial">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button class="btn btn-success btn-small" onclick="downloadResume('${participant.id}')" title="Descargar resum칠">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteParticipant('${participant.id}')" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Filtrar aplicaciones
function filterApplications() {
    // Guardar valores actuales de los filtros
    currentFilters.applications.search = document.getElementById('applicationsSearch').value.toLowerCase();
    currentFilters.applications.status = document.getElementById('applicationsStatusFilter').value;
    
    let filteredApplications = applications;
    
    // Filtro de b칰squeda
    if (currentFilters.applications.search) {
        filteredApplications = filteredApplications.filter(application => 
            application.participantName.toLowerCase().includes(currentFilters.applications.search) ||
            application.companyName.toLowerCase().includes(currentFilters.applications.search) ||
            application.offerTitle.toLowerCase().includes(currentFilters.applications.search) ||
            application.participantEmail.toLowerCase().includes(currentFilters.applications.search)
        );
    }
    
    // Filtro de estado
    if (currentFilters.applications.status) {
        filteredApplications = filteredApplications.filter(application => 
            application.status === currentFilters.applications.status
        );
    }
    
    displayFilteredApplications(filteredApplications);
}

        // Mostrar aplicaciones filtradas
        function displayFilteredApplications(filteredApplications) {
            const container = document.getElementById('applicationsTableContainer');
            
            if (filteredApplications.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-search"></i>
                        <h3>No se encontraron solicitudes</h3>
                        <p>No hay solicitudes que coincidan con los filtros aplicados</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Participante</th>
                            <th>Empresa</th>
                            <th>Posici칩n</th>
                            <th>Contacto</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredApplications.forEach(application => {
                const statusLabels = {
    'pending': 'Pendiente',
    'processed': 'Procesada',
    'referred': 'Referida',
    'approved_sent': 'Referido Enviado',
    'rejected': 'Rechazada'
};

                const statusClasses = {
    'pending': 'status-pending',
    'processed': 'status-approved',
    'referred': 'status-active',
    'approved_sent': 'status-approved',
    'rejected': 'status-expired'
};

                html += `
                    <tr>
                        <td>${new Date(application.appliedAt).toLocaleDateString()}</td>
                        <td><strong>${application.participantName}</strong><br><small>${application.participantEmail}</small></td>
                        <td>${application.companyName}</td>
                        <td>${application.offerTitle}</td>
                        <td>${application.participantPhone}</td>
                        <td><span class="status-badge ${statusClasses[application.status]}">${statusLabels[application.status]}</span></td>
                        <td>
                           <div class="actions">
    <button class="btn btn-info btn-small" onclick="viewApplicationDetails('${application.id}')" title="Ver detalles">
        <i class="fas fa-eye"></i>
    </button>
    ${application.status === 'pending' ? `
        <button class="btn btn-success btn-small" onclick="processApplication('${application.id}')" title="Procesar">
            <i class="fas fa-check"></i>
        </button>
    ` : ''}
    ${application.status === 'approved_sent' ? `
        <button class="btn btn-warning btn-small" onclick="viewReferralDetails('${application.id}')" title="Ver seguimiento">
            <i class="fas fa-eye-slash"></i>
        </button>
    ` : ''}
    ${application.status === 'rejected' ? `
        <button class="btn btn-danger btn-small" onclick="viewRejectionDetails('${application.id}')" title="Ver raz칩n del rechazo">
            <i class="fas fa-times-circle"></i>
        </button>
    ` : ''}
    <button class="btn btn-danger btn-small" onclick="deleteApplication('${application.id}')" title="Eliminar">
        <i class="fas fa-trash"></i>
    </button>
</div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Exportar datos de ofertas
       function exportOffersData() {
    // Usar hist칩rico completo en lugar de solo ofertas activas
    const dataToExport = allOffersHistory.length > 0 ? allOffersHistory : offers;
    
    if (dataToExport.length === 0) {
        showNotification('No hay ofertas para exportar', 'warning');
        return;
    }

    const data = dataToExport.map(offer => ({
                'Fecha': new Date(offer.today).toLocaleDateString(),
                'Tipo Patrono': offer.patronType === 'new' ? 'Nuevo' : 'Existente',
                'Empresa': offer.companyName,
                'Contacto': offer.contactPerson,
                'Posici칩n Contacto': offer.contactPosition || '',
                'Tel칠fono': offer.phone,
                'Email': offer.email,
                'Recibida Por': offer.receivedThrough,
                'Posici칩n': offer.position,
                'Tipo Posici칩n': getTypeLabel(offer.positionType),
'Sector Industrial': getSectorLabel(offer.academicDivision),
                'Salario': offer.salary,
                'Ubicaci칩n': offer.location,
                'Fecha L칤mite': new Date(offer.deadline).toLocaleDateString(),
               'Estado': offer.deletedAt ? 'ELIMINADA' : 
         offer.expiredAt ? 'VENCIDA' : 
         getOfferStatus(offer.deadline) === 'expired' ? 'Vencida' : 
         getOfferStatus(offer.deadline) === 'expiring' ? 'Vence Pronto' : 'Activa',
'Fecha Eliminaci칩n': offer.deletedAt ? new Date(offer.deletedAt).toLocaleDateString() : '',
'Fecha Vencimiento Real': offer.expiredAt ? new Date(offer.expiredAt).toLocaleDateString() : '',
                'Descripci칩n': offer.jobDescription || '',
                'Horarios': offer.schedule || '',
                'Requisitos': offer.requirements,
                'Actividades': offer.activities ? offer.activities.join(', ') : '',
                'Notas': offer.notes || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ofertas de Empleo");
            
            const filename = `Ofertas_Empleo_Admin_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showNotification('Ofertas exportadas exitosamente', 'success');
        }

        // Exportar datos de participantes
        function exportParticipantsData() {
            if (participants.length === 0) {
                showNotification('No hay participantes para exportar', 'warning');
                return;
            }

            const data = participants.map(participant => ({
                'Fecha Registro': new Date(participant.registeredAt).toLocaleDateString(),
                'Tipo Participante': participant.participantType === 'new' ? 'Nuevo' : 'Seguimiento',
                'Nombre': participant.firstName,
                'Apellidos': participant.lastName,
                'Email': participant.email,
                'Tel칠fono': participant.phone,
                'Ciudad': participant.city,
                'Tipo Estudiante': participant.studentType,
                'Recinto': participant.campus,
                'ID Estudiante': participant.studentId,
                'Horario': participant.schedule,
                'A침o Estudios': participant.studyYear,
                'Concentraci칩n': participant.concentration,
                'Candidato Graduaci칩n': participant.graduationCandidate === 'yes' ? 'S칤' : 'No',
                'Grado Acad칠mico': participant.academicDegree,
                'Divisi칩n Acad칠mica': participant.academicDivision,
                'Resum칠': participant.resume
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Participantes");
            
            const filename = `Participantes_Admin_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showNotification('Participantes exportados exitosamente', 'success');
        }

        // Exportar datos de aplicaciones
        function exportApplicationsData() {
            if (applications.length === 0) {
                showNotification('No hay solicitudes para exportar', 'warning');
                return;
            }

            const data = applications.map(application => {
    const participant = getParticipantData(application.participantId);
    return {
        'Fecha Solicitud': new Date(application.appliedAt).toLocaleDateString(),
        'Participante': application.participantName,
        'Email Participante': application.participantEmail,
        'Tel칠fono Participante': application.participantPhone,
        'Empresa': application.companyName,
        'Posici칩n': application.offerTitle,
        'Tipo Estudiante': getStudentTypeLabel(participant?.studentType),
        'Concentraci칩n': participant?.concentration || 'N/A',
        'Estado': statusLabels[application.status] || application.status,
        'Fecha Procesado': application.processedAt ? new Date(application.processedAt).toLocaleDateString() : ''
    };
});

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Solicitudes");
            
            const filename = `Solicitudes_Admin_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showNotification('Solicitudes exportadas exitosamente', 'success');
        }

        // Exportar todos los datos
        function exportAllData() {
            const wb = XLSX.utils.book_new();

            // Ofertas
            if (offers.length > 0) {
                const offersData = offers.map(offer => ({
                    'Fecha': new Date(offer.today).toLocaleDateString(),
                    'Empresa': offer.companyName,
                    'Posici칩n': offer.position,
                    'Contacto': offer.contactPerson,
                    'Email': offer.email,
                    'Tel칠fono': offer.phone,
'Sector Industrial': getSectorLabel(offer.academicDivision),
                    'Ubicaci칩n': offer.location,
                    'Salario': offer.salary,
                    'Estado': getOfferStatus(offer.deadline) === 'expired' ? 'Vencida' : 
                             getOfferStatus(offer.deadline) === 'expiring' ? 'Vence Pronto' : 'Activa'
                }));
                const offersSheet = XLSX.utils.json_to_sheet(offersData);
                XLSX.utils.book_append_sheet(wb, offersSheet, "Ofertas");
            }

            // Participantes
            if (participants.length > 0) {
                const participantsData = participants.map(participant => ({
                    'Fecha Registro': new Date(participant.registeredAt).toLocaleDateString(),
                    'Nombre': `${participant.firstName} ${participant.lastName}`,
                    'Email': participant.email,
                    'Tel칠fono': participant.phone,
                    'Recinto': participant.campus,
                    'Concentraci칩n': participant.concentration,
                    'A침o': participant.studyYear
                }));
                const participantsSheet = XLSX.utils.json_to_sheet(participantsData);
                XLSX.utils.book_append_sheet(wb, participantsSheet, "Participantes");
            }

            // Solicitudes
            if (applications.length > 0) {
                const applicationsData = applications.map(application => ({
                    'Fecha': new Date(application.appliedAt).toLocaleDateString(),
                    'Participante': application.participantName,
                    'Empresa': application.companyName,
                    'Posici칩n': application.offerTitle,
                    'Estado': application.status
                }));
                const applicationsSheet = XLSX.utils.json_to_sheet(applicationsData);
                XLSX.utils.book_append_sheet(wb, applicationsSheet, "Solicitudes");
            }

            const filename = `Reporte_Completo_UAGM_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showNotification('Reporte completo exportado exitosamente', 'success');
        }

        // Generar reporte mensual
        function generateMonthlyReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const today = new Date();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            doc.setFontSize(18);
            doc.text('Reporte Mensual - Portal de Empleos UAGM', 20, 20);
            doc.setFontSize(14);
            doc.text(`${monthNames[today.getMonth()]} ${today.getFullYear()}`, 20, 35);
            
            let yPos = 55;
            
            // Estad칤sticas principales
            doc.setFontSize(16);
            doc.text('Resumen Ejecutivo', 20, yPos);
            yPos += 15;
            
            doc.setFontSize(12);
            doc.text(` Total de Ofertas: ${offers.length}`, 25, yPos);
            yPos += 8;
            doc.text(` Total de Participantes: ${participants.length}`, 25, yPos);
            yPos += 8;
            doc.text(` Total de Solicitudes: ${applications.length}`, 25, yPos);
            yPos += 8;
            doc.text(` Empresas Activas: ${[...new Set(offers.map(o => o.companyName))].length}`, 25, yPos);
            yPos += 20;
            
            // Ofertas por estado
            const activeOffers = offers.filter(offer => getOfferStatus(offer.deadline) === 'active').length;
            const expiredOffers = offers.filter(offer => getOfferStatus(offer.deadline) === 'expired').length;
            
            doc.setFontSize(16);
            doc.text('Estado de Ofertas', 20, yPos);
            yPos += 15;
            
            doc.setFontSize(12);
            doc.text(` Ofertas Activas: ${activeOffers}`, 25, yPos);
            yPos += 8;
            doc.text(` Ofertas Vencidas: ${expiredOffers}`, 25, yPos);
            yPos += 20;
            
            // Participantes por tipo
            const newParticipants = participants.filter(p => p.participantType === 'new').length;
            const returningParticipants = participants.filter(p => p.participantType === 'returning').length;
            
            doc.setFontSize(16);
            doc.text('Participantes por Tipo', 20, yPos);
            yPos += 15;
            
            doc.setFontSize(12);
            doc.text(` Participantes Nuevos: ${newParticipants}`, 25, yPos);
            yPos += 8;
            doc.text(` Participantes de Seguimiento: ${returningParticipants}`, 25, yPos);
            
            const filename = `Reporte_Mensual_${today.getFullYear()}_${String(today.getMonth() + 1).padStart(2, '0')}.pdf`;
            doc.save(filename);
            
            showNotification('Reporte mensual generado exitosamente', 'success');
        }

        // Actualizar reportes
       function updateReports() {
    const container = document.getElementById('reportsContainer');
    const period = document.getElementById('reportsDateFilter').value;
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
            
            <!-- Reporte 1: Participantes Atendidos -->
            <div class="report-card" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center;">
                <div style="font-size: 48px; color: #28a745; margin-bottom: 15px;">
                    <i class="fas fa-users"></i>
                </div>
                <h3 style="color: #2d3748; margin-bottom: 15px;">Participantes Atendidos</h3>
                <p style="color: #6c757d; margin-bottom: 20px;">Reporte completo de todos los participantes registrados en el sistema</p>
                <div style="margin-bottom: 20px;">
                    <span style="font-size: 24px; font-weight: bold; color: #28a745;">${participants.length}</span>
                    <br><small style="color: #6c757d;">Total de participantes</small>
                </div>
                <button class="btn btn-success" onclick="generateParticipantsReport()" style="width: 100%;">
                    <i class="fas fa-file-excel"></i> Generar Reporte Excel
                </button>
            </div>
            
            <!-- Reporte 2: Ofertas y Patronos -->
            <div class="report-card" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center;">
                <div style="font-size: 48px; color: #c8102e; margin-bottom: 15px;">
                    <i class="fas fa-briefcase"></i>
                </div>
                <h3 style="color: #2d3748; margin-bottom: 15px;">Ofertas y Patronos</h3>
                <p style="color: #6c757d; margin-bottom: 20px;">Reporte de ofertas de empleo y empresas patronas registradas</p>
                <div style="margin-bottom: 10px;">
                    <span style="font-size: 20px; font-weight: bold; color: #c8102e;">${offers.length}</span>
                    <small style="color: #6c757d; display: block;">Ofertas totales</small>
                </div>
                <div style="margin-bottom: 20px;">
                    <span style="font-size: 20px; font-weight: bold; color: #c8102e;">${[...new Set(offers.map(o => o.companyName))].length}</span>
                    <small style="color: #6c757d; display: block;">Empresas 칰nicas</small>
                </div>
                <button class="btn" onclick="generateOffersReport()" style="width: 100%; background: #c8102e; color: white;">
                    <i class="fas fa-file-excel"></i> Generar Reporte Excel
                </button>
            </div>
            
            <!-- Reporte 3: Solicitudes (Referidos) -->
            <div class="report-card" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center;">
                <div style="font-size: 48px; color: #17a2b8; margin-bottom: 15px;">
                    <i class="fas fa-paper-plane"></i>
                </div>
                <h3 style="color: #2d3748; margin-bottom: 15px;">Solicitudes (Referidos)</h3>
                <p style="color: #6c757d; margin-bottom: 20px;">Reporte de todas las solicitudes procesadas y referidas a patronos</p>
                <div style="margin-bottom: 20px;">
                    <span style="font-size: 24px; font-weight: bold; color: #17a2b8;">${applications.length}</span>
                    <br><small style="color: #6c757d;">Total de solicitudes</small>
                </div>
                <button class="btn btn-info" onclick="generateReferralsReport()" style="width: 100%;">
                    <i class="fas fa-file-excel"></i> Generar Reporte Excel
                </button>
            </div>
            
            <!-- Reporte 4: Citas Manpower -->
            <div class="report-card" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center;">
                <div style="font-size: 48px; color: #6f42c1; margin-bottom: 15px;">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <h3 style="color: #2d3748; margin-bottom: 15px;">Citas Atendidos (Manpower)</h3>
                <p style="color: #6c757d; margin-bottom: 20px;">Reporte de todas las citas programadas y atendidas con Manpower</p>
                <div style="margin-bottom: 20px;">
                    <span style="font-size: 24px; font-weight: bold; color: #6f42c1;">${appointments.length}</span>
                    <br><small style="color: #6c757d;">Total de citas</small>
                </div>
                <button class="btn" onclick="generateManpowerReport()" style="width: 100%; background: #6f42c1; color: white;">
                    <i class="fas fa-file-excel"></i> Generar Reporte Excel
                </button>
            </div>
            
        </div>
        
        <div style="margin-top: 30px; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <h4 style="color: #2d3748; margin-bottom: 15px;">游늵 Reporte Consolidado</h4>
            <p style="color: #6c757d; margin-bottom: 20px;">Generar un reporte completo con todos los datos del sistema</p>
            <button class="btn btn-primary" onclick="generateConsolidatedReport()" style="padding: 12px 30px;">
                <i class="fas fa-chart-bar"></i> Generar Reporte Consolidado
            </button>
        </div>
    `;
}

// Generar reporte de participantes
function generateParticipantsReport() {
    if (participants.length === 0) {
        showNotification('No hay participantes para reportar', 'warning');
        return;
    }

    const data = participants.map(participant => ({
        'Fecha Registro': new Date(participant.registeredAt).toLocaleDateString('es-ES'),
        'Tipo Participante': participant.participantType === 'new' ? 'Nuevo' : 'Seguimiento',
        'Nombre Completo': `${participant.firstName} ${participant.lastName}`,
        'Email': participant.email,
        'Tel칠fono': participant.phone,
        'Ciudad': participant.city,
        'Tipo Estudiante': getStudentTypeLabel(participant.studentType),
        'Recinto': getCampusLabel(participant.campus),
        'ID Estudiante': participant.studentId || 'N/A',
        'Horario': participant.schedule === 'diurno' ? 'Diurno' : 'Nocturno',
        'A침o de Estudios': participant.studyYear,
        'Concentraci칩n': participant.concentration,
        'Divisi칩n Acad칠mica': participant.academicDivision || 'N/A',
        'Grado Acad칠mico': participant.academicDegree || 'N/A',
        'Candidato a Graduaci칩n': participant.graduationCandidate === 'yes' ? 'S칤' : 'No',
        'Resume Disponible': participant.resume ? 'S칤' : 'No'
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Participantes Atendidos");
    
    const filename = `Reporte_Participantes_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, filename);
    
    showNotification('Reporte de participantes generado exitosamente', 'success');
}

// Generar reporte de ofertas y patronos
function generateOffersReport() {
    if (offers.length === 0) {
        showNotification('No hay ofertas para reportar', 'warning');
        return;
    }

    // Hoja 1: Ofertas detalladas
    const offersData = offers.map(offer => ({
        'Fecha Publicaci칩n': new Date(offer.today || offer.createdAt).toLocaleDateString('es-ES'),
        'Tipo Patrono': offer.patronType === 'new' ? 'Patrono Nuevo' : 'Patrono Existente',
        'Empresa': offer.companyName,
        'Contacto': offer.contactPerson,
        'Posici칩n Contacto': offer.contactPosition || 'N/A',
        'Email Empresa': offer.email,
        'Tel칠fono Empresa': offer.phone,
        'Recibida Por': offer.receivedThrough || 'N/A',
        'Posici칩n Ofertada': offer.position,
        'Tipo Posici칩n': getTypeLabel(offer.positionType),
'Sector Industrial': getSectorLabel(offer.academicDivision),
        'Ubicaci칩n': offer.location,
        'Salario': offer.salary,
        'Fecha L칤mite': new Date(offer.deadline).toLocaleDateString('es-ES'),
        'Estado Actual': getOfferStatus(offer.deadline) === 'expired' ? 'Vencida' : 
                        getOfferStatus(offer.deadline) === 'expiring' ? 'Vence Pronto' : 'Activa',
        'Descripci칩n': offer.jobDescription || 'N/A',
        'Requisitos': offer.requirements,
        'Horarios': offer.schedule || 'N/A',
        'Actividades Reclutamiento': offer.activities ? offer.activities.join(', ') : 'N/A',
        'Notas': offer.notes || 'N/A'
    }));

    // Hoja 2: Resumen de patronos
    const companiesMap = {};
    offers.forEach(offer => {
        if (!companiesMap[offer.companyName]) {
            companiesMap[offer.companyName] = {
                empresa: offer.companyName,
                contacto: offer.contactPerson,
                email: offer.email,
                telefono: offer.phone,
                totalOfertas: 0,
                ofertasActivas: 0,
                primeraOferta: new Date(offer.today || offer.createdAt),
                ultimaOferta: new Date(offer.today || offer.createdAt)
            };
        }
        
        companiesMap[offer.companyName].totalOfertas++;
        if (getOfferStatus(offer.deadline) === 'active') {
            companiesMap[offer.companyName].ofertasActivas++;
        }
        
        const offerDate = new Date(offer.today || offer.createdAt);
        if (offerDate < companiesMap[offer.companyName].primeraOferta) {
            companiesMap[offer.companyName].primeraOferta = offerDate;
        }
        if (offerDate > companiesMap[offer.companyName].ultimaOferta) {
            companiesMap[offer.companyName].ultimaOferta = offerDate;
        }
    });

    const patronsData = Object.values(companiesMap).map(company => ({
        'Empresa': company.empresa,
        'Contacto Principal': company.contacto,
        'Email': company.email,
        'Tel칠fono': company.telefono,
        'Total Ofertas': company.totalOfertas,
        'Ofertas Activas': company.ofertasActivas,
        'Primera Oferta': company.primeraOferta.toLocaleDateString('es-ES'),
        '칔ltima Oferta': company.ultimaOferta.toLocaleDateString('es-ES')
    }));

    // Crear workbook con m칰ltiples hojas
    const wb = XLSX.utils.book_new();
    
    const offersSheet = XLSX.utils.json_to_sheet(offersData);
    XLSX.utils.book_append_sheet(wb, offersSheet, "Ofertas Detalladas");
    
    const patronsSheet = XLSX.utils.json_to_sheet(patronsData);
    XLSX.utils.book_append_sheet(wb, patronsSheet, "Resumen Patronos");
    
    const filename = `Reporte_Ofertas_Patronos_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, filename);
    
    showNotification('Reporte de ofertas y patronos generado exitosamente', 'success');
}

// Generar reporte de solicitudes (referidos)
function generateReferralsReport() {
    if (applications.length === 0) {
        showNotification('No hay solicitudes para reportar', 'warning');
        return;
    }

    const data = applications.map(application => {
        const participant = getParticipantData(application.participantId);
        const offer = offers.find(o => o.id === application.offerId);
        
        return {
            'Fecha Solicitud': new Date(application.appliedAt).toLocaleDateString('es-ES'),
            'Hora Solicitud': new Date(application.appliedAt).toLocaleTimeString('es-ES'),
            'Participante': application.participantName,
            'Email Participante': application.participantEmail,
            'Tel칠fono Participante': application.participantPhone,
            'Tipo Estudiante': getStudentTypeLabel(participant?.studentType),
            'Recinto': getCampusLabel(participant?.campus),
            'Concentraci칩n': participant?.concentration || 'N/A',
            'A침o Acad칠mico': participant?.studyYear || 'N/A',
            'ID Estudiante': participant?.studentId || 'N/A',
            'Empresa': application.companyName,
            'Posici칩n Aplicada': application.offerTitle,
            'Contacto Empresa': offer?.contactPerson || 'N/A',
            'Email Empresa': offer?.email || 'N/A',
            'Tel칠fono Empresa': offer?.phone || 'N/A',
            'Estado Solicitud': getApplicationStatusLabel(application.status),
            'Fecha Procesamiento': application.processedAt ? new Date(application.processedAt).toLocaleDateString('es-ES') : 'N/A',
            'Fecha Env칤o': application.adminReview?.sentAt ? new Date(application.adminReview.sentAt).toLocaleDateString('es-ES') : 'N/A',
            'Decisi칩n Admin': application.adminReview?.decision || 'N/A',
            'Notas Admin': application.adminReview?.notes || 'N/A',
            'Revisado Por': application.adminReview?.reviewedBy || 'N/A'
        };
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Solicitudes y Referidos");
    
    const filename = `Reporte_Solicitudes_Referidos_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, filename);
    
    showNotification('Reporte de solicitudes y referidos generado exitosamente', 'success');
}

// Funci칩n auxiliar para obtener etiqueta del estado de aplicaci칩n
function getApplicationStatusLabel(status) {
    const labels = {
        'pending': 'Pendiente',
        'processed': 'Procesada',
        'referred': 'Referida',
        'approved_sent': 'Referido Enviado',
        'rejected': 'Rechazada'
    };
    return labels[status] || status;
}

// Generar reporte de citas Manpower
function generateManpowerReport() {
    if (appointments.length === 0) {
        showNotification('No hay citas para reportar', 'warning');
        return;
    }

    const data = appointments.map(appointment => {
        // Formatear fecha de cita
        const [year, month, day] = appointment.appointmentDate.split('-');
        const appointmentDate = new Date(year, month - 1, day);
        const formattedDate = appointmentDate.toLocaleDateString('es-ES');
        
        // Formatear hora
        const [hours, minutes] = appointment.appointmentTime.split(':');
        const hour12 = hours > 12 ? hours - 12 : (hours === '00' ? 12 : hours);
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const formattedTime = `${hour12}:${minutes} ${ampm}`;

        return {
            'Fecha Registro': new Date(appointment.createdAt).toLocaleDateString('es-ES'),
            'Tipo Participante': appointment.participantType === 'new' ? 'Nuevo' : 'Seguimiento',
            'Nombre Completo': `${appointment.firstName} ${appointment.lastName}`,
            'Email': appointment.email,
            'Tel칠fono': appointment.phone,
            'Ciudad': appointment.city,
            'Tipo Estudiante': getStudentTypeLabel(appointment.studentType),
            'Recinto': getCampusLabel(appointment.campus),
            'ID Estudiante': appointment.studentId || 'N/A',
            'Concentraci칩n': appointment.concentration,
            'Fecha Cita': formattedDate,
            'Hora Cita': formattedTime,
            'D칤a Semana': appointmentDate.toLocaleDateString('es-ES', { weekday: 'long' }),
            'Servicio': 'Orientaci칩n con Manpower',
            'Estado Cita': getAppointmentStatusLabel(appointment.status),
            'Resume Adjunto': appointment.hasResume ? 'S칤' : 'No',
            'Descripci칩n': appointment.description || 'N/A',
            'Fecha Completada': appointment.completedAt ? new Date(appointment.completedAt).toLocaleDateString('es-ES') : 'N/A',
            'Fecha Cancelada': appointment.cancelledAt ? new Date(appointment.cancelledAt).toLocaleDateString('es-ES') : 'N/A'
        };
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Citas Manpower");
    
    const filename = `Reporte_Citas_Manpower_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, filename);
    
    showNotification('Reporte de citas Manpower generado exitosamente', 'success');
}

// Funci칩n auxiliar para obtener etiqueta del estado de cita
function getAppointmentStatusLabel(status) {
    const labels = {
        'scheduled': 'Programada',
        'completed': 'Completada',
        'cancelled': 'Cancelada'
    };
    return labels[status] || status;
}

// Generar reporte consolidado
function generateConsolidatedReport() {
    const wb = XLSX.utils.book_new();
    
    // Hoja 1: Resumen ejecutivo
    const today = new Date();
    const summaryData = [
        { M칠trica: 'Total de Participantes', Valor: participants.length },
        { M칠trica: 'Participantes Nuevos', Valor: participants.filter(p => p.participantType === 'new').length },
        { M칠trica: 'Participantes de Seguimiento', Valor: participants.filter(p => p.participantType === 'returning').length },
        { M칠trica: 'Total de Ofertas', Valor: offers.length },
        { M칠trica: 'Ofertas Activas', Valor: offers.filter(o => getOfferStatus(o.deadline) === 'active').length },
        { M칠trica: 'Ofertas Vencidas', Valor: offers.filter(o => getOfferStatus(o.deadline) === 'expired').length },
        { M칠trica: 'Empresas 칔nicas', Valor: [...new Set(offers.map(o => o.companyName))].length },
        { M칠trica: 'Total de Solicitudes', Valor: applications.length },
        { M칠trica: 'Solicitudes Pendientes', Valor: applications.filter(a => a.status === 'pending').length },
        { M칠trica: 'Referidos Enviados', Valor: applications.filter(a => a.status === 'approved_sent').length },
        { M칠trica: 'Solicitudes Rechazadas', Valor: applications.filter(a => a.status === 'rejected').length },
        { M칠trica: 'Total de Citas', Valor: appointments.length },
        { M칠trica: 'Citas Completadas', Valor: appointments.filter(a => a.status === 'completed').length },
        { M칠trica: 'Citas Programadas', Valor: appointments.filter(a => a.status === 'scheduled').length },
        { M칠trica: 'Total Colocados', Valor: placements.length },
        { M칠trica: 'Colocados Directos', Valor: placements.filter(p => p.trackingType === 'directo').length },
        { M칠trica: 'Colocados Indirectos', Valor: placements.filter(p => p.trackingType === 'indirecto').length },
        { M칠trica: 'Fecha del Reporte', Valor: today.toLocaleDateString('es-ES') }
    ];
    
    const summarySheet = XLSX.utils.json_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, summarySheet, "Resumen Ejecutivo");

    // Hoja 2: Participantes (datos resumidos)
    if (participants.length > 0) {
        const participantsData = participants.map(p => ({
            'Nombre': `${p.firstName} ${p.lastName}`,
            'Email': p.email,
            'Recinto': getCampusLabel(p.campus),
            'Concentraci칩n': p.concentration,
            'Tipo': p.participantType === 'new' ? 'Nuevo' : 'Seguimiento',
            'Fecha Registro': new Date(p.registeredAt).toLocaleDateString('es-ES')
        }));
        const participantsSheet = XLSX.utils.json_to_sheet(participantsData);
        XLSX.utils.book_append_sheet(wb, participantsSheet, "Participantes");
    }

    // Hoja 3: Ofertas (datos resumidos)
    if (offers.length > 0) {
        const offersData = offers.map(o => ({
            'Empresa': o.companyName,
            'Posici칩n': o.position,
            'Ubicaci칩n': o.location,
            'Salario': o.salary,
            'Estado': getOfferStatus(o.deadline) === 'expired' ? 'Vencida' : 
                     getOfferStatus(o.deadline) === 'expiring' ? 'Vence Pronto' : 'Activa',
            'Fecha Publicaci칩n': new Date(o.today || o.createdAt).toLocaleDateString('es-ES')
        }));
        const offersSheet = XLSX.utils.json_to_sheet(offersData);
        XLSX.utils.book_append_sheet(wb, offersSheet, "Ofertas");
    }

    // Hoja 4: Solicitudes (datos resumidos)
    if (applications.length > 0) {
        const applicationsData = applications.map(a => ({
            'Participante': a.participantName,
            'Empresa': a.companyName,
            'Posici칩n': a.offerTitle,
            'Estado': getApplicationStatusLabel(a.status),
            'Fecha': new Date(a.appliedAt).toLocaleDateString('es-ES')
        }));
        const applicationsSheet = XLSX.utils.json_to_sheet(applicationsData);
        XLSX.utils.book_append_sheet(wb, applicationsSheet, "Solicitudes");
    }

    // Hoja 5: Citas (datos resumidos)
    if (appointments.length > 0) {
        const appointmentsData = appointments.map(a => {
            const [year, month, day] = a.appointmentDate.split('-');
            const appointmentDate = new Date(year, month - 1, day);
            return {
                'Participante': `${a.firstName} ${a.lastName}`,
                'Email': a.email,
                'Recinto': getCampusLabel(a.campus),
                'Fecha Cita': appointmentDate.toLocaleDateString('es-ES'),
                'Estado': getAppointmentStatusLabel(a.status),
                'Registro': new Date(a.createdAt).toLocaleDateString('es-ES')
            };
        });
        const appointmentsSheet = XLSX.utils.json_to_sheet(appointmentsData);
        XLSX.utils.book_append_sheet(wb, appointmentsSheet, "Citas");
    }

    const filename = `Reporte_Consolidado_UAGM_${today.toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, filename);
    
    showNotification('Reporte consolidado generado exitosamente', 'success');
}

        // Actualizar datos
        function refreshData() {
            loadAllData();
            updateStats();
            
            // Recargar tabla actual
            switch(currentTab) {
                case 'offers':
                    loadOffersTable();
                    break;
                case 'participants':
                    loadParticipantsTable();
                    break;
                case 'applications':
                    loadApplicationsTable();
                    break;
                case 'reports':
                    updateReports();
                    break;
            }
            
            showNotification('Datos actualizados correctamente', 'success');
// Verificar nuevas notificaciones
            checkForNewItems();
        }

        // Cerrar sesi칩n
        function logout() {
            if (confirm('쮼st치s seguro de que quieres cerrar sesi칩n?')) {
                window.location.href = 'Portal pagina principal.html';
            }
        }

        // Sistema de notificaciones
        function showNotification(message, type = 'info') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 10px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                max-width: 350px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            
            notification.style.backgroundColor = colors[type] || colors.info;
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            notification.innerHTML = `
                <i class="${icons[type] || icons.info}" style="margin-right: 10px;"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 4000);
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('detailsModal');
            if (event.target === modal) {
                closeDetailsModal();
            }
        }

        // Agregar animaciones CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
// Funciones del sistema de notificaciones
function toggleNotifications() {
    const dropdown = document.getElementById('notificationsDropdown');
    const isVisible = dropdown.classList.contains('show');
    
    if (isVisible) {
        dropdown.classList.remove('show');
    } else {
        dropdown.classList.add('show');
        loadNotifications();
    }
}

function loadNotifications() {
    const container = document.getElementById('notificationsList');
    
    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="no-notifications">
                <i class="fas fa-bell-slash"></i>
                <p>No hay notificaciones nuevas</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    notifications.slice(0, 10).forEach(notification => {
        const timeAgo = getTimeAgo(notification.timestamp);
        const unreadClass = notification.read ? '' : 'unread';
        
        html += `
            <div class="notification-item ${unreadClass}" onclick="markAsRead('${notification.id}')">
                <div class="notification-icon ${notification.type}">
                    <i class="${getNotificationIcon(notification.type)}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${timeAgo}</div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function checkForNewItems() {
    const currentOffers = offers.length;
    const currentParticipants = participants.length;
    const currentApplications = applications.length;
    const currentAppointments = appointments.length;
    
    // Verificar nuevas ofertas
if (currentOffers > lastCheckedOffers) {
    // Solo notificar ofertas creadas en las 칰ltimas 24 horas
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    
    const recentOffers = offers.filter(offer => {
        const offerDate = new Date(offer.createdAt || offer.today || '1900-01-01');
        return offerDate > yesterday;
    });
    
    const newOffers = recentOffers.slice(Math.max(0, recentOffers.length - (currentOffers - lastCheckedOffers)));
        newOffers.forEach(offer => {
            addNotification({
                type: 'new-offer',
                title: `Nueva Oferta de Empleo`,
                message: `${offer.position} en ${offer.companyName} - ${offer.location}`,
                data: {
                    offerId: offer.id,
                    company: offer.companyName,
                    position: offer.position
                }
            });
        });
        lastCheckedOffers = currentOffers;
        localStorage.setItem('lastCheckedOffers', lastCheckedOffers.toString());
    }
    
    // Verificar nuevos participantes
    if (currentParticipants > lastCheckedParticipants) {
        // Tomar los 칰ltimos participantes (los m치s nuevos)
const newParticipantsCount = currentParticipants - lastCheckedParticipants;
const newParticipants = participants.slice(-newParticipantsCount);
        newParticipants.forEach(participant => {
            addNotification({
                type: 'new-participant',
                title: `Nuevo Participante Registrado`,
                message: `${participant.firstName} ${participant.lastName} - ${participant.concentration} (${participant.campus})`,
                data: {
                    participantId: participant.id,
                    name: `${participant.firstName} ${participant.lastName}`,
                    campus: participant.campus
                }
            });
        });
        lastCheckedParticipants = currentParticipants;
        localStorage.setItem('lastCheckedParticipants', lastCheckedParticipants.toString());
    }
    
    // Verificar nuevas aplicaciones
    if (currentApplications > lastCheckedApplications) {
        // Tomar las 칰ltimas aplicaciones (las m치s nuevas)
const newApplicationsCount = currentApplications - lastCheckedApplications;
const newApplications = applications.slice(-newApplicationsCount);
        newApplications.forEach(application => {
            addNotification({
                type: 'new-application',
                title: `Nueva Solicitud de Empleo`,
                message: `${application.participantName} aplic칩 a ${application.offerTitle} en ${application.companyName}`,
                data: {
                    applicationId: application.id,
                    participant: application.participantName,
                    company: application.companyName,
                    position: application.offerTitle
                }
            });
        });
        lastCheckedApplications = currentApplications;
        localStorage.setItem('lastCheckedApplications', lastCheckedApplications.toString());
    }
    
    // Verificar nuevas citas
    if (currentAppointments > lastCheckedAppointments) {
        // Tomar las 칰ltimas citas (las m치s nuevas)
const newAppointmentsCount = currentAppointments - lastCheckedAppointments;
const newAppointments = appointments.slice(-newAppointmentsCount);
        newAppointments.forEach(appointment => {
            const appointmentDate = new Date(appointment.appointmentDate).toLocaleDateString('es-ES');
            addNotification({
                type: 'new-appointment',
                title: `Nueva Cita Programada`,
                message: `${appointment.firstName} ${appointment.lastName} - ${appointmentDate} a las ${appointment.appointmentTime}`,
                data: {
                    appointmentId: appointment.id,
                    name: `${appointment.firstName} ${appointment.lastName}`,
                    date: appointmentDate,
                    time: appointment.appointmentTime
                }
            });
        });
        lastCheckedAppointments = currentAppointments;
        localStorage.setItem('lastCheckedAppointments', lastCheckedAppointments.toString());
    }
    
    updateNotificationBadge();
}

function addNotification(notification) {
    const newNotification = {
        id: Date.now().toString(),
        ...notification,
        timestamp: new Date().toISOString(),
        read: false
    };
    
    notifications.unshift(newNotification);
    
    // Mantener solo las 칰ltimas 50 notificaciones
    if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
    }
    
    localStorage.setItem('adminNotifications', JSON.stringify(notifications));
    updateNotificationBadge();
}

function markAsRead(notificationId) {
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
        notification.read = true;
        localStorage.setItem('adminNotifications', JSON.stringify(notifications));
        updateNotificationBadge();
        loadNotifications();
    }
}

function markAllAsRead() {
    notifications.forEach(notification => {
        notification.read = true;
    });
    localStorage.setItem('adminNotifications', JSON.stringify(notifications));
    updateNotificationBadge();
    loadNotifications();
}

function updateNotificationBadge() {
    const unreadCount = notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notificationBadge');
    
    if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}

function getNotificationIcon(type) {
    const icons = {
        'new-offer': 'fas fa-briefcase',
        'new-participant': 'fas fa-user-plus',
        'new-application': 'fas fa-paper-plane',
        'new-appointment': 'fas fa-calendar-plus'
    };
    return icons[type] || 'fas fa-bell';
}

function getTimeAgo(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diffInMinutes = Math.floor((now - time) / (1000 * 60));
    
    if (diffInMinutes < 1) return 'Ahora mismo';
    if (diffInMinutes < 60) return `Hace ${diffInMinutes} min`;
    
    const diffInHours = Math.floor(diffInMinutes / 60);
    if (diffInHours < 24) return `Hace ${diffInHours}h`;
    
    const diffInDays = Math.floor(diffInHours / 24);
    if (diffInDays < 7) return `Hace ${diffInDays}d`;
    
    return time.toLocaleDateString();
}

// Cerrar dropdown al hacer clic fuera
document.addEventListener('click', function(event) {
    const container = document.querySelector('.notifications-container');
    const dropdown = document.getElementById('notificationsDropdown');
    
    if (!container.contains(event.target)) {
        dropdown.classList.remove('show');
    }
});

// Cargar tabla de citas
        function loadAppointmentsTable() {
            const container = document.getElementById('appointmentsTableContainer');
            
            if (appointments.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>No hay citas registradas</h3>
                        <p>Las citas programadas aparecer치n aqu칤</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Participante</th>
                            <th>Email</th>
                            <th>Tel칠fono</th>
                            <th>Servicio</th>
                            <th>Recinto</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            appointments.forEach(appointment => {
                const statusLabels = {
                    'scheduled': 'Programada',
                    'completed': 'Completada',
                    'cancelled': 'Cancelada'
                };

                const statusClasses = {
                    'scheduled': 'status-pending',
                    'completed': 'status-approved',
                    'cancelled': 'status-expired'
                };

                const campusLabels = {
                    'cupey': 'Cupey',
                    'bayamon': 'Bayam칩n',
                    'aguadilla': 'Aguadilla'
                };

                // Formatear fecha y hora
const [year, month, day] = appointment.appointmentDate.split('-');
const appointmentDate = new Date(year, month - 1, day);
const formattedDate = appointmentDate.toLocaleDateString('es-ES');
                
                const [hours, minutes] = appointment.appointmentTime.split(':');
                const hour12 = hours > 12 ? hours - 12 : (hours === '00' ? 12 : hours);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const formattedTime = `${hour12}:${minutes} ${ampm}`;

                html += `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${formattedTime}</td>
                        <td><strong>${appointment.firstName} ${appointment.lastName}</strong><br><small>ID: ${appointment.studentId || 'N/A'}</small></td>
                        <td>${appointment.email}</td>
                        <td>${appointment.phone}</td>
                        <td>Orientaci칩n Manpower</td>
                        <td>${campusLabels[appointment.campus] || appointment.campus || 'N/A'}</td>
                        <td><span class="status-badge ${statusClasses[appointment.status]}">${statusLabels[appointment.status]}</span></td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-info btn-small" onclick="viewAppointmentDetails('${appointment.id}')" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${appointment.status === 'scheduled' ? `
                                    <button class="btn btn-success btn-small" onclick="completeAppointment('${appointment.id}')" title="Marcar completada">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="cancelAppointment('${appointment.id}')" title="Cancelar">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : ''}
                                ${appointment.hasResume ? `
                                    <button class="btn btn-warning btn-small" onclick="downloadAppointmentResume('${appointment.id}')" title="Descargar resum칠">
                                        <i class="fas fa-download"></i>
<button class="btn btn-danger btn-small" onclick="deleteAppointment('${appointment.id}')" title="Eliminar cita">
                                    <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }
// Ver detalles de cita
        function viewAppointmentDetails(appointmentId) {
            const appointment = appointments.find(app => app.id === appointmentId);
            if (!appointment) return;

            currentModalData = { type: 'appointment', data: appointment };

            const campusLabels = {
                'cupey': 'Recinto de Cupey',
                'bayamon': 'Centro Universitario de Bayam칩n',
                'aguadilla': 'Centro Universitario de Aguadilla'
            };

            const studentTypeLabels = {
                'student': 'Estudiante',
                'alumni': 'Exalumno',
                'community': 'Comunidad'
            };

           // Formatear fecha y hora
const [year, month, day] = appointment.appointmentDate.split('-');
const appointmentDate = new Date(year, month - 1, day);
const formattedDate = appointmentDate.toLocaleDateString('es-ES', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});
            
            const [hours, minutes] = appointment.appointmentTime.split(':');
            const hour12 = hours > 12 ? hours - 12 : (hours === '00' ? 12 : hours);
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedTime = `${hour12}:${minutes} ${ampm}`;

            document.getElementById('modalTitle').textContent = `Cita: ${appointment.firstName} ${appointment.lastName}`;
            document.getElementById('modalBody').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
                    <div>
                        <h4 style="color: #c8102e; margin-bottom: 15px;">Informaci칩n Personal</h4>
                        <p><strong>Nombre:</strong> ${appointment.firstName} ${appointment.lastName}</p>
                        <p><strong>Tipo:</strong> ${appointment.participantType === 'new' ? 'Nuevo' : 'Participante de Seguimiento'}</p>
                        <p><strong>Email:</strong> ${appointment.email}</p>
                        <p><strong>Tel칠fono:</strong> ${appointment.phone}</p>
                        <p><strong>Ciudad:</strong> ${appointment.city}</p>
                    </div>
                    <div>
                        <h4 style="color: #c8102e; margin-bottom: 15px;">Informaci칩n Acad칠mica</h4>
                        <p><strong>Tipo:</strong> ${studentTypeLabels[appointment.studentType]}</p>
                        <p><strong>Recinto:</strong> ${campusLabels[appointment.campus] || appointment.campus || 'N/A'}</p>
                        <p><strong>ID Estudiante:</strong> ${appointment.studentId || 'N/A'}</p>
                        <p><strong>Concentraci칩n:</strong> ${appointment.concentration}</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #c8102e; margin-bottom: 15px;">Detalles de la Cita</h4>
                    <p><strong>Fecha:</strong> ${formattedDate}</p>
                    <p><strong>Hora:</strong> ${formattedTime}</p>
                    <p><strong>Servicio:</strong> Orientaci칩n con Manpower</p>
                    <p><strong>Estado:</strong> <span class="status-badge ${appointment.status === 'scheduled' ? 'status-pending' : appointment.status === 'completed' ? 'status-approved' : 'status-expired'}">${appointment.status === 'scheduled' ? 'Programada' : appointment.status === 'completed' ? 'Completada' : 'Cancelada'}</span></p>
                    ${appointment.hasResume ? '<p><strong>Resum칠:</strong> <i class="fas fa-check text-success"></i> Adjuntado</p>' : '<p><strong>Resum칠:</strong> No adjuntado</p>'}
                </div>
                
                ${appointment.description ? `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #c8102e; margin-bottom: 10px;">Descripci칩n</h4>
                    <p style="background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${appointment.description}</p>
                </div>
                ` : ''}
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #6c757d;">
                    <p><strong>Registrada:</strong> ${new Date(appointment.createdAt).toLocaleString()}</p>
                    <p><strong>Fuente:</strong> Sistema de Citas Online</p>
                </div>
            `;

            document.getElementById('detailsModal').style.display = 'flex';
        }

        // Completar cita
        async function completeAppointment(appointmentId) {
    if (confirm('쯄arcar esta cita como completada?')) {
        try {
            const updatedData = {
                status: 'completed',
                completedAt: new Date().toISOString()
            };
            
            // Actualizar en Firebase
            if (isFirebaseInitialized) {
                const snapshot = await db.collection('appointments')
                    .where('id', '==', appointmentId)
                    .get();
                
                if (!snapshot.empty) {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.update(doc.ref, updatedData);
                    });
                    await batch.commit();
                    console.log('Cita completada en Firebase:', appointmentId);
                }
            }
            
            // Actualizar en memoria local
            const appointment = appointments.find(app => app.id === appointmentId);
            if (appointment) {
                appointment.status = 'completed';
                appointment.completedAt = new Date().toISOString();
            }
            
            // Actualizar localStorage como respaldo
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            updateStats();
            loadAppointmentsTable();
            showNotification('Cita marcada como completada', 'success');
            
        } catch (error) {
            console.error('Error completando cita:', error);
            showNotification('Error marcando cita como completada. Intenta de nuevo.', 'error');
        }
    }
}

        // Cancelar cita
        async function cancelAppointment(appointmentId) {
    if (confirm('쮼st치s seguro de que quieres cancelar esta cita?')) {
        try {
            const updatedData = {
                status: 'cancelled',
                cancelledAt: new Date().toISOString()
            };
            
            // Actualizar en Firebase
            if (isFirebaseInitialized) {
                const snapshot = await db.collection('appointments')
                    .where('id', '==', appointmentId)
                    .get();
                
                if (!snapshot.empty) {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.update(doc.ref, updatedData);
                    });
                    await batch.commit();
                    console.log('Cita cancelada en Firebase:', appointmentId);
                }
            }
            
            // Actualizar en memoria local
            const appointment = appointments.find(app => app.id === appointmentId);
            if (appointment) {
                appointment.status = 'cancelled';
                appointment.cancelledAt = new Date().toISOString();
            }
            
            // Actualizar localStorage como respaldo
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            updateStats();
            loadAppointmentsTable();
            showNotification('Cita cancelada', 'success');
            
            // Registrar en historial
            const participant = participants.find(p => 
                p.email === appointment.email || 
                (p.firstName === appointment.firstName && p.lastName === appointment.lastName)
            );
            
            if (participant) {
                await addToParticipantHistory(participant.id, {
                    eventType: 'appointment_cancelled',
                    eventTitle: 'Cita Cancelada',
                    description: `Cita cancelada: ${appointment.serviceType === 'orientacion-manpower' ? 'Orientaci칩n con Manpower' : appointment.serviceType}`,
                    data: {
                        participantName: `${appointment.firstName} ${appointment.lastName}`,
                        appointmentDate: appointment.appointmentDate,
                        appointmentTime: appointment.appointmentTime,
                        serviceType: appointment.serviceType,
                        campus: appointment.campus,
                        appointmentId: appointment.id,
                        cancelReason: 'Cancelada por administrador'
                    }
                });
            }
            
        } catch (error) {

            console.error('Error cancelando cita:', error);
            showNotification('Error cancelando la cita. Intenta de nuevo.', 'error');
        }
    }
}

        // Descargar resum칠 de cita
        function downloadAppointmentResume(appointmentId) {
            const appointment = appointments.find(app => app.id === appointmentId);
            if (appointment && appointment.resumeUrl) {
                const link = document.createElement('a');
                link.href = appointment.resumeUrl;
                link.download = `resume_cita_${appointment.firstName}_${appointment.lastName}.pdf`;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification(`Descargando resum칠 de ${appointment.firstName} ${appointment.lastName}`, 'success');
            } else {
                showNotification('No hay resum칠 disponible para esta cita', 'warning');
            }
        }

// Eliminar cita completamente
        async function deleteAppointment(appointmentId) {
            const appointment = appointments.find(app => app.id === appointmentId);
            if (!appointment) return;
            
            if (confirm(`쮼st치s seguro de que quieres eliminar permanentemente la cita de "${appointment.firstName} ${appointment.lastName}"?`)) {
                try {
                    // Buscar y eliminar de Firebase
                    if (isFirebaseInitialized) {
                        const snapshot = await db.collection('appointments')
                            .where('id', '==', appointmentId)
                            .get();
                        
                        if (!snapshot.empty) {
                            const batch = db.batch();
                            snapshot.docs.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();
                            console.log('Cita eliminada de Firebase:', appointmentId);
                        }
                    }
                    
                    // Eliminar de memoria local
                    appointments = appointments.filter(app => app.id !== appointmentId);
                    
                    // Actualizar localStorage como respaldo
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                    
                    // Actualizar interfaz
                    updateStats();
                    filterAppointments();
                    showNotification('Cita eliminada permanentemente', 'success');

// Ajustar contador de citas
lastCheckedAppointments = Math.max(0, appointments.length);
localStorage.setItem('lastCheckedAppointments', lastCheckedAppointments.toString());
                    
                } catch (error) {
                    console.error('Error eliminando cita:', error);
                    showNotification('Error eliminando la cita. Intenta de nuevo.', 'error');
                }
            }
        }
// Filtrar citas
function filterAppointments() {
    // Guardar valores actuales de los filtros
    currentFilters.appointments.search = document.getElementById('appointmentsSearch').value.toLowerCase();
    currentFilters.appointments.status = document.getElementById('appointmentsStatusFilter').value;
    currentFilters.appointments.date = document.getElementById('appointmentsDateFilter').value;
    
    let filteredAppointments = appointments;
    
    // Filtro de b칰squeda
    if (currentFilters.appointments.search) {
        filteredAppointments = filteredAppointments.filter(appointment => 
            `${appointment.firstName} ${appointment.lastName}`.toLowerCase().includes(currentFilters.appointments.search) ||
            appointment.email.toLowerCase().includes(currentFilters.appointments.search) ||
            appointment.phone.includes(currentFilters.appointments.search) ||
            appointment.concentration.toLowerCase().includes(currentFilters.appointments.search) ||
            (appointment.studentId && appointment.studentId.toLowerCase().includes(currentFilters.appointments.search))
        );
    }
    
    // Filtro de estado
    if (currentFilters.appointments.status) {
        filteredAppointments = filteredAppointments.filter(appointment => 
            appointment.status === currentFilters.appointments.status
        );
    }
    
    // Filtro de fecha
    if (currentFilters.appointments.date) {
        const today = new Date();
        filteredAppointments = filteredAppointments.filter(appointment => {
            const [year, month, day] = appointment.appointmentDate.split('-');
            const appointmentDate = new Date(year, month - 1, day);
            
            switch(currentFilters.appointments.date) {
                case 'today':
                    return appointmentDate.toDateString() === today.toDateString();
                case 'week':
                    const weekFromNow = new Date(today);
                    weekFromNow.setDate(today.getDate() + 7);
                    return appointmentDate >= today && appointmentDate <= weekFromNow;
                case 'month':
                    return appointmentDate.getMonth() === today.getMonth() && 
                           appointmentDate.getFullYear() === today.getFullYear();
                default:
                    return true;
            }
        });
    }
    
    displayFilteredAppointments(filteredAppointments);
}

        // Mostrar citas filtradas
        function displayFilteredAppointments(filteredAppointments) {
            const container = document.getElementById('appointmentsTableContainer');
            
            if (filteredAppointments.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-search"></i>
                        <h3>No se encontraron citas</h3>
                        <p>No hay citas que coincidan con los filtros aplicados</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Participante</th>
                            <th>Email</th>
                            <th>Tel칠fono</th>
                            <th>Servicio</th>
                            <th>Recinto</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredAppointments.forEach(appointment => {
                const statusLabels = {
                    'scheduled': 'Programada',
                    'completed': 'Completada',
                    'cancelled': 'Cancelada'
                };

                const statusClasses = {
                    'scheduled': 'status-pending',
                    'completed': 'status-approved',
                    'cancelled': 'status-expired'
                };

                const campusLabels = {
                    'cupey': 'Cupey',
                    'bayamon': 'Bayam칩n',
                    'aguadilla': 'Aguadilla'
                };

                // Formatear fecha y hora
               const [year, month, day] = appointment.appointmentDate.split('-');
const appointmentDate = new Date(year, month - 1, day);
                const formattedDate = appointmentDate.toLocaleDateString('es-ES');
                
                const [hours, minutes] = appointment.appointmentTime.split(':');
                const hour12 = hours > 12 ? hours - 12 : (hours === '00' ? 12 : hours);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const formattedTime = `${hour12}:${minutes} ${ampm}`;

                html += `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${formattedTime}</td>
                        <td><strong>${appointment.firstName} ${appointment.lastName}</strong><br><small>ID: ${appointment.studentId || 'N/A'}</small></td>
                        <td>${appointment.email}</td>
                        <td>${appointment.phone}</td>
                        <td>Orientaci칩n Manpower</td>
                        <td>${campusLabels[appointment.campus] || appointment.campus || 'N/A'}</td>
                        <td><span class="status-badge ${statusClasses[appointment.status]}">${statusLabels[appointment.status]}</span></td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-info btn-small" onclick="viewAppointmentDetails('${appointment.id}')" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${appointment.status === 'scheduled' ? `
    <button class="btn btn-warning btn-small" onclick="editAppointment('${appointment.id}')" title="Editar cita">
        <i class="fas fa-edit"></i>
    </button>
    <button class="btn btn-success btn-small" onclick="completeAppointment('${appointment.id}')" title="Marcar completada">
        <i class="fas fa-check"></i>
    </button>
    <button class="btn btn-danger btn-small" onclick="cancelAppointment('${appointment.id}')" title="Cancelar">
        <i class="fas fa-times"></i>
    </button>
` : ''}
                                ${appointment.hasResume ? `
                                    <button class="btn btn-warning btn-small" onclick="downloadAppointmentResume('${appointment.id}')" title="Descargar resum칠">
                                        <i class="fas fa-download"></i>
                                    </button>
                                ` : ''}
<button class="btn btn-danger btn-small" onclick="deleteAppointment('${appointment.id}')" title="Eliminar cita">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }
// Exportar datos de citas
        function exportAppointmentsData() {
            if (appointments.length === 0) {
                showNotification('No hay citas para exportar', 'warning');
                return;
            }

            const data = appointments.map(appointment => {
                const campusLabels = {
                    'cupey': 'Recinto de Cupey',
                    'bayamon': 'Centro Universitario de Bayam칩n',
                    'aguadilla': 'Centro Universitario de Aguadilla'
                };

                const studentTypeLabels = {
                    'student': 'Estudiante',
                    'alumni': 'Exalumno',
                    'community': 'Comunidad'
                };

                const statusLabels = {
                    'scheduled': 'Programada',
                    'completed': 'Completada',
                    'cancelled': 'Cancelada'
                };

                // Formatear fecha y hora
                const appointmentDate = new Date(appointment.appointmentDate);
                const formattedDate = appointmentDate.toLocaleDateString('es-ES');
                
                const [hours, minutes] = appointment.appointmentTime.split(':');
                const hour12 = hours > 12 ? hours - 12 : (hours === '00' ? 12 : hours);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const formattedTime = `${hour12}:${minutes} ${ampm}`;

                return {
                    'Fecha Registro': new Date(appointment.createdAt).toLocaleDateString('es-ES'),
                    'Tipo Participante': appointment.participantType === 'new' ? 'Nuevo' : 'Seguimiento',
                    'Nombre': appointment.firstName,
                    'Apellidos': appointment.lastName,
                    'Email': appointment.email,
                    'Tel칠fono': appointment.phone,
                    'Ciudad': appointment.city,
                    'Tipo Estudiante': studentTypeLabels[appointment.studentType],
                    'Recinto': campusLabels[appointment.campus] || appointment.campus || 'N/A',
                    'ID Estudiante': appointment.studentId || 'N/A',
                    'Concentraci칩n': appointment.concentration,
                    'Fecha Cita': formattedDate,
                    'Hora Cita': formattedTime,
                    'Servicio': 'Orientaci칩n con Manpower',
                    'Estado': statusLabels[appointment.status],
                    'Descripci칩n': appointment.description || '',
                    'Resume Adjunto': appointment.hasResume ? 'S칤' : 'No',
                    'Completada': appointment.completedAt ? new Date(appointment.completedAt).toLocaleDateString('es-ES') : '',
                    'Cancelada': appointment.cancelledAt ? new Date(appointment.cancelledAt).toLocaleDateString('es-ES') : ''
                };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Citas");
            
            const filename = `Citas_Manpower_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showNotification('Citas exportadas exitosamente', 'success');
        }

// Funci칩n para formatear fechas correctamente en Puerto Rico
function formatDateForPR(dateString) {
    if (!dateString) return 'Sin fecha';
    
    // Si la fecha est치 en formato YYYY-MM-DD, crear fecha local
    if (dateString.includes('-')) {
        const [year, month, day] = dateString.split('-');
        const localDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        return localDate.toLocaleDateString('es-PR');
    }
    
    // Si no, usar el formato original
    return new Date(dateString).toLocaleDateString('es-PR');
}

// ============= NUEVAS FUNCIONES PARA SOLICITUDES PENDIENTES =============

// Variables globales para el sistema manual
let currentApplicationForEmail = null;

// Cargar tabla de solicitudes pendientes
function loadPendingApplicationsTable() {
    const container = document.getElementById('pendingApplicationsContainer');
    
    // Filtrar solo aplicaciones pendientes
    const pendingApps = applications.filter(app => app.status === 'pending');
    
    if (pendingApps.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-clock"></i>
                <h3>No hay solicitudes pendientes</h3>
                <p>Todas las solicitudes han sido revisadas</p>
            </div>
        `;
        return;
    }

    let html = '<div class="pending-applications-grid">';
    
    pendingApps.forEach(app => {
        // Buscar datos completos del participante y oferta
        const participant = app.participantData || participants.find(p => p.id === app.participantId);
        const offer = app.offerData || offers.find(o => o.id === app.offerId);
        
        if (!participant || !offer) return;

        html += `
            <div class="application-review-card" style="border: 2px solid #e2e8f0; border-radius: 15px; padding: 20px; margin-bottom: 20px; background: white;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    
                    <!-- CANDIDATO -->
                    <div class="candidate-profile">
                        <h4 style="color: #c8102e; margin-bottom: 15px;">游녻 CANDIDATO</h4>
                        <div class="candidate-info">
                            <strong style="font-size: 16px;">${participant.firstName} ${participant.lastName}</strong>
                            <p><i class="fas fa-envelope"></i> ${participant.email}</p>
                            <p><i class="fas fa-phone"></i> ${participant.phone}</p>
                            <p><i class="fas fa-graduation-cap"></i> ${participant.concentration}</p>
                            <p><i class="fas fa-university"></i> ${getCampusLabel(participant.campus)} - ${participant.studyYear}춿 a침o</p>
                            <p><i class="fas fa-user-graduate"></i> Graduaci칩n: ${participant.graduationCandidate === 'yes' ? 'S칤' : 'No'}</p>
                            <p><i class="fas fa-id-card"></i> ID: ${participant.studentId}</p>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-info btn-small" onclick="viewResumeInModal('${participant.resume}', '${participant.firstName} ${participant.lastName}')">
                                游늯 Ver Resum칠
                            </button>
                        </div>
                    </div>
                    
                    <!-- OFERTA -->
                    <div class="offer-details">
                        <h4 style="color: #c8102e; margin-bottom: 15px;">游눺 OFERTA</h4>
                        <div class="offer-info">
                            <strong style="font-size: 16px;">${offer.position}</strong>
                            <p><i class="fas fa-building"></i> ${offer.companyName}</p>
                            <p><i class="fas fa-user"></i> ${offer.contactPerson}</p>
                            <p><i class="fas fa-envelope"></i> ${offer.email}</p>
                            <p><i class="fas fa-phone"></i> ${offer.phone}</p>
                            <p><i class="fas fa-map-marker-alt"></i> ${offer.location}</p>
                            <p><i class="fas fa-dollar-sign"></i> ${offer.salary}</p>
                            <p><i class="fas fa-clock"></i> ${getTypeLabel(offer.positionType)}</p>
                            <p><i class="fas fa-calendar-alt"></i> Vence: ${new Date(offer.deadline).toLocaleDateString()}</p>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-secondary btn-small" onclick="viewOfferRequirements('${offer.id}')">
                                游늶 Ver Requisitos
                            </button>
                        </div>
                    </div>
                    
                    <!-- DECISI칍N -->
                    <div class="decision-section">
                        <h4 style="color: #c8102e; margin-bottom: 15px;">游꿢 DECISI칍N</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <p><strong>Aplic칩:</strong> ${new Date(app.appliedAt).toLocaleDateString()} a las ${new Date(app.appliedAt).toLocaleTimeString()}</p>
                        </div>
                        
                        <div class="decision-buttons" style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-success" onclick="approveAndSendEmail('${app.id}')" style="width: 100%;">
                                九 APROBAR Y ENVIAR
                                <small style="display: block; font-weight: normal;">Preparar email para patrono</small>
                            </button>
                            
                            <button class="btn btn-warning" onclick="approveWithNotes('${app.id}')" style="width: 100%;">
                                游닇 APROBAR CON NOTA
                                <small style="display: block; font-weight: normal;">Agregar comentarios</small>
                            </button>
                            
                            <button class="btn btn-danger" onclick="rejectApplicationWithReason('${app.id}')" style="width: 100%;">
                                仇 RECHAZAR
                                <small style="display: block; font-weight: normal;">No cumple requisitos</small>
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label style="font-size: 12px; color: #666;">Notas del administrador:</label>
                            <textarea id="adminNotes-${app.id}" placeholder="Razones, recomendaciones..." style="width: 100%; height: 60px; font-size: 12px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // Actualizar contador de pendientes
    updatePendingCount();
}

// Funci칩n principal: Aprobar y preparar email
function approveAndSendEmail(applicationId) {
    const app = applications.find(a => a.id === applicationId);
    if (!app) return;
    
    currentApplicationForEmail = app;
    
    // Obtener datos completos
    const participant = app.participantData || participants.find(p => p.id === app.participantId);
    const offer = app.offerData || offers.find(o => o.id === app.offerId);
    const adminNotes = document.getElementById(`adminNotes-${applicationId}`).value;
    
    // Preparar datos del email
    const emailData = {
        to: offer.email,
        cc: 'carreras_colocacionescu@uagm.edu',
        subject: `Candidato referido para oferta de empleo: ${participant.firstName} ${participant.lastName} - ${offer.position}`,
        body: generateEmailBody(participant, offer, adminNotes)
    };
    
    // Mostrar modal de preparaci칩n de email
    showEmailPreparationModal(emailData, participant.resume, applicationId);
}

// Generar el cuerpo del email
function generateEmailBody(participant, offer, adminNotes = '') {
    const campusLabels = {
        'cupey': 'Recinto de Cupey',
        'bayamon': 'Centro Universitario de Bayam칩n', 
        'aguadilla': 'Centro Universitario de Aguadilla'
    };
    
    const studentTypeLabels = {
        'student': 'Estudiante',
        'alumni': 'Exalumno',
        'community': 'Comunidad'
    };
    
    return `Estimado/a ${offer.contactPerson},

Saludos cordiales desde la Oficina de Carreras y Colocaciones de la Universidad Ana G. M칠ndez Recinto de Cupey.

Le refiero candidato para la posici칩n de ${offer.position}:


Informaci칩n de candidato:
- Nombre: ${participant.firstName} ${participant.lastName}
- Email: ${participant.email}
- Tel칠fono: ${participant.phone}
- Ciudad: ${participant.city}


${adminNotes ? `游닇 NOTAS DEL EVALUADOR:
${adminNotes}

` : ''}Adjunto el resume del candidato para que sea evaluado.

游뢿uede contactar directamente al candidato a trav칠s del email o tel칠fono proporcionado.

Si necesita informaci칩n adicional o tiene alguna pregunta, no dude en contactarnos.

Cordialmente,`;
}

// Modal de preparaci칩n de email
function showEmailPreparationModal(emailData, resumeUrl, applicationId) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.id = 'emailPreparationModal';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>游닎 Preparar Email para Patrono</h3>
                <span class="close" onclick="closeEmailModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="email-preview">
                    <h4>游늶 Vista Previa del Email:</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <p><strong>Para:</strong> ${emailData.to}</p>
                        <p><strong>CC:</strong> ${emailData.cc}</p>
                        <p><strong>Asunto:</strong> ${emailData.subject}</p>
                    </div>
                    
                    <div style="background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 11px; white-space: pre-wrap;">${emailData.body}</div>
                </div>
                
                <div class="resume-section" style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                    <h4>游늹 Resum칠 del Candidato:</h4>
                    <p>El resum칠 se debe adjuntar manualmente:</p>
                    <button class="btn btn-info" onclick="downloadResumeForAttachment('${resumeUrl}')">
                        游늯 Descargar Resum칠 para Adjuntar
                    </button>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        游눠 Tip: Descarga el resum칠 primero, luego abre Outlook y adj칰ntalo manualmente.
                    </p>
                </div>
                
                <div class="instructions" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h4>游닇 Instrucciones:</h4>
                    <ol>
                        <li>Haz clic en "Descargar Resum칠" arriba</li>
                        <li>Haz clic en "Abrir Outlook" (se abrir치 con el mensaje pre-escrito)</li>
                        <li>Adjunta manualmente el resum칠 descargado</li>
                        <li>Revisa el contenido si deseas hacer cambios</li>
                        <li>Haz clic en "Enviar" en Outlook</li>
                        <li>Vuelve aqu칤 y marca como "Enviado"</li>
                    </ol>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEmailModal()">
                    Cancelar
                </button>
                <button class="btn btn-primary" onclick="openOutlookWithEmail('${encodeURIComponent(JSON.stringify(emailData))}', '${applicationId}')">
                    游닎 Abrir Outlook
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Abrir Outlook con el email preparado
function openOutlookWithEmail(encodedEmailData, applicationId) {
    const emailData = JSON.parse(decodeURIComponent(encodedEmailData));
    
    // Crear URL de mailto
    const subject = encodeURIComponent(emailData.subject);
    const body = encodeURIComponent(emailData.body);
    const to = encodeURIComponent(emailData.to);
    const cc = encodeURIComponent(emailData.cc);
    
    const mailtoUrl = `mailto:${to}?cc=${cc}&subject=${subject}&body=${body}`;
    
    // Abrir Outlook
    window.location.href = mailtoUrl;
    
    // Mostrar confirmaci칩n despu칠s de 3 segundos
    setTimeout(() => {
        showSentConfirmation(applicationId);
    }, 3000);
}

// Descargar resum칠 para adjuntar
function downloadResumeForAttachment(resumeUrl) {
    const link = document.createElement('a');
    link.href = resumeUrl;
    link.download = 'Resume_Candidato.pdf';
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('游늯 Resum칠 descargado. Ahora puedes adjuntarlo en Outlook.', 'success');
}

// Confirmaci칩n de env칤o
function showSentConfirmation(applicationId) {
    const confirmModal = document.createElement('div');
    confirmModal.className = 'modal';
    confirmModal.style.display = 'flex';
    
    confirmModal.innerHTML = `
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-body">
                <i class="fas fa-envelope" style="font-size: 48px; color: #c8102e; margin-bottom: 20px;"></i>
                <h3>쮼mail Enviado?</h3>
                <p>쮺ompletaste el env칤o del email desde Outlook?</p>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                    No, cancelar
                </button>
                <button class="btn btn-success" onclick="markApplicationAsSent('${applicationId}'); this.closest('.modal').remove();">
                    九 S칤, enviado
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(confirmModal);
}

// Marcar aplicaci칩n como enviada
async function markApplicationAsSent(applicationId) {
    try {
        // Actualizar estado en Firebase
        if (isFirebaseInitialized) {
            const snapshot = await db.collection('applications')
                .where('id', '==', applicationId)
                .get();
            
            if (!snapshot.empty) {
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.update(doc.ref, {
                        status: 'approved_sent',
                        adminReview: {
                            reviewed: true,
                            reviewedBy: 'admin@uagm.edu',
                            reviewedAt: new Date().toISOString(),
                            decision: 'approved',
                            sentAt: new Date().toISOString()
                        }
                    });
                });
                await batch.commit();
            }
        }
        
        // Actualizar en memoria local
        const application = applications.find(app => app.id === applicationId);
        if (application) {
            application.status = 'approved_sent';
            application.adminReview = {
                reviewed: true,
                reviewedBy: 'admin@uagm.edu',
                reviewedAt: new Date().toISOString(),
                decision: 'approved',
                sentAt: new Date().toISOString()
            };
        }
        
        // Crear registro de referido
        await createReferralRecord(application);
        
        // Actualizar localStorage
        localStorage.setItem('applications', JSON.stringify(applications));
        
        // Cerrar modals y actualizar interfaz
        closeEmailModal();
        loadPendingApplicationsTable();
        updateStats();
        
        showNotification('九 Email enviado y referido registrado exitosamente', 'success');
        
        // Registrar en historial
        await addToParticipantHistory(application.participantId, {
            eventType: 'referral',
            eventTitle: 'Referido a Patrono',
            description: `Fue referido a "${application.offerTitle}" en ${application.companyName}`,
            data: {
                participantName: application.participantName,
                companyName: application.companyName,
                offerTitle: application.offerTitle,
                applicationId: application.id,
                notes: application.adminReview?.notes || ''
            }
        });
        
    } catch (error) {

        console.error('Error marcando como enviado:', error);
        showNotification('Error actualizando el estado. Intenta de nuevo.', 'error');
    }
}

// Crear registro de referido
async function createReferralRecord(application) {
    const participant = application.participantData || participants.find(p => p.id === application.participantId);
    const offer = application.offerData || offers.find(o => o.id === application.offerId);
const referralData = {
       id: `ref_${Date.now()}`,
       applicationId: application.id,
       participant: {
           id: participant.id,
           name: `${participant.firstName} ${participant.lastName}`,
           email: participant.email,
           phone: participant.phone,
           studentId: participant.studentId,
           campus: participant.campus,
           concentration: participant.concentration,
           resumeUrl: participant.resume
       },
       employer: {
           companyName: offer.companyName,
           contactPerson: offer.contactPerson,
           contactEmail: offer.email,
           phone: offer.phone,
           position: offer.position
       },
       referral: {
           referredAt: new Date().toISOString(),
           emailSent: true,
           emailSentAt: new Date().toISOString(),
           resumeAttached: true,
           status: 'sent'
       },
       tracking: {
           emailOpened: false,
           resumeDownloaded: false,
           employerResponse: null,
           lastUpdated: new Date().toISOString()
       }
   };

   try {
       // Guardar en Firebase
       if (isFirebaseInitialized) {
           await FirebaseHelper.saveDoc('referrals', referralData);
       }
       
       // Guardar en localStorage
       let referrals = JSON.parse(localStorage.getItem('referrals')) || [];
       referrals.push(referralData);
       localStorage.setItem('referrals', JSON.stringify(referrals));
       
   } catch (error) {
       console.error('Error creando referido:', error);
   }
}

// Rechazar aplicaci칩n con raz칩n
function rejectApplicationWithReason(applicationId) {
   const app = applications.find(a => a.id === applicationId);
   if (!app) return;
   
   const reason = document.getElementById(`adminNotes-${applicationId}`).value;
   
   if (!reason.trim()) {
       showNotification('Por favor escribe una raz칩n para el rechazo', 'warning');
       document.getElementById(`adminNotes-${applicationId}`).focus();
       return;
   }
   
   if (confirm('쮼st치s seguro de que quieres rechazar esta solicitud?')) {
       rejectApplication(applicationId, reason);
   }
}

// Rechazar aplicaci칩n
async function rejectApplication(applicationId, reason) {
   try {
       // Actualizar en Firebase
       if (isFirebaseInitialized) {
           const snapshot = await db.collection('applications')
               .where('id', '==', applicationId)
               .get();
           
           if (!snapshot.empty) {
               const batch = db.batch();
               snapshot.docs.forEach(doc => {
                   batch.update(doc.ref, {
                       status: 'rejected',
                       adminReview: {
                           reviewed: true,
                           reviewedBy: 'admin@uagm.edu',
                           reviewedAt: new Date().toISOString(),
                           decision: 'rejected',
                           notes: reason
                       }
                   });
               });
               await batch.commit();
           }
       }
       
       // Actualizar en memoria local
       const application = applications.find(app => app.id === applicationId);
       if (application) {
           application.status = 'rejected';
           application.adminReview = {
               reviewed: true,
               reviewedBy: 'admin@uagm.edu',
               reviewedAt: new Date().toISOString(),
               decision: 'rejected',
               notes: reason
           };
       }
       
       // Actualizar localStorage
       localStorage.setItem('applications', JSON.stringify(applications));
       
       // Actualizar interfaz
       loadPendingApplicationsTable();
       updateStats();
       
       showNotification('Solicitud rechazada correctamente', 'success');
       
       // Registrar en historial
       await addToParticipantHistory(application.participantId, {
           eventType: 'rejection',
           eventTitle: 'Solicitud Rechazada',
           description: `Fue rechazado para "${application.offerTitle}" en ${application.companyName}`,
           data: {
               participantName: application.participantName,
               companyName: application.companyName,
               offerTitle: application.offerTitle,
               applicationId: application.id,
               reason: reason
           }
       });
       
   } catch (error) {

       console.error('Error rechazando aplicaci칩n:', error);
       showNotification('Error rechazando la solicitud. Intenta de nuevo.', 'error');
   }
}

// Aprobar con notas (similar al normal pero pide notas obligatorias)
function approveWithNotes(applicationId) {
   const adminNotes = document.getElementById(`adminNotes-${applicationId}`).value;
   
   if (!adminNotes.trim()) {
       showNotification('Por favor escribe notas adicionales para el patrono', 'warning');
       document.getElementById(`adminNotes-${applicationId}`).focus();
       return;
   }
   
   // Llamar a la funci칩n normal pero marcando que tiene notas
   approveAndSendEmail(applicationId);
}

// Ver resum칠 en modal
function viewResumeInModal(resumeUrl, candidateName) {
   if (!resumeUrl || resumeUrl === 'uploading...') {
       showNotification('Resum칠 no disponible', 'warning');
       return;
   }
   
   const modal = document.createElement('div');
   modal.className = 'modal';
   modal.style.display = 'flex';
   
   modal.innerHTML = `
       <div class="modal-content" style="max-width: 90%; max-height: 90%;">
           <div class="modal-header">
               <h3>游늯 Resum칠 de ${candidateName}</h3>
               <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
           </div>
           <div class="modal-body" style="text-align: center;">
               <iframe src="${resumeUrl}" style="width: 100%; height: 600px; border: none;" frameborder="0"></iframe>
               <div style="margin-top: 15px;">
                   <a href="${resumeUrl}" target="_blank" class="btn btn-primary">
                       游댕 Abrir en Nueva Pesta침a
                   </a>
                   <button class="btn btn-info" onclick="downloadResumeForAttachment('${resumeUrl}')">
                       游닌 Descargar
                   </button>
               </div>
           </div>
       </div>
   `;
   
   document.body.appendChild(modal);
}

// Ver requisitos de oferta
function viewOfferRequirements(offerId) {
   const offer = offers.find(o => o.id === offerId);
   if (!offer) return;
   
   const modal = document.createElement('div');
   modal.className = 'modal';
   modal.style.display = 'flex';
   
   modal.innerHTML = `
       <div class="modal-content" style="max-width: 600px;">
           <div class="modal-header">
               <h3>游늶 Requisitos - ${offer.position}</h3>
               <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
           </div>
           <div class="modal-body">
               <div style="margin-bottom: 20px;">
                   <h4 style="color: #c8102e;">游끽 ${offer.companyName}</h4>
                   <p><strong>Posici칩n:</strong> ${offer.position}</p>
                   <p><strong>Ubicaci칩n:</strong> ${offer.location}</p>
                   <p><strong>Salario:</strong> ${offer.salary}</p>
                   <p><strong>Tipo:</strong> ${getTypeLabel(offer.positionType)}</p>
<p><strong>Sector Industrial:</strong> ${getSectorLabel(offer.academicDivision)}</p>
               </div>
               
               <div style="margin-bottom: 20px;">
                   <h4 style="color: #c8102e;">游늶 Requisitos de la Posici칩n:</h4>
                   <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${offer.requirements}</div>
               </div>
               
               ${offer.jobDescription ? `
               <div style="margin-bottom: 20px;">
                   <h4 style="color: #c8102e;">游닇 Descripci칩n del Puesto:</h4>
                   <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${offer.jobDescription}</div>
               </div>
               ` : ''}
               
               ${offer.schedule ? `
               <div style="margin-bottom: 20px;">
                   <h4 style="color: #c8102e;">낋 Horarios:</h4>
                   <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${offer.schedule}</div>
               </div>
               ` : ''}
           </div>
           <div class="modal-footer">
               <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cerrar</button>
           </div>
       </div>
   `;
   
   document.body.appendChild(modal);
}

// Cerrar modal de email
function closeEmailModal() {
   const modal = document.getElementById('emailPreparationModal');
   if (modal) {
       modal.remove();
   }
   // Tambi칠n cerrar cualquier otro modal de email
   document.querySelectorAll('.modal').forEach(modal => {
       if (modal.innerHTML.includes('Preparar Email')) {
           modal.remove();
       }
   });
}

// Filtrar aplicaciones pendientes
function filterPendingApplications() {
   const search = document.getElementById('pendingSearch').value.toLowerCase();
   const dateFilter = document.getElementById('pendingDateFilter').value;
   
   let filteredApps = applications.filter(app => app.status === 'pending');
   
   // Filtro de b칰squeda
   if (search) {
       filteredApps = filteredApps.filter(app => {
           const participant = app.participantData || participants.find(p => p.id === app.participantId);
           const offer = app.offerData || offers.find(o => o.id === app.offerId);
           
           if (!participant || !offer) return false;
           
           return (
               `${participant.firstName} ${participant.lastName}`.toLowerCase().includes(search) ||
               participant.email.toLowerCase().includes(search) ||
               participant.concentration.toLowerCase().includes(search) ||
               offer.companyName.toLowerCase().includes(search) ||
               offer.position.toLowerCase().includes(search)
           );
       });
   }
   
   // Filtro de fecha
   if (dateFilter) {
       const today = new Date();
       filteredApps = filteredApps.filter(app => {
           const appDate = new Date(app.appliedAt);
           
           switch(dateFilter) {
               case 'today':
                   return appDate.toDateString() === today.toDateString();
               case 'week':
                   const weekAgo = new Date(today);
                   weekAgo.setDate(today.getDate() - 7);
                   return appDate >= weekAgo;
               case 'month':
                   return appDate.getMonth() === today.getMonth() && 
                          appDate.getFullYear() === today.getFullYear();
               default:
                   return true;
           }
       });
   }
   
   // Actualizar la vista con los resultados filtrados
   displayFilteredPendingApplications(filteredApps);
}

// Mostrar aplicaciones pendientes filtradas
function displayFilteredPendingApplications(filteredApps) {
   const container = document.getElementById('pendingApplicationsContainer');
   
   if (filteredApps.length === 0) {
       container.innerHTML = `
           <div class="no-data">
               <i class="fas fa-search"></i>
               <h3>No se encontraron solicitudes</h3>
               <p>No hay solicitudes pendientes que coincidan con los filtros</p>
           </div>
       `;
       return;
   }
   
   // Reutilizar la misma l칩gica de loadPendingApplicationsTable pero con filteredApps
   let html = '<div class="pending-applications-grid">';
   
   filteredApps.forEach(app => {
       const participant = app.participantData || participants.find(p => p.id === app.participantId);
       const offer = app.offerData || offers.find(o => o.id === app.offerId);
       
       if (!participant || !offer) return;

       html += `
           <div class="application-review-card" style="border: 2px solid #e2e8f0; border-radius: 15px; padding: 20px; margin-bottom: 20px; background: white;">
               <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                   
                   <!-- CANDIDATO -->
                   <div class="candidate-profile">
                       <h4 style="color: #c8102e; margin-bottom: 15px;">游녻 CANDIDATO</h4>
                       <div class="candidate-info">
                           <strong style="font-size: 16px;">${participant.firstName} ${participant.lastName}</strong>
                           <p><i class="fas fa-envelope"></i> ${participant.email}</p>
                           <p><i class="fas fa-phone"></i> ${participant.phone}</p>
                           <p><i class="fas fa-graduation-cap"></i> ${participant.concentration}</p>
                           <p><i class="fas fa-university"></i> ${getCampusLabel(participant.campus)} - ${participant.studyYear}춿 a침o</p>
                           <p><i class="fas fa-user-graduate"></i> Graduaci칩n: ${participant.graduationCandidate === 'yes' ? 'S칤' : 'No'}</p>
                           <p><i class="fas fa-id-card"></i> ID: ${participant.studentId}</p>
                       </div>
                       
                       <div style="margin-top: 15px;">
                           <button class="btn btn-info btn-small" onclick="viewResumeInModal('${participant.resume}', '${participant.firstName} ${participant.lastName}')">
                               游늯 Ver Resum칠
                           </button>
                       </div>
                   </div>
                   
                   <!-- OFERTA -->
                   <div class="offer-details">
                       <h4 style="color: #c8102e; margin-bottom: 15px;">游눺 OFERTA</h4>
                       <div class="offer-info">
                           <strong style="font-size: 16px;">${offer.position}</strong>
                           <p><i class="fas fa-building"></i> ${offer.companyName}</p>
                           <p><i class="fas fa-user"></i> ${offer.contactPerson}</p>
                           <p><i class="fas fa-envelope"></i> ${offer.email}</p>
                           <p><i class="fas fa-phone"></i> ${offer.phone}</p>
                           <p><i class="fas fa-map-marker-alt"></i> ${offer.location}</p>
                           <p><i class="fas fa-dollar-sign"></i> ${offer.salary}</p>
                           <p><i class="fas fa-clock"></i> ${getTypeLabel(offer.positionType)}</p>
                           <p><i class="fas fa-calendar-alt"></i> Vence: ${new Date(offer.deadline).toLocaleDateString()}</p>
                       </div>
                       
                       <div style="margin-top: 15px;">
                           <button class="btn btn-secondary btn-small" onclick="viewOfferRequirements('${offer.id}')">
                               游늶 Ver Requisitos
                           </button>
                       </div>
                   </div>
                   
                   <!-- DECISI칍N -->
                   <div class="decision-section">
                       <h4 style="color: #c8102e; margin-bottom: 15px;">游꿢 DECISI칍N</h4>
                       
                       <div style="margin-bottom: 15px;">
                           <p><strong>Aplic칩:</strong> ${new Date(app.appliedAt).toLocaleDateString()} a las ${new Date(app.appliedAt).toLocaleTimeString()}</p>
                       </div>
                       
                       <div class="decision-buttons" style="display: flex; flex-direction: column; gap: 10px;">
                           <button class="btn btn-success" onclick="approveAndSendEmail('${app.id}')" style="width: 100%;">
                               九 APROBAR Y ENVIAR
                               <small style="display: block; font-weight: normal;">Preparar email para patrono</small>
                           </button>
                           
                           <button class="btn btn-warning" onclick="approveWithNotes('${app.id}')" style="width: 100%;">
                               游닇 APROBAR CON NOTA
                               <small style="display: block; font-weight: normal;">Agregar comentarios</small>
                           </button>
                           
                           <button class="btn btn-danger" onclick="rejectApplicationWithReason('${app.id}')" style="width: 100%;">
                               仇 RECHAZAR
                               <small style="display: block; font-weight: normal;">No cumple requisitos</small>
                           </button>
                       </div>
                       
                       <div style="margin-top: 15px;">
                           <label style="font-size: 12px; color: #666;">Notas del administrador:</label>
                           <textarea id="adminNotes-${app.id}" placeholder="Razones, recomendaciones..." style="width: 100%; height: 60px; font-size: 12px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                       </div>
                   </div>
               </div>
           </div>
       `;
   });
   
   html += '</div>';
   container.innerHTML = html;
}

// Actualizar contador de pendientes
function updatePendingCount() {
   const pendingCount = applications.filter(app => app.status === 'pending').length;
   const badge = document.getElementById('pendingCount');
   
   if (pendingCount > 0) {
       badge.textContent = pendingCount;
       badge.style.display = 'inline';
   } else {
       badge.style.display = 'none';
   }
}

// Exportar datos pendientes
function exportPendingData() {
   const pendingApps = applications.filter(app => app.status === 'pending');
   
   if (pendingApps.length === 0) {
       showNotification('No hay solicitudes pendientes para exportar', 'warning');
       return;
   }

   const data = pendingApps.map(app => {
       const participant = app.participantData || participants.find(p => p.id === app.participantId);
       const offer = app.offerData || offers.find(o => o.id === app.offerId);
       
       return {
           'Fecha Solicitud': new Date(app.appliedAt).toLocaleDateString(),
           'Participante': `${participant.firstName} ${participant.lastName}`,
           'Email': participant.email,
           'Tel칠fono': participant.phone,
           'Concentraci칩n': participant.concentration,
           'Recinto': participant.campus,
           'A침o': participant.studyYear,
           'Empresa': offer.companyName,
           'Posici칩n': offer.position,
           'Contacto Empresa': offer.contactPerson,
           'Email Empresa': offer.email,
           'Estado': 'Pendiente Revisi칩n'
       };
   });

   const ws = XLSX.utils.json_to_sheet(data);
   const wb = XLSX.utils.book_new();
   XLSX.utils.book_append_sheet(wb, ws, "Solicitudes Pendientes");
   
   const filename = `Solicitudes_Pendientes_${new Date().toISOString().split('T')[0]}.xlsx`;
   XLSX.writeFile(wb, filename);
   
   showNotification('Solicitudes pendientes exportadas exitosamente', 'success');
}

// Funci칩n auxiliar para obtener etiqueta del campus
function getCampusLabel(campus) {
   const labels = {
       'cupey': 'Cupey',
       'bayamon': 'Bayam칩n',
       'aguadilla': 'Aguadilla'
   };
   return labels[campus] || campus;
}

// ============= FIN DE NUEVAS FUNCIONES =============

// Funci칩n para obtener etiqueta del tipo de estudiante
function getStudentTypeLabel(type) {
    const labels = {
        'student': 'Estudiante',
        'alumni': 'Exalumno',
        'community': 'Comunidad'
    };
    return labels[type] || type || 'N/A';
}

// Funci칩n para obtener datos del participante
function getParticipantData(participantId) {
    return participants.find(p => p.id === participantId) || null;
}

// Funci칩n para ver detalles de referido
function viewReferralDetails(applicationId) {
    const application = applications.find(app => app.id === applicationId);
    if (!application) return;
    
    const participant = getParticipantData(application.participantId);
    const offer = offers.find(o => o.id === application.offerId);
    
    document.getElementById('modalTitle').textContent = `Referido: ${application.participantName}`;
    document.getElementById('modalBody').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
            <div>
                <h4 style="color: #c8102e; margin-bottom: 15px;">游닋 Estado del Referido</h4>
                <p><strong>Estado:</strong> <span class="status-badge status-approved">Enviado al Patrono</span></p>
                <p><strong>Enviado:</strong> ${application.adminReview?.sentAt ? new Date(application.adminReview.sentAt).toLocaleString() : 'N/A'}</p>
                <p><strong>Empresa:</strong> ${application.companyName}</p>
                <p><strong>Posici칩n:</strong> ${application.offerTitle}</p>
                <p><strong>Email Patrono:</strong> ${offer?.email || 'N/A'}</p>
            </div>
            <div>
                <h4 style="color: #c8102e; margin-bottom: 15px;">游녻 Datos del Candidato</h4>
                <p><strong>Nombre:</strong> ${application.participantName}</p>
                <p><strong>Tipo:</strong> ${getStudentTypeLabel(participant?.studentType)}</p>
                <p><strong>Concentraci칩n:</strong> ${participant?.concentration || 'N/A'}</p>
                <p><strong>Email:</strong> ${application.participantEmail}</p>
                <p><strong>Tel칠fono:</strong> ${application.participantPhone}</p>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
            <h4 style="color: #28a745; margin-bottom: 10px;">九 Acciones Completadas</h4>
            <p>九 Candidato pre-evaluado por UAGM</p>
            <p>九 Email enviado al patrono con resum칠 adjunto</p>
            <p>九 Datos de contacto proporcionados</p>
        </div>
        
        <div style="text-align: center; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <h4 style="color: #2d3748; margin-bottom: 15px;">游늯 Descargar Historial</h4>
            <button class="btn btn-success" onclick="generateReferralPDF('${application.id}')">
                <i class="fas fa-file-pdf"></i> Descargar PDF del Referido
            </button>
            <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                Este documento se puede agregar al expediente del estudiante
            </p>
        </div>
    `;
    
    document.getElementById('detailsModal').style.display = 'flex';
}


// Ver detalles de rechazo
function viewRejectionDetails(applicationId) {
    const application = applications.find(app => app.id === applicationId);
    if (!application) return;
    
    const participant = getParticipantData(application.participantId);
    const offer = offers.find(o => o.id === application.offerId);
    
    document.getElementById('modalTitle').textContent = `Solicitud Rechazada: ${application.participantName}`;
    document.getElementById('modalBody').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
            <div>
                <h4 style="color: #dc3545; margin-bottom: 15px;">仇 Estado del Rechazo</h4>
                <p><strong>Estado:</strong> <span class="status-badge status-expired">Rechazada</span></p>
                <p><strong>Rechazada el:</strong> ${application.adminReview?.reviewedAt ? new Date(application.adminReview.reviewedAt).toLocaleString() : 'N/A'}</p>
                <p><strong>Revisada por:</strong> ${application.adminReview?.reviewedBy || 'Administrador'}</p>
                <p><strong>Empresa:</strong> ${application.companyName}</p>
                <p><strong>Posici칩n:</strong> ${application.offerTitle}</p>
            </div>
            <div>
                <h4 style="color: #dc3545; margin-bottom: 15px;">游녻 Datos del Candidato</h4>
                <p><strong>Nombre:</strong> ${application.participantName}</p>
                <p><strong>Tipo:</strong> ${getStudentTypeLabel(participant?.studentType)}</p>
                <p><strong>Concentraci칩n:</strong> ${participant?.concentration || 'N/A'}</p>
                <p><strong>Email:</strong> ${application.participantEmail}</p>
                <p><strong>Tel칠fono:</strong> ${application.participantPhone}</p>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding: 15px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
            <h4 style="color: #721c24; margin-bottom: 10px;">游닇 Raz칩n del Rechazo</h4>
            <p style="color: #721c24; white-space: pre-wrap;">${application.adminReview?.notes || 'No se proporcion칩 una raz칩n espec칤fica.'}</p>
        </div>
        
        <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
            <h4 style="color: #856404; margin-bottom: 10px;">좶잺 Informaci칩n Adicional</h4>
            <p> Esta solicitud fue evaluada y no cumpl칤a con los requisitos</p>
            <p> El candidato puede aplicar a otras ofertas disponibles</p>
            <p> Se recomienda revisar los requisitos antes de futuras aplicaciones</p>
        </div>
        
        <div style="text-align: center; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <h4 style="color: #2d3748; margin-bottom: 15px;">游늯 Descargar Historial</h4>
            <button class="btn btn-danger" onclick="generateRejectionPDF('${application.id}')">
                <i class="fas fa-file-pdf"></i> Descargar PDF del Rechazo
            </button>
            <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                Este documento se puede agregar al expediente del estudiante
            </p>
        </div>
    `;
    
    document.getElementById('detailsModal').style.display = 'flex';
}


// ============= FUNCIONES PARA M칍DULO DE COLOCADOS =============

// Cargar tabla de colocados
function loadPlacementsTable() {
    const container = document.getElementById('placementsTableContainer');
    
    if (placements.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-trophy"></i>
                <h3>No hay colocados registrados</h3>
                <p>Los participantes colocados aparecer치n aqu칤</p>
            </div>
        `;
        return;
    }

    let html = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Fecha Colocaci칩n</th>
                    <th>Participante</th>
                    <th>Empresa</th>
                    <th>Posici칩n</th>
                    <th>Tipo Colocaci칩n</th>
                    <th>Modalidad</th>
                    <th>Grado</th>
                    <th>Divisi칩n</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
    `;

    placements.forEach(placement => {
        const trackingTypeLabels = {
            'directo': 'Seguimiento Directo',
            'indirecto': 'Seguimiento Indirecto'
        };

        const positionTypeLabels = {
            'part-time': 'Part Time',
            'full-time': 'Full Time'
        };

        const modalityLabels = {
            'regular': 'Regular',
            'temporera': 'Temporera'
        };

        const degreeLabels = {
            'bachillerato': 'Bachillerato',
            'maestria': 'Maestr칤a',
            'asociado': 'Grado Asociado',
            'doctorado': 'Doctorado',
            'cuarto': 'Cuarto A침o',
            'certificado': 'Certificado T칠cnico',
            '11mo': '11mo o menos'
        };

        const divisionLabels = {
            'liberales': 'Artes Liberales',
            'negocios': 'Negocios',
            'tecnologia': 'Ciencias y Tecnolog칤a',
            'salud': 'Ciencias de la Salud',
            'tecnicos': 'Programas T칠cnicos'
        };

        html += `
            <tr>
                <td>${formatLocalDate(placement.placementDate)}</td>
                <td><strong>${placement.participantName}</strong><br><small>${placement.email || 'Sin email'}</small></td>
                <td>${placement.company}</td>
                <td>${placement.position}<br><small>${positionTypeLabels[placement.positionType]} - ${modalityLabels[placement.modality]}</small></td>
                <td><span class="status-badge ${placement.trackingType === 'directo' ? 'status-approved' : 'status-active'}">${trackingTypeLabels[placement.trackingType]}</span></td>
                <td>${modalityLabels[placement.modality]}</td>
                <td>${degreeLabels[placement.degree]}</td>
                <td>${divisionLabels[placement.division]}</td>
                <td>
                    <div class="actions">
                        <button class="btn btn-info btn-small" onclick="viewPlacementDetails('${placement.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning btn-small" onclick="editPlacement('${placement.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deletePlacement('${placement.id}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

// Mostrar modal para agregar colocado
function showAddPlacementModal() {
    document.getElementById('placementModalTitle').textContent = 'Registrar Nuevo Colocado';
    document.getElementById('placementForm').reset();
    
    // Ocultar campos de estudiante por defecto
    document.getElementById('studentIdGroup').style.display = 'none';
    document.getElementById('graduationDateGroup').style.display = 'none';
    
    document.getElementById('placementModal').style.display = 'flex';
}

// Cerrar modal de colocado
function closePlacementModal() {
    document.getElementById('placementModal').style.display = 'none';
    document.getElementById('placementForm').reset();
}

// Alternar campos de estudiante
function toggleStudentFields() {
    const personType = document.getElementById('placement-personType').value;
    const studentIdGroup = document.getElementById('studentIdGroup');
    const graduationDateGroup = document.getElementById('graduationDateGroup');
    const graduationDateLabel = document.getElementById('graduationDateLabel');
    const graduationDateInput = document.getElementById('placement-graduationDate');
    
    if (personType === 'estudiante') {
        studentIdGroup.style.display = 'block';
        graduationDateGroup.style.display = 'block';
        graduationDateLabel.textContent = 'Fecha de graduaci칩n (estimada)';
        document.getElementById('placement-studentId').required = true;
        graduationDateInput.required = false;
    } else if (personType === 'exalumno') {
        studentIdGroup.style.display = 'none';
        graduationDateGroup.style.display = 'block';
        graduationDateLabel.textContent = 'Fecha de graduaci칩n *';
        document.getElementById('placement-studentId').required = false;
        document.getElementById('placement-studentId').value = '';
        graduationDateInput.required = true;
    } else {
        studentIdGroup.style.display = 'none';
        graduationDateGroup.style.display = 'none';
        document.getElementById('placement-studentId').required = false;
        graduationDateInput.required = false;
        document.getElementById('placement-studentId').value = '';
        graduationDateInput.value = '';
    }
}

// Guardar colocado
async function savePlacement() {
    const form = document.getElementById('placementForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Recopilar datos del formulario
    const placementData = {
        id: `placement_${Date.now()}`,
        participantName: document.getElementById('placement-participantName').value,
        email: document.getElementById('placement-email').value,
        company: document.getElementById('placement-company').value,
        position: document.getElementById('placement-position').value,
        placementDate: document.getElementById('placement-date').value,
        trackingType: document.getElementById('placement-trackingType').value,
        positionType: document.getElementById('placement-positionType').value,
        modality: document.getElementById('placement-modality').value,
        personType: document.getElementById('placement-personType').value,
        studentId: document.getElementById('placement-studentId').value,
        degree: document.getElementById('placement-degree').value,
        concentration: document.getElementById('placement-concentration').value,
        division: document.getElementById('placement-division').value,
        graduationDate: document.getElementById('placement-graduationDate').value,
        notes: document.getElementById('placement-notes').value,
        createdAt: new Date().toISOString(),
        createdBy: 'admin@uagm.edu'
    };
    
    try {
        // Guardar en Firebase
        if (isFirebaseInitialized) {
            await db.collection('placements').add(placementData);
            console.log('Colocado guardado en Firebase:', placementData.id);
        }
        
        // Agregar a memoria local
        placements.push(placementData);
        
        // Guardar en localStorage como respaldo
        localStorage.setItem('placements', JSON.stringify(placements));
        
        // Actualizar interfaz
        loadPlacementsTable();
        updateStats();
        closePlacementModal();
        
        showNotification('Colocado registrado exitosamente', 'success');
        
        // Registrar en historial
        const participant = participants.find(p => 
            p.email === placementData.email || 
            (p.firstName === placementData.participantName.split(' ')[0] && 
             p.lastName === placementData.participantName.split(' ').slice(1).join(' '))
        );
        
        if (participant) {
            await addToParticipantHistory(participant.id, {
                eventType: 'placement',
                eventTitle: 'Colocado',
                description: `Colocado en ${placementData.company} como ${placementData.position}`,
                data: {
                    participantName: placementData.participantName,
                    company: placementData.company,
                    position: placementData.position,
                    placementDate: placementData.placementDate,
                    trackingType: placementData.trackingType,
                    positionType: placementData.positionType,
                    modality: placementData.modality,
                    placementId: placementData.id
                }
            });
        }
        
    } catch (error) {

        console.error('Error guardando colocado:', error);
        showNotification('Error guardando el colocado. Intenta de nuevo.', 'error');
    }
}

// Ver detalles de colocado
function viewPlacementDetails(placementId) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;

    const trackingTypeLabels = {
        'directo': 'Seguimiento Directo',
        'indirecto': 'Seguimiento Indirecto'
    };

    const positionTypeLabels = {
        'part-time': 'Part Time',
        'full-time': 'Full Time'
    };

    const modalityLabels = {
        'regular': 'Posici칩n Regular',
        'temporera': 'Posici칩n Temporera'
    };

    const degreeLabels = {
        'bachillerato': 'Bachillerato',
        'maestria': 'Maestr칤a',
        'asociado': 'Grado Asociado',
        'doctorado': 'Doctorado',
        'cuarto': 'Cuarto A침o',
        'certificado': 'Certificado T칠cnico',
        '11mo': '11mo o menos'
    };

    const divisionLabels = {
        'liberales': 'Artes Liberales',
        'negocios': 'Negocios',
        'tecnologia': 'Ciencias y Tecnolog칤a',
        'salud': 'Ciencias de la Salud',
        'tecnicos': 'Programas T칠cnicos'
    };

    const personTypeLabels = {
        'estudiante': 'Estudiante',
        'exalumno': 'Exalumno',
        'comunidad': 'Comunidad'
    };

    document.getElementById('modalTitle').textContent = `Colocado: ${placement.participantName}`;
    document.getElementById('modalBody').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
            <div>
                <h4 style="color: #28a745; margin-bottom: 15px;">游녻 Informaci칩n Personal</h4>
                <p><strong>Nombre:</strong> ${placement.participantName}</p>
                <p><strong>Email:</strong> ${placement.email || 'No proporcionado'}</p>
                <p><strong>Tipo:</strong> ${personTypeLabels[placement.personType]}</p>
                ${placement.studentId ? `<p><strong>ID Estudiante:</strong> ${placement.studentId}</p>` : ''}
                ${placement.graduationDate ? `<p><strong>Fecha Graduaci칩n:</strong> ${formatLocalDate(placement.graduationDate)}</p>` : ''}
            </div>
            <div>
                <h4 style="color: #28a745; margin-bottom: 15px;">游끽 Informaci칩n del Empleo</h4>
                <p><strong>Empresa:</strong> ${placement.company}</p>
                <p><strong>Posici칩n:</strong> ${placement.position}</p>
                <p><strong>Fecha Colocaci칩n:</strong> ${formatLocalDate(placement.placementDate)}</p>
                <p><strong>Tipo:</strong> ${positionTypeLabels[placement.positionType]}</p>
                <p><strong>Modalidad:</strong> ${modalityLabels[placement.modality]}</p>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
            <div>
                <h4 style="color: #28a745; margin-bottom: 15px;">游꿉 Informaci칩n Acad칠mica</h4>
                <p><strong>Grado:</strong> ${degreeLabels[placement.degree]}</p>
                <p><strong>Concentraci칩n:</strong> ${placement.concentration}</p>
                <p><strong>Divisi칩n:</strong> ${divisionLabels[placement.division]}</p>
            </div>
            <div>
                <h4 style="color: #28a745; margin-bottom: 15px;">游늶 Seguimiento</h4>
                <p><strong>Tipo de Colocaci칩n:</strong> <span class="status-badge ${placement.trackingType === 'directo' ? 'status-approved' : 'status-active'}">${trackingTypeLabels[placement.trackingType]}</span></p>
                <p><strong>Registrado:</strong> ${new Date(placement.createdAt).toLocaleDateString('es-ES')}</p>
                <p><strong>Por:</strong> ${placement.createdBy}</p>
            </div>
        </div>
        
        ${placement.notes ? `
        <div style="margin-bottom: 20px;">
            <h4 style="color: #28a745; margin-bottom: 10px;">游닇 Notas Adicionales</h4>
            <p style="background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${placement.notes}</p>
        </div>
        ` : ''}
    `;

    document.getElementById('detailsModal').style.display = 'flex';
}

// Editar colocado
function editPlacement(placementId) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;

    // Cambiar t칤tulo del modal
    document.getElementById('placementModalTitle').textContent = 'Editar Colocado';
    
    // Llenar formulario con datos existentes
    document.getElementById('placement-participantName').value = placement.participantName;
    document.getElementById('placement-email').value = placement.email || '';
    document.getElementById('placement-company').value = placement.company;
    document.getElementById('placement-position').value = placement.position;
    document.getElementById('placement-date').value = placement.placementDate;
    document.getElementById('placement-trackingType').value = placement.trackingType;
    document.getElementById('placement-positionType').value = placement.positionType;
    document.getElementById('placement-modality').value = placement.modality;
    document.getElementById('placement-personType').value = placement.personType;
    document.getElementById('placement-studentId').value = placement.studentId || '';
    document.getElementById('placement-degree').value = placement.degree;
    document.getElementById('placement-concentration').value = placement.concentration;
    document.getElementById('placement-division').value = placement.division;
    document.getElementById('placement-graduationDate').value = placement.graduationDate || '';
    document.getElementById('placement-notes').value = placement.notes || '';
    
    // Mostrar/ocultar campos seg칰n tipo de persona
    toggleStudentFields();
    
    // Cambiar funci칩n del bot칩n guardar
    const saveButton = document.querySelector('#placementModal .btn-success');
    saveButton.innerHTML = '<i class="fas fa-save"></i> Actualizar Colocado';
    saveButton.onclick = () => updatePlacement(placementId);
    
    document.getElementById('placementModal').style.display = 'flex';
}

// Actualizar colocado existente
async function updatePlacement(placementId) {
    const form = document.getElementById('placementForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const updatedData = {
        participantName: document.getElementById('placement-participantName').value,
        email: document.getElementById('placement-email').value,
        company: document.getElementById('placement-company').value,
        position: document.getElementById('placement-position').value,
        placementDate: document.getElementById('placement-date').value,
        trackingType: document.getElementById('placement-trackingType').value,
        positionType: document.getElementById('placement-positionType').value,
        modality: document.getElementById('placement-modality').value,
        personType: document.getElementById('placement-personType').value,
        studentId: document.getElementById('placement-studentId').value,
        degree: document.getElementById('placement-degree').value,
        concentration: document.getElementById('placement-concentration').value,
        division: document.getElementById('placement-division').value,
        graduationDate: document.getElementById('placement-graduationDate').value,
        notes: document.getElementById('placement-notes').value,
        updatedAt: new Date().toISOString()
    };
    
    try {
        // Actualizar en Firebase
        if (isFirebaseInitialized) {
            const snapshot = await db.collection('placements')
                .where('id', '==', placementId)
                .get();
            
            if (!snapshot.empty) {
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.update(doc.ref, updatedData);
                });
                await batch.commit();
                console.log('Colocado actualizado en Firebase:', placementId);
            }
        }
        
        // Actualizar en memoria local
        const placementIndex = placements.findIndex(p => p.id === placementId);
        if (placementIndex !== -1) {
            placements[placementIndex] = { ...placements[placementIndex], ...updatedData };
        }
        
        // Actualizar localStorage
        localStorage.setItem('placements', JSON.stringify(placements));
        
        // Restaurar bot칩n y cerrar modal
        const saveButton = document.querySelector('#placementModal .btn-success');
        saveButton.innerHTML = '<i class="fas fa-save"></i> Guardar Colocado';
        saveButton.onclick = savePlacement;
        
        // Actualizar interfaz
        loadPlacementsTable();
        updateStats();
        closePlacementModal();
        
        showNotification('Colocado actualizado exitosamente', 'success');
        
    } catch (error) {
        console.error('Error actualizando colocado:', error);
        showNotification('Error actualizando el colocado. Intenta de nuevo.', 'error');
    }
}

// Eliminar colocado
async function deletePlacement(placementId) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;
    
    if (confirm(`쮼st치s seguro de que quieres eliminar el registro de colocaci칩n de "${placement.participantName}"?`)) {
        try {
            // Eliminar de Firebase
            if (isFirebaseInitialized) {
                const snapshot = await db.collection('placements')
                    .where('id', '==', placementId)
                    .get();
                
                if (!snapshot.empty) {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    console.log('Colocado eliminado de Firebase:', placementId);
                }
            }
            
            // Eliminar de memoria local
            placements = placements.filter(p => p.id !== placementId);
            
            // Actualizar localStorage
            localStorage.setItem('placements', JSON.stringify(placements));
            
            // Actualizar interfaz
            filterPlacements();
            updateStats();
            
            showNotification('Colocado eliminado exitosamente', 'success');
            
        } catch (error) {
            console.error('Error eliminando colocado:', error);
            showNotification('Error eliminando el colocado. Intenta de nuevo.', 'error');
        }
    }
}

// Filtrar colocados
function filterPlacements() {
    // Guardar valores actuales de los filtros
    currentFilters.placements.search = document.getElementById('placementsSearch').value.toLowerCase();
    currentFilters.placements.type = document.getElementById('placementsTypeFilter').value;
    currentFilters.placements.date = document.getElementById('placementsDateFilter').value;
    
    let filteredPlacements = placements;
    
    // Filtro de b칰squeda
    if (currentFilters.placements.search) {
        filteredPlacements = filteredPlacements.filter(placement => 
            placement.participantName.toLowerCase().includes(currentFilters.placements.search) ||
            placement.company.toLowerCase().includes(currentFilters.placements.search) ||
            placement.position.toLowerCase().includes(currentFilters.placements.search) ||
            placement.concentration.toLowerCase().includes(currentFilters.placements.search) ||
            (placement.email && placement.email.toLowerCase().includes(currentFilters.placements.search))
        );
    }
    
    // Filtro de tipo
    if (currentFilters.placements.type) {
        filteredPlacements = filteredPlacements.filter(placement => 
            placement.trackingType === currentFilters.placements.type
        );
    }
    
    // Filtro de fecha
    if (currentFilters.placements.date) {
        const today = new Date();
        filteredPlacements = filteredPlacements.filter(placement => {
            const placementDate = new Date(placement.placementDate);
            
            switch(currentFilters.placements.date) {
                case 'month':
                    return placementDate.getMonth() === today.getMonth() && 
                           placementDate.getFullYear() === today.getFullYear();
                case 'quarter':
                    const currentQuarter = Math.floor(today.getMonth() / 3);
                    const placementQuarter = Math.floor(placementDate.getMonth() / 3);
                    return placementQuarter === currentQuarter && 
                           placementDate.getFullYear() === today.getFullYear();
                case 'year':
                    return placementDate.getFullYear() === today.getFullYear();
                default:
                    return true;
            }
        });
    }
    
    displayFilteredPlacements(filteredPlacements);
}

// Mostrar colocados filtrados
function displayFilteredPlacements(filteredPlacements) {
    const container = document.getElementById('placementsTableContainer');
    
    if (filteredPlacements.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-search"></i>
                <h3>No se encontraron colocados</h3>
                <p>No hay colocados que coincidan con los filtros aplicados</p>
            </div>
        `;
        return;
    }

    let html = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Fecha Colocaci칩n</th>
                    <th>Participante</th>
                    <th>Empresa</th>
                    <th>Posici칩n</th>
                    <th>Tipo Colocaci칩n</th>
                    <th>Modalidad</th>
                    <th>Grado</th>
                    <th>Divisi칩n</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
    `;

    filteredPlacements.forEach(placement => {
        const trackingTypeLabels = {
            'directo': 'Seguimiento Directo',
            'indirecto': 'Seguimiento Indirecto'
        };

        const positionTypeLabels = {
            'part-time': 'Part Time',
            'full-time': 'Full Time'
        };

        const modalityLabels = {
            'regular': 'Regular',
            'temporera': 'Temporera'
        };

        const degreeLabels = {
            'bachillerato': 'Bachillerato',
            'maestria': 'Maestr칤a',
            'asociado': 'Grado Asociado',
            'doctorado': 'Doctorado',
            'cuarto': 'Cuarto A침o',
            'certificado': 'Certificado T칠cnico',
            '11mo': '11mo o menos'
        };

        const divisionLabels = {
            'liberales': 'Artes Liberales',
            'negocios': 'Negocios',
            'tecnologia': 'Ciencias y Tecnolog칤a',
            'salud': 'Ciencias de la Salud',
            'tecnicos': 'Programas T칠cnicos'
        };

        html += `
            <tr>
                <td>${formatLocalDate(placement.placementDate)}</td>
                <td><strong>${placement.participantName}</strong><br><small>${placement.email || 'Sin email'}</small></td>
                <td>${placement.company}</td>
                <td>${placement.position}<br><small>${positionTypeLabels[placement.positionType]} - ${modalityLabels[placement.modality]}</small></td>
                <td><span class="status-badge ${placement.trackingType === 'directo' ? 'status-approved' : 'status-active'}">${trackingTypeLabels[placement.trackingType]}</span></td>
                <td>${modalityLabels[placement.modality]}</td>
                <td>${degreeLabels[placement.degree]}</td>
                <td>${divisionLabels[placement.division]}</td>
                <td>
                    <div class="actions">
                        <button class="btn btn-info btn-small" onclick="viewPlacementDetails('${placement.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning btn-small" onclick="editPlacement('${placement.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deletePlacement('${placement.id}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

// Exportar datos de colocados
function exportPlacementsData() {
    if (placements.length === 0) {
        showNotification('No hay colocados para exportar', 'warning');
        return;
    }

    const data = placements.map(placement => {
        const trackingTypeLabels = {
            'directo': 'Seguimiento Directo',
            'indirecto': 'Seguimiento Indirecto'
        };

        const positionTypeLabels = {
            'part-time': 'Part Time',
            'full-time': 'Full Time'
        };

        const modalityLabels = {
            'regular': 'Posici칩n Regular',
            'temporera': 'Posici칩n Temporera'
        };

        const degreeLabels = {
            'bachillerato': 'Bachillerato',
            'maestria': 'Maestr칤a',
            'asociado': 'Grado Asociado',
            'doctorado': 'Doctorado',
            'cuarto': 'Cuarto A침o',
            'certificado': 'Certificado T칠cnico',
            '11mo': '11mo o menos'
        };

        const divisionLabels = {
            'liberales': 'Artes Liberales',
            'negocios': 'Negocios',
            'tecnologia': 'Ciencias y Tecnolog칤a',
            'salud': 'Ciencias de la Salud',
            'tecnicos': 'Programas T칠cnicos'
        };

        const personTypeLabels = {
            'estudiante': 'Estudiante',
            'exalumno': 'Exalumno',
            'comunidad': 'Comunidad'
        };

        return {
            'Fecha Colocaci칩n': formatLocalDate(placement.placementDate),
            'Participante': placement.participantName,
            'Email': placement.email || 'No proporcionado',
            'Empresa': placement.company,
            'Posici칩n': placement.position,
            'Tipo Colocaci칩n': trackingTypeLabels[placement.trackingType],
            'Tipo Posici칩n': positionTypeLabels[placement.positionType],
            'Modalidad': modalityLabels[placement.modality],
            'Tipo Persona': personTypeLabels[placement.personType],
            'ID Estudiante': placement.studentId || 'N/A',
            'Grado': degreeLabels[placement.degree],
            'Concentraci칩n': placement.concentration,
            'Divisi칩n Acad칠mica': divisionLabels[placement.division],
            'Fecha Graduaci칩n': placement.graduationDate ? formatLocalDate(placement.graduationDate) : 'N/A',
            'Notas': placement.notes || 'N/A',
            'Fecha Registro': new Date(placement.createdAt).toLocaleDateString('es-ES'),
            'Registrado Por': placement.createdBy
        };
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Colocados");
    
    const filename = `Reporte_Colocados_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, filename);
    
    showNotification('Reporte de colocados exportado exitosamente', 'success');
}

// ============= FIN DE FUNCIONES PARA M칍DULO DE COLOCADOS =============

// ============= FUNCIONES PARA GENERAR PDFs DE HISTORIAL DE SOLICITUDES =============

// Generar PDF de rechazo
function generateRejectionPDF(applicationId) {
    const application = applications.find(app => app.id === applicationId);
    if (!application || application.status !== 'rejected') {
        showNotification('Solicitud no encontrada o no est치 rechazada', 'error');
        return;
    }

    const participant = getParticipantData(application.participantId);
    const offer = offers.find(o => o.id === application.offerId);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;
    const margin = 20;
    const lineHeight = 6;
    
    // Funci칩n auxiliar para agregar texto
    function addText(text, x, y, fontSize = 10, style = 'normal') {
        doc.setFontSize(fontSize);
        doc.setFont('helvetica', style);
        doc.text(text, x, y);
    }
    
    // Funci칩n auxiliar para agregar l칤nea separadora
    function addLine(y) {
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.5);
        doc.line(margin, y, 190, y);
    }

    // ENCABEZADO
    doc.setTextColor(200, 16, 46);
    addText('UNIVERSIDAD ANA G. M칄NDEZ', margin, yPos, 16, 'bold');
    yPos += 10;
    addText('OFICINA DE CARRERAS Y COLOCACIONES', margin, yPos, 14, 'bold');
    yPos += 8;
    addText('REGISTRO DE SOLICITUD RECHAZADA', margin, yPos, 14, 'bold');
    yPos += 15;
    
    doc.setTextColor(0, 0, 0);
    addText('Fecha de generaci칩n: ' + new Date().toLocaleDateString('es-ES'), margin, yPos, 10);
    addText('ID de Solicitud: ' + application.id, 120, yPos, 10);
    yPos += 10;
    addLine(yPos);
    yPos += 15;

    // INFORMACI칍N DEL PARTICIPANTE
    doc.setTextColor(200, 16, 46);
    addText('INFORMACI칍N DEL PARTICIPANTE', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Nombre Completo:', margin, yPos, 10, 'bold');
    addText(application.participantName, 80, yPos);
    yPos += lineHeight;
    
    addText('Email:', margin, yPos, 10, 'bold');
    addText(application.participantEmail, 80, yPos);
    yPos += lineHeight;
    
    addText('Tel칠fono:', margin, yPos, 10, 'bold');
    addText(application.participantPhone, 80, yPos);
    yPos += lineHeight;
    
    if (participant) {
        addText('Tipo Estudiante:', margin, yPos, 10, 'bold');
        addText(getStudentTypeLabel(participant.studentType), 80, yPos);
        yPos += lineHeight;
        
        addText('Concentraci칩n:', margin, yPos, 10, 'bold');
        addText(participant.concentration || 'N/A', 80, yPos);
        yPos += lineHeight;
        
        addText('Campus:', margin, yPos, 10, 'bold');
        addText(getCampusLabel(participant.campus), 80, yPos);
        yPos += lineHeight;
        
        addText('ID Estudiante:', margin, yPos, 10, 'bold');
        addText(participant.studentId || 'N/A', 80, yPos);
        yPos += lineHeight;
    }
    yPos += 10;

    // INFORMACI칍N DE LA OFERTA
    doc.setTextColor(200, 16, 46);
    addText('INFORMACI칍N DE LA OFERTA', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Empresa:', margin, yPos, 10, 'bold');
    addText(application.companyName, 80, yPos);
    yPos += lineHeight;
    
    addText('Posici칩n:', margin, yPos, 10, 'bold');
    addText(application.offerTitle, 80, yPos);
    yPos += lineHeight;
    
    if (offer) {
        addText('Contacto Empresa:', margin, yPos, 10, 'bold');
        addText(offer.contactPerson || 'N/A', 80, yPos);
        yPos += lineHeight;
        
        addText('Email Empresa:', margin, yPos, 10, 'bold');
        addText(offer.email || 'N/A', 80, yPos);
        yPos += lineHeight;
        
        addText('Ubicaci칩n:', margin, yPos, 10, 'bold');
        addText(offer.location || 'N/A', 80, yPos);
        yPos += lineHeight;
    }
    yPos += 10;

    // DETALLES DEL RECHAZO
    doc.setTextColor(220, 53, 69);
    addText('DETALLES DEL RECHAZO', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Fecha de Solicitud:', margin, yPos, 10, 'bold');
    addText(new Date(application.appliedAt).toLocaleDateString('es-ES') + ' a las ' + new Date(application.appliedAt).toLocaleTimeString('es-ES'), 80, yPos);
    yPos += lineHeight;
    
    addText('Fecha de Rechazo:', margin, yPos, 10, 'bold');
    const rejectionDate = application.adminReview?.reviewedAt ? new Date(application.adminReview.reviewedAt) : new Date();
    addText(rejectionDate.toLocaleDateString('es-ES') + ' a las ' + rejectionDate.toLocaleTimeString('es-ES'), 80, yPos);
    yPos += lineHeight;
    
    addText('Evaluado Por:', margin, yPos, 10, 'bold');
    addText(application.adminReview?.reviewedBy || 'Administrador', 80, yPos);
    yPos += lineHeight;
    
    addText('Estado:', margin, yPos, 10, 'bold');
    addText('RECHAZADA', 80, yPos);
    yPos += 15;

    // RAZ칍N DEL RECHAZO (destacado)
    doc.setFillColor(248, 215, 218);
    doc.rect(margin - 5, yPos - 5, 175, 50, 'F');
    
    doc.setTextColor(114, 28, 36);
    addText('RAZ칍N DEL RECHAZO:', margin, yPos, 11, 'bold');
    yPos += 10;
    
    doc.setTextColor(0, 0, 0);
    const rejectionReason = application.adminReview?.notes || 'No se proporcion칩 una raz칩n espec칤fica.';
    const reasonLines = doc.splitTextToSize(rejectionReason, 160);
    doc.text(reasonLines, margin, yPos);
    yPos += reasonLines.length * 5 + 15;

    // RECOMENDACIONES
    doc.setTextColor(255, 193, 7);
    addText('RECOMENDACIONES', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText(' El participante puede aplicar a otras ofertas disponibles en el portal', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText(' Se recomienda revisar cuidadosamente los requisitos antes de aplicar', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText(' Puede agendar una cita con la oficina para orientaci칩n sobre aplicaciones', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText(' Actualizar su resum칠 y perfil puede mejorar futuras aplicaciones', margin + 5, yPos, 9);
    yPos += 15;

    // INFORMACI칍N ADICIONAL
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setTextColor(200, 16, 46);
    addText('INFORMACI칍N ADICIONAL', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Este documento certifica que la solicitud del participante fue evaluada', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText('por el personal de la Oficina de Carreras y Colocaciones y no cumpli칩', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText('con los requisitos establecidos para la posici칩n solicitada.', margin + 5, yPos, 9);
    yPos += 10;
    
    addText('Para m치s informaci칩n o aclaraciones, contactar:', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText('Email: carreras_colocacionescu@uagm.edu', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText('Tel칠fono: (787) 766-1717', margin + 5, yPos, 9);
    yPos += lineHeight;

    // PIE DE P츼GINA
    yPos = 270;
    addLine(yPos - 5);
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    addText('Documento Confidencial - Oficina de Carreras y Colocaciones UAGM', margin, yPos);
    addText('Generado el: ' + new Date().toLocaleString('es-ES'), margin, yPos + 5);
    addText('Este documento forma parte del expediente del participante', margin, yPos + 10);

    // Generar y descargar
    const fileName = `Rechazo_${application.participantName.replace(/\s+/g, '_')}_${application.companyName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    
    showNotification('PDF de rechazo generado: ' + fileName, 'success');
}

// Generar PDF de referido aprobado
function generateReferralPDF(applicationId) {
    const application = applications.find(app => app.id === applicationId);
    if (!application || application.status !== 'approved_sent') {
        showNotification('Solicitud no encontrada o no est치 en estado de referido enviado', 'error');
        return;
    }

    const participant = getParticipantData(application.participantId);
    const offer = offers.find(o => o.id === application.offerId);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;
    const margin = 20;
    const lineHeight = 6;
    
    // Funci칩n auxiliar para agregar texto
    function addText(text, x, y, fontSize = 10, style = 'normal') {
        doc.setFontSize(fontSize);
        doc.setFont('helvetica', style);
        doc.text(text, x, y);
    }
    
    // Funci칩n auxiliar para agregar l칤nea separadora
    function addLine(y) {
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.5);
        doc.line(margin, y, 190, y);
    }

    // ENCABEZADO
    doc.setTextColor(200, 16, 46);
    addText('UNIVERSIDAD ANA G. M칄NDEZ', margin, yPos, 16, 'bold');
    yPos += 10;
    addText('OFICINA DE CARRERAS Y COLOCACIONES', margin, yPos, 14, 'bold');
    yPos += 8;
    addText('REGISTRO DE REFERIDO A PATRONO', margin, yPos, 14, 'bold');
    yPos += 15;
    
    doc.setTextColor(0, 0, 0);
    addText('Fecha de generaci칩n: ' + new Date().toLocaleDateString('es-ES'), margin, yPos, 10);
    addText('ID de Solicitud: ' + application.id, 120, yPos, 10);
    yPos += 10;
    addLine(yPos);
    yPos += 15;

    // INFORMACI칍N DEL PARTICIPANTE REFERIDO
    doc.setTextColor(200, 16, 46);
    addText('INFORMACI칍N DEL CANDIDATO REFERIDO', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Nombre Completo:', margin, yPos, 10, 'bold');
    addText(application.participantName, 80, yPos);
    yPos += lineHeight;
    
    addText('Email:', margin, yPos, 10, 'bold');
    addText(application.participantEmail, 80, yPos);
    yPos += lineHeight;
    
    addText('Tel칠fono:', margin, yPos, 10, 'bold');
    addText(application.participantPhone, 80, yPos);
    yPos += lineHeight;
    
    if (participant) {
        addText('Tipo Estudiante:', margin, yPos, 10, 'bold');
        addText(getStudentTypeLabel(participant.studentType), 80, yPos);
        yPos += lineHeight;
        
        addText('Concentraci칩n:', margin, yPos, 10, 'bold');
        addText(participant.concentration || 'N/A', 80, yPos);
        yPos += lineHeight;
        
        addText('Campus:', margin, yPos, 10, 'bold');
        addText(getCampusLabel(participant.campus), 80, yPos);
        yPos += lineHeight;
        
        addText('ID Estudiante:', margin, yPos, 10, 'bold');
        addText(participant.studentId || 'N/A', 80, yPos);
        yPos += lineHeight;
        
        addText('A침o de Estudios:', margin, yPos, 10, 'bold');
        addText(participant.studyYear || 'N/A', 80, yPos);
        yPos += lineHeight;
        
        addText('Grado Acad칠mico:', margin, yPos, 10, 'bold');
        addText(participant.academicDegree || 'N/A', 80, yPos);
        yPos += lineHeight;
    }
    yPos += 10;

    // INFORMACI칍N DE LA EMPRESA Y POSICI칍N
    doc.setTextColor(200, 16, 46);
    addText('INFORMACI칍N DE LA EMPRESA Y POSICI칍N', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Empresa:', margin, yPos, 10, 'bold');
    addText(application.companyName, 80, yPos);
    yPos += lineHeight;
    
    addText('Posici칩n:', margin, yPos, 10, 'bold');
    addText(application.offerTitle, 80, yPos);
    yPos += lineHeight;
    
    if (offer) {
        addText('Contacto Empresa:', margin, yPos, 10, 'bold');
        addText(offer.contactPerson || 'N/A', 80, yPos);
        yPos += lineHeight;
        
        addText('Email Empresa:', margin, yPos, 10, 'bold');
        addText(offer.email || 'N/A', 80, yPos);
        yPos += lineHeight;
        
        addText('Tel칠fono Empresa:', margin, yPos, 10, 'bold');
        addText(offer.phone || 'N/A', 80, yPos);
        yPos += lineHeight;
        
        addText('Ubicaci칩n:', margin, yPos, 10, 'bold');
        addText(offer.location || 'N/A', 80, yPos);
        yPos += lineHeight;
        
        addText('Tipo Posici칩n:', margin, yPos, 10, 'bold');
        addText(getTypeLabel(offer.positionType), 80, yPos);
        yPos += lineHeight;
        
        addText('Salario:', margin, yPos, 10, 'bold');
        addText(offer.salary || 'N/A', 80, yPos);
        yPos += lineHeight;
    }
    yPos += 10;

    // DETALLES DEL REFERIDO
    doc.setFillColor(212, 237, 218);
    doc.rect(margin - 5, yPos - 5, 175, 35, 'F');
    
    doc.setTextColor(21, 87, 36);
    addText('DETALLES DEL REFERIDO', margin, yPos, 11, 'bold');
    yPos += 10;
    
    doc.setTextColor(0, 0, 0);
    addText('Fecha de Solicitud:', margin, yPos, 10, 'bold');
    addText(new Date(application.appliedAt).toLocaleDateString('es-ES'), 80, yPos);
    yPos += lineHeight;
    
    addText('Fecha de Aprobaci칩n:', margin, yPos, 10, 'bold');
    const approvalDate = application.adminReview?.reviewedAt ? new Date(application.adminReview.reviewedAt) : new Date();
    addText(approvalDate.toLocaleDateString('es-ES'), 80, yPos);
    yPos += lineHeight;
    
    addText('Fecha de Env칤o:', margin, yPos, 10, 'bold');
    const sentDate = application.adminReview?.sentAt ? new Date(application.adminReview.sentAt) : new Date();
    addText(sentDate.toLocaleDateString('es-ES') + ' a las ' + sentDate.toLocaleTimeString('es-ES'), 80, yPos);
    yPos += lineHeight;
    
    addText('Evaluado Por:', margin, yPos, 10, 'bold');
    addText(application.adminReview?.reviewedBy || 'Administrador', 80, yPos);
    yPos += lineHeight;
    
    addText('Estado:', margin, yPos, 10, 'bold');
    addText('REFERIDO ENVIADO AL PATRONO', 80, yPos);
    yPos += 15;

    // NOTAS DEL EVALUADOR (si existen)
    if (application.adminReview?.notes && application.adminReview.notes.trim()) {
        doc.setFillColor(255, 243, 205);
        doc.rect(margin - 5, yPos - 5, 175, 35, 'F');
        
        doc.setTextColor(133, 100, 4);
        addText('NOTAS DEL EVALUADOR:', margin, yPos, 11, 'bold');
        yPos += 10;
        
        doc.setTextColor(0, 0, 0);
        const notesLines = doc.splitTextToSize(application.adminReview.notes, 160);
        doc.text(notesLines, margin, yPos);
        yPos += notesLines.length * 5 + 10;
    }

    // Verificar si necesitamos nueva p치gina
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }

    // ACCIONES REALIZADAS
    doc.setTextColor(200, 16, 46);
    addText('ACCIONES REALIZADAS', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('九 Candidato evaluado y pre-aprobado por UAGM', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText('九 Resum칠 del candidato enviado al patrono', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText('九 Datos de contacto del candidato proporcionados', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText('九 Email formal enviado al contacto de la empresa', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText('九 Registro creado en sistema de seguimiento', margin + 5, yPos, 9);
    yPos += 15;

    // SEGUIMIENTO
    doc.setTextColor(200, 16, 46);
    addText('SEGUIMIENTO', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('La empresa tiene acceso a:', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText(' Informaci칩n completa del candidato', margin + 10, yPos, 9);
    yPos += lineHeight;
    addText(' Resum칠 actualizado', margin + 10, yPos, 9);
    yPos += lineHeight;
    addText(' Datos de contacto directo', margin + 10, yPos, 9);
    yPos += lineHeight + 5;
    
    addText('Pr칩ximos pasos esperados:', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText(' Empresa contactar치 al candidato directamente', margin + 10, yPos, 9);
    yPos += lineHeight;
    addText(' Proceso de entrevista seg칰n criterios del patrono', margin + 10, yPos, 9);
    yPos += lineHeight;
    addText(' Notificaci칩n a UAGM sobre resultados del proceso', margin + 10, yPos, 9);
    yPos += 15;

    // INFORMACI칍N DE CONTACTO
    doc.setTextColor(200, 16, 46);
    addText('INFORMACI칍N DE CONTACTO', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Para seguimiento o consultas sobre este referido:', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText('Oficina de Carreras y Colocaciones', margin + 5, yPos, 9, 'bold');
    yPos += lineHeight;
    addText('Email: carreras_colocacionescu@uagm.edu', margin + 5, yPos, 9);
    yPos += lineHeight;
    addText('Tel칠fono: (787) 766-1717', margin + 5, yPos, 9);
    yPos += lineHeight;

    // PIE DE P츼GINA
    yPos = 270;
    addLine(yPos - 5);
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    addText('Documento Confidencial - Oficina de Carreras y Colocaciones UAGM', margin, yPos);
    addText('Generado el: ' + new Date().toLocaleString('es-ES'), margin, yPos + 5);
    addText('Este documento forma parte del expediente del participante', margin, yPos + 10);

    // Generar y descargar
    const fileName = `Referido_${application.participantName.replace(/\s+/g, '_')}_${application.companyName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    
    showNotification('PDF de referido generado: ' + fileName, 'success');
}

// ============= FIN FUNCIONES PARA GENERAR PDFs DE HISTORIAL =============


// Variable global para la cita que se est치 editando
let currentEditingAppointment = null;

// Funci칩n para abrir modal de edici칩n
function editAppointment(appointmentId) {
    const appointment = appointments.find(app => app.id === appointmentId);
    if (!appointment) {
        showNotification('Cita no encontrada', 'error');
        return;
    }
    
    currentEditingAppointment = appointment;
    
    // Llenar formulario con datos actuales
    document.getElementById('edit-firstName').value = appointment.firstName;
    document.getElementById('edit-lastName').value = appointment.lastName;
    document.getElementById('edit-email').value = appointment.email;
    document.getElementById('edit-phone').value = appointment.phone;
    document.getElementById('edit-appointmentDate').value = appointment.appointmentDate;
    document.getElementById('edit-appointmentTime').value = appointment.appointmentTime;
    document.getElementById('edit-concentration').value = appointment.concentration || '';
    document.getElementById('edit-campus').value = appointment.campus || 'cupey';
    document.getElementById('edit-changeReason').value = '';
    document.getElementById('edit-description').value = appointment.description || '';
    
    // Mostrar modal
    document.getElementById('editAppointmentModal').style.display = 'flex';
}

// Funci칩n para cerrar modal de edici칩n
function closeEditAppointmentModal() {
    document.getElementById('editAppointmentModal').style.display = 'none';
    document.getElementById('editAppointmentForm').reset();
    currentEditingAppointment = null;
}

// Funci칩n para guardar cambios
async function saveAppointmentChanges() {
    const form = document.getElementById('editAppointmentForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    if (!currentEditingAppointment) {
        showNotification('Error: No hay cita seleccionada', 'error');
        return;
    }
    
    const changeReason = document.getElementById('edit-changeReason').value.trim();
    if (!changeReason) {
        showNotification('Por favor especifica la raz칩n del cambio', 'warning');
        document.getElementById('edit-changeReason').focus();
        return;
    }
    
    // Recopilar datos actualizados
    const updatedData = {
        firstName: document.getElementById('edit-firstName').value,
        lastName: document.getElementById('edit-lastName').value,
        email: document.getElementById('edit-email').value,
        phone: document.getElementById('edit-phone').value,
        appointmentDate: document.getElementById('edit-appointmentDate').value,
        appointmentTime: document.getElementById('edit-appointmentTime').value,
        concentration: document.getElementById('edit-concentration').value,
        campus: document.getElementById('edit-campus').value,
        description: document.getElementById('edit-description').value,
        lastModified: new Date().toISOString(),
        modificationHistory: [
            ...(currentEditingAppointment.modificationHistory || []),
            {
                date: new Date().toISOString(),
                reason: changeReason,
                changes: {
                    oldDate: currentEditingAppointment.appointmentDate,
                    newDate: document.getElementById('edit-appointmentDate').value,
                    oldTime: currentEditingAppointment.appointmentTime,
                    newTime: document.getElementById('edit-appointmentTime').value
                },
                modifiedBy: 'admin@uagm.edu'
            }
        ]
    };
    
    try {
        // Actualizar en Firebase
        if (isFirebaseInitialized) {
            const snapshot = await db.collection('appointments')
                .where('id', '==', currentEditingAppointment.id)
                .get();
            
            if (!snapshot.empty) {
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.update(doc.ref, updatedData);
                });
                await batch.commit();
                console.log('Cita actualizada en Firebase:', currentEditingAppointment.id);
            }
        }
        
        // Actualizar en memoria local
        const appointmentIndex = appointments.findIndex(app => app.id === currentEditingAppointment.id);
        if (appointmentIndex !== -1) {
            appointments[appointmentIndex] = { ...appointments[appointmentIndex], ...updatedData };
        }
        
        // Actualizar localStorage
        localStorage.setItem('appointments', JSON.stringify(appointments));
        
        // Actualizar interfaz
        updateStats();
        loadAppointmentsTable();
        closeEditAppointmentModal();
        
        showNotification('Cita actualizada exitosamente', 'success');
        
        // Registrar en historial si cambi칩 la fecha/hora
        const participant = participants.find(p => 
            p.email === currentEditingAppointment.email || 
            (p.firstName === currentEditingAppointment.firstName && p.lastName === currentEditingAppointment.lastName)
        );
        
        if (participant) {
            const oldDate = currentEditingAppointment.appointmentDate;
            const oldTime = currentEditingAppointment.appointmentTime;
            const newDate = document.getElementById('edit-appointmentDate').value;
            const newTime = document.getElementById('edit-appointmentTime').value;
            
            if (oldDate !== newDate || oldTime !== oldTime) {
                await addToParticipantHistory(participant.id, {
                    eventType: 'appointment_rescheduled',
                    eventTitle: 'Cita Reprogramada',
                    description: `Cita reprogramada de ${formatLocalDate(oldDate)} ${oldTime} a ${formatLocalDate(newDate)} ${newTime}`,
                    data: {
                        participantName: `${currentEditingAppointment.firstName} ${currentEditingAppointment.lastName}`,
                        oldDate: oldDate,
                        oldTime: oldTime,
                        newDate: newDate,
                        newTime: newTime,
                        serviceType: currentEditingAppointment.serviceType,
                        changeReason: document.getElementById('edit-changeReason').value,
                        appointmentId: currentEditingAppointment.id
                    }
                });
            }
        }
        
    } catch (error) {

        console.error('Error actualizando cita:', error);
        showNotification('Error actualizando la cita. Intenta de nuevo.', 'error');
    }
}

// Funci칩n auxiliar para formatear fechas localmente
function formatLocalDate(dateString) {
    if (!dateString) return 'Sin fecha';
    const [year, month, day] = dateString.split('-');
    const localDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
    return localDate.toLocaleDateString('es-ES');
}

// Funci칩n para generar PDF de la oferta de un patrono espec칤fico
function generateOfferPDF(offerId) {
    const offer = offers.find(o => o.id === offerId);
    if (!offer) {
        showNotification('Oferta no encontrada', 'error');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;
    const margin = 20;
    const lineHeight = 6;
    
    // Funci칩n auxiliar para agregar texto
    function addText(text, x, y, fontSize = 10, style = 'normal') {
        doc.setFontSize(fontSize);
        doc.setFont('helvetica', style);
        doc.text(text, x, y);
    }
    
    // Funci칩n auxiliar para agregar l칤nea separadora
    function addLine(y) {
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.5);
        doc.line(margin, y, 190, y);
    }

    // ENCABEZADO
    doc.setTextColor(200, 16, 46);
    addText('UNIVERSIDAD ANA G. M칄NDEZ', margin, yPos, 16, 'bold');
    yPos += 10;
    addText('OFICINA DE CARRERAS Y COLOCACIONES', margin, yPos, 14, 'bold');
    yPos += 8;
    addText('REGISTRO DE OFERTA DE EMPLEO - PATRONO', margin, yPos, 14, 'bold');
    yPos += 15;
    
    doc.setTextColor(0, 0, 0);
    addText('Fecha de generaci칩n: ' + new Date().toLocaleDateString('es-ES'), margin, yPos, 10);
    addText('ID de Oferta: ' + offer.id, 120, yPos, 10);
    yPos += 10;
    addLine(yPos);
    yPos += 15;

    // INFORMACI칍N GENERAL
    doc.setTextColor(200, 16, 46);
    addText('INFORMACI칍N GENERAL', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Fecha de Solicitud:', margin, yPos, 10, 'bold');
    addText(offer.today ? new Date(offer.today).toLocaleDateString('es-ES') : 'No especificada', 100, yPos);
    yPos += lineHeight;
    
    addText('Tipo de Patrono:', margin, yPos, 10, 'bold');
    addText(offer.patronType === 'new' ? 'Patrono Nuevo' : offer.patronType === 'existing' ? 'Patrono Existente' : 'No especificado', 100, yPos);
    yPos += lineHeight;
    
    addText('Nombre de la Empresa:', margin, yPos, 10, 'bold');
    addText(offer.companyName || 'No especificado', 100, yPos);
    yPos += 15;

    // INFORMACI칍N DE CONTACTO
    doc.setTextColor(200, 16, 46);
    addText('INFORMACI칍N DE CONTACTO', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Persona de Contacto:', margin, yPos, 10, 'bold');
    addText(offer.contactPerson || 'No especificado', 100, yPos);
    yPos += lineHeight;
    
    addText('Posici칩n que Ocupa:', margin, yPos, 10, 'bold');
    addText(offer.contactPosition || 'No especificado', 100, yPos);
    yPos += lineHeight;
    
    addText('Tel칠fono:', margin, yPos, 10, 'bold');
    addText(offer.phone || 'No especificado', 100, yPos);
    yPos += lineHeight;
    
    addText('Correo Electr칩nico:', margin, yPos, 10, 'bold');
    addText(offer.email || 'No especificado', 100, yPos);
    yPos += lineHeight;
    
    addText('Oferta Recibida A Trav칠s De:', margin, yPos, 10, 'bold');
    const receivedLabels = {'email': 'Correo electr칩nico', 'presencial': 'Presencial', 'telefono': 'Tel칠fono'};
    addText(receivedLabels[offer.receivedThrough] || 'No especificado', 100, yPos);
    yPos += 15;

    // INFORMACI칍N DEL PUESTO
    doc.setTextColor(200, 16, 46);
    addText('INFORMACI칍N DEL PUESTO', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Posici칩n Solicitada:', margin, yPos, 10, 'bold');
    addText(offer.position || 'No especificado', 100, yPos);
    yPos += lineHeight;

addText('Posici칩n Solicitada:', margin, yPos, 10, 'bold');
addText(offer.position || 'No especificado', 100, yPos);
yPos += lineHeight;

addText('Sector Industrial:', margin, yPos, 10, 'bold');
addText(getSectorLabel(offer.academicDivision), 100, yPos);
yPos += lineHeight;
    
    // Descripci칩n del empleo (texto largo)
    if (offer.jobDescription && offer.jobDescription.trim()) {
        addText('Descripci칩n de Empleo:', margin, yPos, 10, 'bold');
        yPos += lineHeight;
        const lines = doc.splitTextToSize(offer.jobDescription, 160);
        doc.text(lines, margin + 5, yPos);
        yPos += lines.length * 4 + 5;
    }
    
    // Horarios
    if (offer.schedule && offer.schedule.trim()) {
        addText('Horarios y D칤as de Trabajo:', margin, yPos, 10, 'bold');
        yPos += lineHeight;
        const lines = doc.splitTextToSize(offer.schedule, 160);
        doc.text(lines, margin + 5, yPos);
        yPos += lines.length * 4 + 5;
    }
    
    // Requisitos (texto largo)
    if (offer.requirements && offer.requirements.trim()) {
        addText('Requisitos de la Posici칩n:', margin, yPos, 10, 'bold');
        yPos += lineHeight;
        const lines = doc.splitTextToSize(offer.requirements, 160);
        doc.text(lines, margin + 5, yPos);
        yPos += lines.length * 4 + 10;
    }

    // Verificar si necesitamos nueva p치gina
    if (yPos > 250) {
        doc.addPage();
        yPos = 20;
    }

    // DETALLES DEL EMPLEO
    doc.setTextColor(200, 16, 46);
    addText('DETALLES DEL EMPLEO', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Tipo de Posici칩n:', margin, yPos, 10, 'bold');
    const positionLabels = {'part-time': 'Part-Time', 'full-time': 'Full-Time', 'regular': 'Empleo Regular', 'temporary': 'Empleo Temporero'};
    addText(positionLabels[offer.positionType] || 'No especificado', 100, yPos);
    yPos += lineHeight;
    
    addText('Salario a Ofrecer:', margin, yPos, 10, 'bold');
    addText(offer.salary || 'No especificado', 100, yPos);
    yPos += lineHeight;
    
    addText('Localizaci칩n:', margin, yPos, 10, 'bold');
    addText(offer.location || 'No especificado', 100, yPos);
    yPos += lineHeight;
    
    addText('Fecha L칤mite:', margin, yPos, 10, 'bold');
    addText(offer.deadline ? new Date(offer.deadline).toLocaleDateString('es-ES') : 'No especificado', 100, yPos);
    yPos += lineHeight;
    
    // Estado de la oferta
    addText('Estado Actual:', margin, yPos, 10, 'bold');
    const status = getOfferStatus(offer.deadline);
    const statusText = status === 'expired' ? 'Vencida' : status === 'expiring' ? 'Vence Pronto' : 'Activa';
    addText(statusText, 100, yPos);
    yPos += 15;

    // ACTIVIDADES DE RECLUTAMIENTO
    doc.setTextColor(200, 16, 46);
    addText('ACTIVIDADES DE RECLUTAMIENTO', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Actividades Seleccionadas:', margin, yPos, 10, 'bold');
    yPos += lineHeight;
    
    if (offer.activities && offer.activities.length > 0) {
        const activityLabels = {
            'feria': 'Ferias de Empleo',
            'mesas': 'Mesas de reclutamiento',
            'talleres': 'Ofrecimiento de Talleres',
            'no': 'No participan en actividades'
        };
        
        offer.activities.forEach(activity => {
            addText(' ' + (activityLabels[activity] || activity), margin + 5, yPos);
            yPos += lineHeight;
        });
    } else {
        addText(' Ninguna actividad seleccionada', margin + 5, yPos);
        yPos += lineHeight;
    }
    yPos += 10;

    // INFORMACI칍N ADICIONAL
    if (offer.notes && offer.notes.trim()) {
        doc.setTextColor(200, 16, 46);
        addText('INFORMACI칍N ADICIONAL', margin, yPos, 12, 'bold');
        yPos += 10;
        doc.setTextColor(0, 0, 0);
        
        addText('Notas Adicionales:', margin, yPos, 10, 'bold');
        yPos += lineHeight;
        const lines = doc.splitTextToSize(offer.notes, 160);
        doc.text(lines, margin + 5, yPos);
        yPos += lines.length * 4 + 10;
    }

    // ESTAD칈STICAS DE LA OFERTA (informaci칩n adicional del sistema)
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setTextColor(200, 16, 46);
    addText('ESTAD칈STICAS DEL SISTEMA', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    // Contar aplicaciones para esta oferta
    const offerApplications = applications.filter(app => app.offerId === offer.id);
    addText('Total de Aplicaciones:', margin, yPos, 10, 'bold');
    addText(offerApplications.length.toString(), 100, yPos);
    yPos += lineHeight;
    
    addText('Fecha de Registro:', margin, yPos, 10, 'bold');
    addText(offer.createdAt ? new Date(offer.createdAt).toLocaleDateString('es-ES') : 'No disponible', 100, yPos);
    yPos += lineHeight;
    
    if (offer.updatedAt && offer.updatedAt !== offer.createdAt) {
        addText('칔ltima Actualizaci칩n:', margin, yPos, 10, 'bold');
        addText(new Date(offer.updatedAt).toLocaleDateString('es-ES'), 100, yPos);
        yPos += lineHeight;
    }

    // PIE DE P츼GINA
    yPos = 270; // Posici칩n fija para el pie
    addLine(yPos - 5);
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    addText('Documento generado por el Sistema Administrativo - Portal de Empleos UAGM', margin, yPos);
    addText('Generado el: ' + new Date().toLocaleString('es-ES'), margin, yPos + 5);

    // Generar y descargar el PDF
    const companyNameClean = (offer.companyName || 'Sin_Nombre').replace(/[^a-zA-Z0-9]/g, '_');
    const positionClean = (offer.position || 'Sin_Posicion').replace(/[^a-zA-Z0-9]/g, '_');
    const fileName = `Oferta_${companyNameClean}_${positionClean}_${new Date().toISOString().split('T')[0]}.pdf`;
    
    doc.save(fileName);
    showNotification('PDF generado: ' + fileName, 'success');
}

// Funci칩n para generar PDF del expediente de participante
function generateParticipantPDF(participantId) {
    const participant = participants.find(p => p.id === participantId);
    if (!participant) {
        showNotification('Participante no encontrado', 'error');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;
    const margin = 20;
    const lineHeight = 6;
    
    // Funci칩n auxiliar para agregar texto
    function addText(text, x, y, fontSize = 10, style = 'normal') {
        doc.setFontSize(fontSize);
        doc.setFont('helvetica', style);
        doc.text(text, x, y);
    }
    
    // Funci칩n auxiliar para agregar l칤nea separadora
    function addLine(y) {
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.5);
        doc.line(margin, y, 190, y);
    }

    // ENCABEZADO
    doc.setTextColor(200, 16, 46);
    addText('UNIVERSIDAD ANA G. M칄NDEZ', margin, yPos, 16, 'bold');
    yPos += 10;
    addText('OFICINA DE CARRERAS Y COLOCACIONES', margin, yPos, 14, 'bold');
    yPos += 8;
    addText('EXPEDIENTE DE PARTICIPANTE', margin, yPos, 14, 'bold');
    yPos += 15;
    
    doc.setTextColor(0, 0, 0);
    addText('Fecha de generaci칩n: ' + new Date().toLocaleDateString('es-ES'), margin, yPos, 10);
    addText('ID: ' + participant.id, 120, yPos, 10);
    yPos += 10;
    addLine(yPos);
    yPos += 15;

    // INFORMACI칍N PERSONAL
    doc.setTextColor(200, 16, 46);
    addText('INFORMACI칍N PERSONAL', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Nombre Completo:', margin, yPos, 10, 'bold');
    addText(`${participant.firstName} ${participant.lastName}`, 80, yPos);
    yPos += lineHeight;
    
    addText('Tipo de Participante:', margin, yPos, 10, 'bold');
    addText(participant.participantType === 'new' ? 'Nuevo Participante' : 'Participante de Seguimiento', 80, yPos);
    yPos += lineHeight;
    
    addText('Correo Electr칩nico:', margin, yPos, 10, 'bold');
    addText(participant.email, 80, yPos);
    yPos += lineHeight;
    
    addText('Tel칠fono:', margin, yPos, 10, 'bold');
    addText(participant.phone, 80, yPos);
    yPos += lineHeight;
    
    addText('Ciudad de Residencia:', margin, yPos, 10, 'bold');
    addText(participant.city, 80, yPos);
    yPos += lineHeight;
    
    addText('Fecha de Registro:', margin, yPos, 10, 'bold');
    addText(new Date(participant.registeredAt).toLocaleDateString('es-ES'), 80, yPos);
    yPos += 15;

    // INFORMACI칍N ACAD칄MICA
    doc.setTextColor(200, 16, 46);
    addText('INFORMACI칍N ACAD칄MICA', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    const studentTypeLabels = {
        'student': 'Estudiante Activo',
        'alumni': 'Exalumno',
        'community': 'Comunidad Externa'
    };
    
    addText('Tipo de Estudiante:', margin, yPos, 10, 'bold');
    addText(studentTypeLabels[participant.studentType] || participant.studentType, 80, yPos);
    yPos += lineHeight;
    
    const campusLabels = {
        'cupey': 'Recinto de Cupey',
        'bayamon': 'Centro Universitario de Bayam칩n',
        'aguadilla': 'Centro Universitario de Aguadilla'
    };
    
    addText('Recinto:', margin, yPos, 10, 'bold');
    addText(campusLabels[participant.campus] || participant.campus, 80, yPos);
    yPos += lineHeight;
    
    addText('ID de Estudiante:', margin, yPos, 10, 'bold');
    addText(participant.studentId || 'No proporcionado', 80, yPos);
    yPos += lineHeight;
    
    const scheduleLabels = {
        'diurno': 'Horario Diurno',
        'nocturno': 'Horario Nocturno'
    };
    
    addText('Horario:', margin, yPos, 10, 'bold');
    addText(scheduleLabels[participant.schedule] || participant.schedule, 80, yPos);
    yPos += lineHeight;
    
    addText('A침o de Estudios:', margin, yPos, 10, 'bold');
    addText(participant.studyYear || 'No especificado', 80, yPos);
    yPos += lineHeight;
    
    addText('Concentraci칩n:', margin, yPos, 10, 'bold');
    const concentrationLines = doc.splitTextToSize(participant.concentration, 100);
    doc.text(concentrationLines, 80, yPos);
    yPos += concentrationLines.length * lineHeight + 5;

    // INFORMACI칍N ACAD칄MICA DETALLADA
    doc.setTextColor(200, 16, 46);
    addText('INFORMACI칍N ACAD칄MICA DETALLADA', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Candidato a Graduaci칩n:', margin, yPos, 10, 'bold');
    addText(participant.graduationCandidate === 'yes' ? 'S칤' : 'No', 80, yPos);
    yPos += lineHeight;
    
    const degreeLabels = {
        '11mo': '11mo Grado o Menos',
        'cuarto': 'Cuarto A침o',
        'certificado': 'Certificado T칠cnico',
        'asociado': 'Grado Asociado',
        'bachillerato': 'Bachillerato',
        'maestria': 'Maestr칤a',
        'doctorado': 'Doctorado'
    };
    
    addText('Grado Acad칠mico:', margin, yPos, 10, 'bold');
    addText(degreeLabels[participant.academicDegree] || participant.academicDegree, 80, yPos);
    yPos += lineHeight;
    
    const divisionLabels = {
        'negocios': 'Negocios, Turismo y Emprendimiento',
        'salud': 'Ciencias de la Salud',
        'liberales': 'Artes Liberales',
        'tecnologia': 'Ciencias y Tecnolog칤a',
        'tecnicos': 'Programas T칠cnicos'
    };
    
    addText('Divisi칩n Acad칠mica:', margin, yPos, 10, 'bold');
    const divisionText = divisionLabels[participant.academicDivision] || participant.academicDivision;
    const divisionLines = doc.splitTextToSize(divisionText, 100);
    doc.text(divisionLines, 80, yPos);
    yPos += divisionLines.length * lineHeight + 10;

    // DOCUMENTACI칍N
    doc.setTextColor(200, 16, 46);
    addText('DOCUMENTACI칍N', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    addText('Resum칠:', margin, yPos, 10, 'bold');
    addText(participant.resume ? 'Archivo adjunto en sistema' : 'No adjuntado', 80, yPos);
    yPos += lineHeight;
    
    if (participant.resumeFileName) {
        addText('Nombre del Archivo:', margin, yPos, 10, 'bold');
        addText(participant.resumeFileName, 80, yPos);
        yPos += lineHeight;
    }
    yPos += 10;

    // ACTIVIDAD DEL PARTICIPANTE
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setTextColor(200, 16, 46);
    addText('ACTIVIDAD EN EL SISTEMA', margin, yPos, 12, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    const participantApplications = applications.filter(app => app.participantId === participant.id);
    
    addText('Total de Solicitudes:', margin, yPos, 10, 'bold');
    addText(participantApplications.length.toString(), 80, yPos);
    yPos += lineHeight;
    
    if (participantApplications.length > 0) {
        yPos += 5;
        addText('Detalle de Solicitudes:', margin, yPos, 10, 'bold');
        yPos += lineHeight + 2;
        
        participantApplications.slice(0, 10).forEach((app, index) => {
            if (yPos > 260) {
                doc.addPage();
                yPos = 20;
            }
            
            addText(`${index + 1}.`, margin + 5, yPos, 9);
            addText(`${app.offerTitle} - ${app.companyName}`, margin + 12, yPos, 9);
            yPos += lineHeight - 1;
            addText(`   Fecha: ${new Date(app.appliedAt).toLocaleDateString('es-ES')} | Estado: ${app.status}`, margin + 12, yPos, 8);
            yPos += lineHeight + 1;
        });
        
        if (participantApplications.length > 10) {
            yPos += 3;
            addText(`... y ${participantApplications.length - 10} solicitudes m치s`, margin + 5, yPos, 9, 'italic');
            yPos += lineHeight;
        }
    } else {
        addText('No hay solicitudes registradas', margin + 5, yPos, 9, 'italic');
        yPos += lineHeight;
    }

    // PIE DE P츼GINA
    yPos = 270;
    addLine(yPos - 5);
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    addText('Documento generado por el Sistema Administrativo - Portal de Empleos UAGM', margin, yPos);
    addText('Generado el: ' + new Date().toLocaleString('es-ES'), margin, yPos + 5);
    addText('Este documento contiene informaci칩n confidencial del participante', margin, yPos + 10);

    // Generar y descargar
    const fileName = `Expediente_${participant.firstName}_${participant.lastName}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    
    showNotification('PDF del expediente generado: ' + fileName, 'success');
}

// ============= FUNCIONES PARA RESUME BUILDER =============

// Cargar tabla de registros Resume Builder
function loadResumeRegistrationsTable() {
    const container = document.getElementById('resumeRegistrationsTableContainer');
    
    if (resumeRegistrations.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-file-alt"></i>
                <h3>No hay registros de Resume Builder</h3>
                <p>Los registros del Resume Builder aparecer치n aqu칤</p>
            </div>
        `;
        return;
    }

    let html = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Fecha Registro</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Tel칠fono</th>
                    <th>Tipo Participante</th>
                    <th>Tipo Usuario</th>
                    <th>Grado Acad칠mico</th>
                    <th>Campus</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
    `;

    resumeRegistrations.forEach(reg => {
        const regDate = reg.registrationDate ? new Date(reg.registrationDate).toLocaleDateString('es-ES') : 'Sin fecha';
        const participantType = reg.participantType || 'No especificado';
        const userType = reg.userType || 'No especificado';
        const campus = reg.campus || 'N/A';
        
        html += `
            <tr>
                <td>${regDate}</td>
                <td><strong>${reg.firstName} ${reg.lastName}</strong></td>
                <td>${reg.email}</td>
                <td>${reg.phone}</td>
                <td><span class="status-badge ${participantType === 'Nuevo' ? 'status-active' : 'status-approved'}">${participantType}</span></td>
                <td>${userType}</td>
                <td>${reg.academicDegree || 'No especificado'}</td>
                <td>${campus}</td>
                <td>
                    <div class="actions">
                        <button class="btn btn-info btn-small" onclick="viewResumeRegistrationDetails('${reg.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteResumeRegistration('${reg.id}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

// Ver detalles de registro Resume Builder
function viewResumeRegistrationDetails(regId) {
    const reg = resumeRegistrations.find(r => r.id === regId);
    if (!reg) return;

    document.getElementById('modalTitle').textContent = `Registro Resume Builder: ${reg.firstName} ${reg.lastName}`;
    document.getElementById('modalBody').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
            <div>
                <h4 style="color: #17a2b8; margin-bottom: 15px;">游늶 Informaci칩n Personal</h4>
                <p><strong>Nombre Completo:</strong> ${reg.firstName} ${reg.lastName}</p>
                <p><strong>Email:</strong> ${reg.email}</p>
                <p><strong>Tel칠fono:</strong> ${reg.phone}</p>
                <p><strong>Ciudad:</strong> ${reg.city}</p>
                <p><strong>Tipo Participante:</strong> ${reg.participantType || 'No especificado'}</p>
            </div>
            <div>
                <h4 style="color: #17a2b8; margin-bottom: 15px;">游꿉 Informaci칩n Acad칠mica</h4>
                <p><strong>Tipo Usuario:</strong> ${reg.userType || 'No especificado'}</p>
                <p><strong>Grado Acad칠mico:</strong> ${reg.academicDegree || 'No especificado'}</p>
                <p><strong>Concentraci칩n:</strong> ${reg.concentration || 'No especificada'}</p>
                ${reg.campus ? `<p><strong>Campus:</strong> ${reg.campus}</p>` : ''}
            </div>
        </div>
        
        ${reg.userType === 'Estudiante' && (reg.studentId || reg.schedule || reg.studyYears) ? `
        <div style="margin-bottom: 20px; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #17a2b8;">
            <h4 style="color: #0277bd; margin-bottom: 15px;">游녿꽳릝 Informaci칩n de Estudiante</h4>
            ${reg.studentId ? `<p><strong>ID Estudiante:</strong> ${reg.studentId}</p>` : ''}
            ${reg.schedule ? `<p><strong>Horario:</strong> ${reg.schedule}</p>` : ''}
            ${reg.studyYears ? `<p><strong>A침os de Estudio:</strong> ${reg.studyYears}</p>` : ''}
            ${reg.division ? `<p><strong>Divisi칩n Acad칠mica:</strong> ${reg.division}</p>` : ''}
            ${reg.graduationCandidate ? `<p><strong>Candidato Graduaci칩n:</strong> ${reg.graduationCandidate}</p>` : ''}
        </div>
        ` : ''}
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #6c757d;">
            <p><strong>Fecha de Registro:</strong> ${reg.registrationDate ? new Date(reg.registrationDate).toLocaleString('es-ES') : 'No disponible'}</p>
            <p><strong>Fuente:</strong> ${reg.source || 'Resume Builder Web Form'}</p>
            <p><strong>Servicio:</strong> ${reg.serviceType || reg.service || 'Redacci칩n de Resum칠'}</p>
        </div>
    `;

    document.getElementById('detailsModal').style.display = 'flex';
}

// Eliminar registro Resume Builder
async function deleteResumeRegistration(regId) {
    const reg = resumeRegistrations.find(r => r.id === regId);
    if (!reg) return;
    
    if (confirm(`쮼st치s seguro de que quieres eliminar el registro de "${reg.firstName} ${reg.lastName}"?`)) {
        try {
            let deletedFromFirebase = false;
            
            // Eliminar de Firebase
            if (isFirebaseInitialized) {
                try {
                    // Intentar encontrar por campo 'id'
                    const snapshot = await db.collection('resumeRegistrations')
                        .where('id', '==', regId)
                        .get();
                    
                    if (!snapshot.empty) {
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        deletedFromFirebase = true;
                        console.log('Registro Resume Builder eliminado de Firebase (por campo id):', regId);
                    } else {
                        // Si no lo encuentra por campo, intentar por document ID
                        try {
                            await db.collection('resumeRegistrations').doc(regId).delete();
                            deletedFromFirebase = true;
                            console.log('Registro Resume Builder eliminado de Firebase (por document ID):', regId);
                        } catch (docError) {
                            console.warn('No se pudo eliminar por document ID:', docError);
                        }
                    }
                } catch (fbError) {
                    console.error('Error eliminando de Firebase:', fbError);
                }
            }
            
            // Siempre eliminar de memoria local y localStorage
            resumeRegistrations = resumeRegistrations.filter(r => r.id !== regId);
            localStorage.setItem('resumeRegistrations', JSON.stringify(resumeRegistrations));
            
            // Actualizar interfaz
            filterResumeRegistrations();
            updateStats();
            
            if (deletedFromFirebase || !isFirebaseInitialized) {
                showNotification('Registro eliminado exitosamente', 'success');
            } else {
                showNotification('Registro eliminado localmente (verifica Firebase)', 'warning');
            }
            
        } catch (error) {
            console.error('Error eliminando registro:', error);
            showNotification('Error eliminando el registro. Intenta de nuevo.', 'error');
        }
    }
}

// Filtrar registros Resume Builder
function filterResumeRegistrations() {
    // Guardar valores actuales de los filtros
    currentFilters.resumes.search = document.getElementById('resumesSearch').value.toLowerCase();
    currentFilters.resumes.type = document.getElementById('resumesTypeFilter').value;
    currentFilters.resumes.userType = document.getElementById('resumesUserTypeFilter').value;
    currentFilters.resumes.date = document.getElementById('resumesDateFilter').value;
    
    let filtered = resumeRegistrations;
    
    // Filtro de b칰squeda
    if (currentFilters.resumes.search) {
        filtered = filtered.filter(reg => 
            `${reg.firstName} ${reg.lastName}`.toLowerCase().includes(currentFilters.resumes.search) ||
            reg.email.toLowerCase().includes(currentFilters.resumes.search) ||
            reg.phone.includes(currentFilters.resumes.search) ||
            (reg.concentration && reg.concentration.toLowerCase().includes(currentFilters.resumes.search)) ||
            (reg.studentId && reg.studentId.toLowerCase().includes(currentFilters.resumes.search))
        );
    }
    
    // Filtro de tipo de participante
    if (currentFilters.resumes.type) {
        filtered = filtered.filter(reg => reg.participantType === currentFilters.resumes.type);
    }
    
    // Filtro de tipo de usuario
    if (currentFilters.resumes.userType) {
        filtered = filtered.filter(reg => reg.userType === currentFilters.resumes.userType);
    }
    
    // Filtro de fecha
    if (currentFilters.resumes.date) {
        const today = new Date();
        filtered = filtered.filter(reg => {
            const regDate = new Date(reg.registrationDate);
            
            switch(currentFilters.resumes.date) {
                case 'today':
                    return regDate.toDateString() === today.toDateString();
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    return regDate >= weekAgo;
                case 'month':
                    return regDate.getMonth() === today.getMonth() && 
                           regDate.getFullYear() === today.getFullYear();
                default:
                    return true;
            }
        });
    }
    
    displayFilteredResumeRegistrations(filtered);
}

// Mostrar registros filtrados
function displayFilteredResumeRegistrations(filtered) {
    const container = document.getElementById('resumeRegistrationsTableContainer');
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-search"></i>
                <h3>No se encontraron registros</h3>
                <p>No hay registros que coincidan con los filtros aplicados</p>
            </div>
        `;
        return;
    }

    let html = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Fecha Registro</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Tel칠fono</th>
                    <th>Tipo Participante</th>
                    <th>Tipo Usuario</th>
                    <th>Grado Acad칠mico</th>
                    <th>Campus</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
    `;

    filtered.forEach(reg => {
        const regDate = reg.registrationDate ? new Date(reg.registrationDate).toLocaleDateString('es-ES') : 'Sin fecha';
        const participantType = reg.participantType || 'No especificado';
        const userType = reg.userType || 'No especificado';
        const campus = reg.campus || 'N/A';
        
        html += `
            <tr>
                <td>${regDate}</td>
                <td><strong>${reg.firstName} ${reg.lastName}</strong></td>
                <td>${reg.email}</td>
                <td>${reg.phone}</td>
                <td><span class="status-badge ${participantType === 'Nuevo' ? 'status-active' : 'status-approved'}">${participantType}</span></td>
                <td>${userType}</td>
                <td>${reg.academicDegree || 'No especificado'}</td>
                <td>${campus}</td>
                <td>
                    <div class="actions">
                        <button class="btn btn-info btn-small" onclick="viewResumeRegistrationDetails('${reg.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteResumeRegistration('${reg.id}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

// Exportar registros Resume Builder
function exportResumeRegistrationsData() {
    if (resumeRegistrations.length === 0) {
        showNotification('No hay registros de Resume Builder para exportar', 'warning');
        return;
    }

    const data = resumeRegistrations.map(reg => ({
        'Fecha Registro': reg.registrationDate ? new Date(reg.registrationDate).toLocaleDateString('es-ES') : 'Sin fecha',
        'Tipo Participante': reg.participantType || 'No especificado',
        'Nombre': reg.firstName,
        'Apellidos': reg.lastName,
        'Email': reg.email,
        'Tel칠fono': reg.phone,
        'Ciudad': reg.city,
        'Tipo Usuario': reg.userType || 'No especificado',
        'Grado Acad칠mico': reg.academicDegree || 'No especificado',
        'Concentraci칩n': reg.concentration || 'No especificada',
        'Campus': reg.campus || 'N/A',
        'ID Estudiante': reg.studentId || 'N/A',
        'Horario': reg.schedule || 'N/A',
        'A침os Estudio': reg.studyYears || 'N/A',
        'Divisi칩n Acad칠mica': reg.division || 'N/A',
        'Candidato Graduaci칩n': reg.graduationCandidate || 'N/A',
        'Servicio': reg.serviceType || reg.service || 'Redacci칩n de Resum칠',
        'Fuente': reg.source || 'Resume Builder Web Form'
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Registros Resume Builder");
    
    const filename = `Resume_Builder_Registros_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, filename);
    
    showNotification('Registros exportados exitosamente', 'success');
}

// ============= FIN FUNCIONES RESUME BUILDER =============


// ============= SISTEMA DE HISTORIAL DE PARTICIPANTES =============

// Funci칩n para agregar evento al historial
async function addToParticipantHistory(participantId, eventData) {
    const historyEntry = {
        id: `hist_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        participantId: participantId,
        timestamp: new Date().toISOString(),
        ...eventData
    };
    
    try {
        // Guardar en Firebase
        if (isFirebaseInitialized) {
            await db.collection('participantHistory').add(historyEntry);
            console.log('Evento agregado al historial en Firebase:', historyEntry.id);
        }
        
        // Agregar a memoria local
        participantHistory.push(historyEntry);
        
        // Guardar en localStorage como respaldo
        localStorage.setItem('participantHistory', JSON.stringify(participantHistory));
        
        return historyEntry;
        
    } catch (error) {
        console.error('Error agregando evento al historial:', error);
        return null;
    }
}

// Funci칩n para obtener historial de un participante
function getParticipantHistory(participantId) {
    return participantHistory
        .filter(entry => entry.participantId === participantId)
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
}

// Funci칩n para cargar historial desde Firebase
async function loadParticipantHistory() {
    try {
        if (isFirebaseInitialized) {
            const snapshot = await db.collection('participantHistory').get();
            participantHistory = [];
            snapshot.forEach(doc => {
                participantHistory.push({ id: doc.id, ...doc.data() });
            });
            console.log('Historial de participantes cargado desde Firebase:', participantHistory.length);
        } else {
            // Cargar desde localStorage
            participantHistory = JSON.parse(localStorage.getItem('participantHistory')) || [];
        }
    } catch (error) {
        console.error('Error cargando historial:', error);
        participantHistory = JSON.parse(localStorage.getItem('participantHistory')) || [];
    }
}

// Funci칩n para crear historial inicial de participantes (ejecutar UNA SOLA VEZ)
async function initializeParticipantHistoryOnce() {
    if (!isFirebaseInitialized) return;
    
    try {
        console.log('Verificando historial de participantes...');
        
        for (const participant of participants) {
            // Verificar si ya tiene registro inicial
            const hasRegistration = participantHistory.some(h => 
                h.participantId === participant.id && h.eventType === 'registration'
            );
            
            if (!hasRegistration && participant.registeredAt) {
                // Crear registro inicial con la fecha CORRECTA
                const historyEntry = {
                    id: `hist_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    participantId: participant.id,
                    timestamp: participant.registeredAt, // 九 USA LA FECHA REAL
                    eventType: 'registration',
                    eventTitle: 'Registro Inicial',
                    description: 'Se registr칩 en el portal de empleos',
                    data: {
                        participantName: `${participant.firstName} ${participant.lastName}`,
                        campus: participant.campus,
                        studentType: participant.studentType,
                        concentration: participant.concentration
                    }
                };
                
                // Guardar en Firebase
                await db.collection('participantHistory').add(historyEntry);
                
                // Agregar a memoria local
                participantHistory.push(historyEntry);
                
                console.log(`九 Historial inicial creado para: ${participant.firstName} ${participant.lastName}`);
            }
        }
        
        // Guardar en localStorage
        localStorage.setItem('participantHistory', JSON.stringify(participantHistory));
        
    } catch (error) {
        console.error('Error inicializando historial:', error);
    }
}

// Funci칩n para limpiar duplicados en el historial (EJECUTAR UNA SOLA VEZ)
async function cleanDuplicateHistory() {
    if (!isFirebaseInitialized) {
        console.log('Firebase no inicializado');
        return;
    }
    
    if (!confirm('丘멆잺 Esto eliminar치 registros duplicados del historial. 쮺ontinuar?')) {
        return;
    }
    
    try {
        console.log('Limpiando duplicados...');
        
        // Agrupar por participante
        const grouped = {};
        participantHistory.forEach(entry => {
            if (!grouped[entry.participantId]) {
                grouped[entry.participantId] = [];
            }
            grouped[entry.participantId].push(entry);
        });
        
        let duplicatesFound = 0;
        let duplicatesDeleted = 0;
        
        // Para cada participante
        for (const participantId in grouped) {
            const entries = grouped[participantId];
            
            // Encontrar duplicados de tipo 'registration'
            const registrations = entries.filter(e => e.eventType === 'registration');
            
            if (registrations.length > 1) {
                duplicatesFound += registrations.length - 1;
                
                // Ordenar por timestamp (m치s antiguo primero)
                registrations.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                // Mantener solo el m치s antiguo, eliminar el resto
                const toKeep = registrations[0];
                const toDelete = registrations.slice(1);
                
                console.log(`Participante ${participantId}: manteniendo registro de ${new Date(toKeep.timestamp).toLocaleDateString()}, eliminando ${toDelete.length} duplicados`);
                
                // Eliminar de Firebase
                for (const dup of toDelete) {
                    try {
                        const snapshot = await db.collection('participantHistory')
                            .where('id', '==', dup.id)
                            .get();
                        
                        if (!snapshot.empty) {
                            const batch = db.batch();
                            snapshot.docs.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();
                            duplicatesDeleted++;
                        }
                    } catch (error) {
                        console.error('Error eliminando duplicado:', error);
                    }
                }
                
                // Eliminar de memoria local
                participantHistory = participantHistory.filter(h => 
                    !(h.participantId === participantId && 
                      h.eventType === 'registration' && 
                      h.id !== toKeep.id)
                );
            }
        }
        
        // Guardar en localStorage
        localStorage.setItem('participantHistory', JSON.stringify(participantHistory));
        
        console.log(`九 Limpieza completada. Duplicados encontrados: ${duplicatesFound}, eliminados: ${duplicatesDeleted}`);
        alert(`Limpieza completada.\n\nDuplicados encontrados: ${duplicatesFound}\nDuplicados eliminados: ${duplicatesDeleted}\n\nRecarga la p치gina para ver los cambios.`);
        
    } catch (error) {
        console.error('Error limpiando duplicados:', error);
        alert('Error limpiando duplicados. Revisa la consola.');
    }
}

// Funci칩n para obtener icono seg칰n tipo de evento
function getEventIcon(eventType) {
    const icons = {
        'registration': '九',
        'application': '游닋',
        'referral': '九',
        'rejection': '仇',
        'placement': '游꿢',
        'appointment_scheduled': '游늰',
        'appointment_completed': '九',
        'appointment_cancelled': '仇',
        'appointment_rescheduled': '游댃',
        'resume_builder': '游늯',
        'manual_note': '游닇'
    };
    return icons[eventType] || '';
}

// Funci칩n para obtener color seg칰n tipo de evento
function getEventColor(eventType) {
    const colors = {
        'registration': '#28a745',
        'application': '#17a2b8',
        'referral': '#28a745',
        'rejection': '#dc3545',
        'placement': '#ffc107',
        'appointment_scheduled': '#6f42c1',
        'appointment_completed': '#28a745',
        'appointment_cancelled': '#dc3545',
        'appointment_rescheduled': '#fd7e14',
        'resume_builder': '#17a2b8',
        'manual_note': '#6c757d'
    };
    return colors[eventType] || '#6c757d';
}

// Funci칩n para obtener t칤tulo del evento
function getEventTitle(eventType) {
    const titles = {
        'registration': 'REGISTRO INICIAL',
        'application': 'APLIC칍 A OFERTA',
        'referral': 'REFERIDO A PATRONO',
        'rejection': 'SOLICITUD RECHAZADA',
        'placement': 'COLOCADO',
        'appointment_scheduled': 'CITA PROGRAMADA',
        'appointment_completed': 'CITA COMPLETADA',
        'appointment_cancelled': 'CITA CANCELADA',
        'appointment_rescheduled': 'CITA REPROGRAMADA',
        'resume_builder': 'REGISTRO RESUME BUILDER',
        'manual_note': 'NOTA MANUAL'
    };
    return titles[eventType] || 'EVENTO';
}

// ============= FIN SISTEMA DE HISTORIAL =============

// ============= FUNCIONES DE INTERFAZ PARA HISTORIAL =============

// Variable global para el participante actual en el modal de historial
let currentHistoryParticipantId = null;

// Funci칩n para ver historial del participante
function viewParticipantHistory(participantId) {
    const participant = participants.find(p => p.id === participantId);
    if (!participant) {
        showNotification('Participante no encontrado', 'error');
        return;
    }
    
    currentHistoryParticipantId = participantId;
    
    // Actualizar t칤tulo del modal
    document.getElementById('historyParticipantName').textContent = `${participant.firstName} ${participant.lastName}`;
    document.getElementById('historyParticipantEmail').textContent = participant.email;
    
    // Cargar timeline
    loadHistoryTimeline(participantId);
    
    // Mostrar modal
    document.getElementById('participantHistoryModal').style.display = 'flex';
}

// Funci칩n para cargar el timeline del historial
function loadHistoryTimeline(participantId) {
    const history = getParticipantHistory(participantId);
    const container = document.getElementById('historyTimelineContainer');
    
    if (history.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-history"></i>
                <h3>No hay historial registrado</h3>
                <p>Los eventos del participante aparecer치n aqu칤</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="timeline">';
    
    history.forEach((event, index) => {
        const icon = getEventIcon(event.eventType);
        const color = getEventColor(event.eventType);
        const title = getEventTitle(event.eventType);
        const date = new Date(event.timestamp);
        const formattedDate = date.toLocaleDateString('es-ES', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        const formattedTime = date.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        html += `
            <div class="timeline-item" style="border-left: 4px solid ${color}; padding: 20px; margin-bottom: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 24px;">${icon}</div>
                        <div>
                            <h4 style="margin: 0; color: ${color}; font-size: 16px;">${title}</h4>
                            <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 12px;">
                                <i class="fas fa-clock"></i> ${formattedDate} a las ${formattedTime}
                            </p>
                        </div>
                    </div>
                    ${event.eventType === 'manual_note' ? `
                        <button class="btn btn-danger btn-small" onclick="deleteHistoryEvent('${event.id}')" title="Eliminar nota">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </div>
                
                <div style="padding-left: 35px;">
                    <p style="margin: 10px 0; color: #2d3748; font-size: 14px;">${event.description}</p>
                    ${generateEventDetails(event)}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // Agregar resumen al final
    html += generateHistorySummary(history);
    
    container.innerHTML = html;
}

// Funci칩n para generar detalles espec칤ficos seg칰n el tipo de evento
function generateEventDetails(event) {
    let html = '';
    
    switch(event.eventType) {
        case 'registration':
            html += `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px;">
                    <p style="margin: 3px 0;"><strong>Campus:</strong> ${getCampusLabel(event.data?.campus)}</p>
                    <p style="margin: 3px 0;"><strong>Tipo:</strong> ${getStudentTypeLabel(event.data?.studentType)}</p>
                    <p style="margin: 3px 0;"><strong>Concentraci칩n:</strong> ${event.data?.concentration || 'N/A'}</p>
                </div>
            `;
            break;
            
        case 'application':
            html += `
                <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px;">
                    <p style="margin: 3px 0;"><strong>Empresa:</strong> ${event.data?.companyName}</p>
                    <p style="margin: 3px 0;"><strong>Posici칩n:</strong> ${event.data?.offerTitle}</p>
                </div>
            `;
            break;
            
        case 'referral':
            html += `
                <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px;">
                    <p style="margin: 3px 0;"><strong>Empresa:</strong> ${event.data?.companyName}</p>
                    <p style="margin: 3px 0;"><strong>Posici칩n:</strong> ${event.data?.offerTitle}</p>
                    ${event.data?.notes ? `<p style="margin: 8px 0 3px 0;"><strong>Notas del evaluador:</strong></p><p style="margin: 3px 0; font-style: italic;">${event.data.notes}</p>` : ''}
                </div>
            `;
            break;
            
        case 'rejection':
            html += `
                <div style="background: #ffebee; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px;">
                    <p style="margin: 3px 0;"><strong>Empresa:</strong> ${event.data?.companyName}</p>
                    <p style="margin: 3px 0;"><strong>Posici칩n:</strong> ${event.data?.offerTitle}</p>
                    <p style="margin: 8px 0 3px 0;"><strong>Raz칩n del rechazo:</strong></p>
                    <p style="margin: 3px 0; font-style: italic; color: #c62828;">${event.data?.reason || 'No especificada'}</p>
                </div>
            `;
            break;
            
        case 'placement':
            html += `
                <div style="background: #fff3e0; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px;">
                    <p style="margin: 3px 0;"><strong>Empresa:</strong> ${event.data?.company}</p>
                    <p style="margin: 3px 0;"><strong>Posici칩n:</strong> ${event.data?.position}</p>
                    <p style="margin: 3px 0;"><strong>Tipo:</strong> ${event.data?.positionType === 'full-time' ? 'Full-Time' : 'Part-Time'}</p>
                    <p style="margin: 3px 0;"><strong>Seguimiento:</strong> ${event.data?.trackingType === 'directo' ? 'Directo' : 'Indirecto'}</p>
                    <p style="margin: 3px 0;"><strong>Fecha colocaci칩n:</strong> ${formatLocalDate(event.data?.placementDate)}</p>
                </div>
            `;
            break;
            
        case 'appointment_scheduled':
        case 'appointment_completed':
        case 'appointment_cancelled':
        case 'appointment_rescheduled':
            html += `
                <div style="background: #f3e5f5; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px;">
                    <p style="margin: 3px 0;"><strong>Fecha cita:</strong> ${formatLocalDate(event.data?.appointmentDate)} a las ${event.data?.appointmentTime}</p>
                    <p style="margin: 3px 0;"><strong>Servicio:</strong> ${event.data?.serviceType === 'orientacion-manpower' ? 'Orientaci칩n con Manpower' : event.data?.serviceType}</p>
                    <p style="margin: 3px 0;"><strong>Campus:</strong> ${getCampusLabel(event.data?.campus)}</p>
                    ${event.data?.changeReason ? `<p style="margin: 8px 0 3px 0;"><strong>Raz칩n:</strong></p><p style="margin: 3px 0; font-style: italic;">${event.data.changeReason}</p>` : ''}
                </div>
            `;
            break;
            
        case 'resume_builder':
            html += `
                <div style="background: #e1f5fe; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px;">
                    <p style="margin: 3px 0;"><strong>Tipo participante:</strong> ${event.data?.participantType || 'N/A'}</p>
                    <p style="margin: 3px 0;"><strong>Tipo usuario:</strong> ${event.data?.userType || 'N/A'}</p>
                    <p style="margin: 3px 0;"><strong>Campus:</strong> ${getCampusLabel(event.data?.campus)}</p>
                </div>
            `;
            break;
    }
    
    return html;
}

// Funci칩n para generar resumen del historial
function generateHistorySummary(history) {
    const summary = {
        applications: history.filter(h => h.eventType === 'application').length,
        referrals: history.filter(h => h.eventType === 'referral').length,
        rejections: history.filter(h => h.eventType === 'rejection').length,
        placements: history.filter(h => h.eventType === 'placement').length,
        appointments: history.filter(h => h.eventType === 'appointment_scheduled').length,
        appointmentsCompleted: history.filter(h => h.eventType === 'appointment_completed').length,
        resumeBuilder: history.filter(h => h.eventType === 'resume_builder').length,
        manualNotes: history.filter(h => h.eventType === 'manual_note').length
    };
    
    const firstEvent = history[history.length - 1];
    const lastEvent = history[0];
    const startDate = new Date(firstEvent.timestamp).toLocaleDateString('es-ES');
    const endDate = new Date(lastEvent.timestamp).toLocaleDateString('es-ES');
    
    return `
        <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white;">
            <h4 style="margin: 0 0 15px 0; font-size: 18px;">游늵 RESUMEN DE ACTIVIDAD</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; font-weight: bold;">${summary.applications}</div>
                    <div style="font-size: 12px; opacity: 0.9;">Aplicaciones</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; font-weight: bold;">${summary.referrals}</div>
                    <div style="font-size: 12px; opacity: 0.9;">Referidos</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; font-weight: bold;">${summary.rejections}</div>
                    <div style="font-size: 12px; opacity: 0.9;">Rechazados</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; font-weight: bold;">${summary.placements}</div>
                    <div style="font-size: 12px; opacity: 0.9;">Colocaciones</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; font-weight: bold;">${summary.appointmentsCompleted}</div>
                    <div style="font-size: 12px; opacity: 0.9;">Citas Completadas</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; font-weight: bold;">${summary.manualNotes}</div>
                    <div style="font-size: 12px; opacity: 0.9;">Notas Manuales</div>
                </div>
            </div>
            <p style="margin: 15px 0 0 0; text-align: center; font-size: 14px; opacity: 0.9;">
                游늰 Periodo: ${startDate} - ${endDate}
            </p>
        </div>
    `;
}

// Funci칩n para cerrar modal de historial
function closeHistoryModal() {
    document.getElementById('participantHistoryModal').style.display = 'none';
    currentHistoryParticipantId = null;
}

// Funci칩n para mostrar modal de agregar nota manual
function showAddManualNoteModal() {
    if (!currentHistoryParticipantId) {
        showNotification('Error: No hay participante seleccionado', 'error');
        return;
    }
    
    const participant = participants.find(p => p.id === currentHistoryParticipantId);
    if (!participant) {
        showNotification('Participante no encontrado', 'error');
        return;
    }
    
    // Llenar datos
    document.getElementById('note-participantName').value = `${participant.firstName} ${participant.lastName}`;
    document.getElementById('note-date').valueAsDate = new Date();
    
    // Mostrar modal
    document.getElementById('manualNoteModal').style.display = 'flex';
}

// Funci칩n para cerrar modal de nota manual
function closeManualNoteModal() {
    document.getElementById('manualNoteModal').style.display = 'none';
    document.getElementById('manualNoteForm').reset();
}

// Funci칩n para guardar nota manual
async function saveManualNote() {
    const form = document.getElementById('manualNoteForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const noteType = document.getElementById('note-type').value;
    const description = document.getElementById('note-description').value;
    const noteDate = document.getElementById('note-date').value;
    
    const typeLabels = {
        'service': 'Servicio prestado',
        'followup': 'Seguimiento',
        'general': 'Nota general',
        'achievement': 'Logro/Avance'
    };
    
    try {
        await addToParticipantHistory(currentHistoryParticipantId, {
            eventType: 'manual_note',
            eventTitle: typeLabels[noteType],
            description: description,
            timestamp: new Date(noteDate + 'T' + new Date().toTimeString().split(' ')[0]).toISOString(),
            data: {
                noteType: noteType,
                addedBy: 'admin@uagm.edu'
            }
        });
        
        // Recargar timeline
        loadHistoryTimeline(currentHistoryParticipantId);
        
        // Cerrar modal
        closeManualNoteModal();
        
        showNotification('Nota agregada exitosamente al historial', 'success');
        
    } catch (error) {
        console.error('Error guardando nota:', error);
        showNotification('Error guardando la nota. Intenta de nuevo.', 'error');
    }
}

// Funci칩n para eliminar evento del historial (solo notas manuales)
async function deleteHistoryEvent(eventId) {
    if (!confirm('쮼st치s seguro de que quieres eliminar esta nota del historial?')) {
        return;
    }
    
    try {
        // Eliminar de Firebase
        if (isFirebaseInitialized) {
            const snapshot = await db.collection('participantHistory')
                .where('id', '==', eventId)
                .get();
            
            if (!snapshot.empty) {
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log('Evento eliminado de Firebase:', eventId);
            }
        }
        
        // Eliminar de memoria local
        participantHistory = participantHistory.filter(h => h.id !== eventId);
        
        // Actualizar localStorage
        localStorage.setItem('participantHistory', JSON.stringify(participantHistory));
        
        // Recargar timeline
        loadHistoryTimeline(currentHistoryParticipantId);
        
        showNotification('Nota eliminada del historial', 'success');
        
    } catch (error) {
        console.error('Error eliminando evento:', error);
        showNotification('Error eliminando la nota. Intenta de nuevo.', 'error');
    }
}

// ============= FIN FUNCIONES DE INTERFAZ PARA HISTORIAL =============

// ============= FUNCI칍N PARA GENERAR PDF DEL HISTORIAL =============

function generateParticipantHistoryPDF() {
    if (!currentHistoryParticipantId) {
        showNotification('Error: No hay participante seleccionado', 'error');
        return;
    }
    
    const participant = participants.find(p => p.id === currentHistoryParticipantId);
    if (!participant) {
        showNotification('Participante no encontrado', 'error');
        return;
    }
    
    const history = getParticipantHistory(currentHistoryParticipantId);
    if (history.length === 0) {
        showNotification('No hay historial para generar', 'warning');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;
    const margin = 20;
    const lineHeight = 6;
    const pageHeight = 280;
    
    // Funci칩n auxiliar para agregar texto
    function addText(text, x, y, fontSize = 10, style = 'normal') {
        doc.setFontSize(fontSize);
        doc.setFont('helvetica', style);
        doc.text(text, x, y);
    }
    
    // Funci칩n auxiliar para agregar l칤nea separadora
    function addLine(y) {
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.5);
        doc.line(margin, y, 190, y);
    }
    
    // Funci칩n para verificar espacio y agregar p치gina
    function checkSpace(needed) {
        if (yPos + needed > pageHeight) {
            doc.addPage();
            yPos = 20;
            return true;
        }
        return false;
    }

    // ========== PORTADA ==========
    doc.setFillColor(200, 16, 46);
    doc.rect(0, 0, 210, 80, 'F');
    
    doc.setTextColor(255, 255, 255);
    addText('UNIVERSIDAD ANA G. M칄NDEZ', margin, 30, 18, 'bold');
    addText('OFICINA DE CARRERAS Y COLOCACIONES', margin, 42, 14, 'bold');
    addText('HISTORIAL COMPLETO DEL PARTICIPANTE', margin, 54, 14, 'bold');
    
    yPos = 90;
    doc.setTextColor(0, 0, 0);
    
    // Informaci칩n del participante
    doc.setFillColor(248, 249, 250);
    doc.rect(margin - 5, yPos - 5, 175, 35, 'F');
    
    addText('PARTICIPANTE:', margin, yPos, 12, 'bold');
    yPos += 8;
    addText(`${participant.firstName} ${participant.lastName}`, margin, yPos, 14, 'bold');
    yPos += 8;
    addText(`Email: ${participant.email}`, margin, yPos, 10);
    yPos += 6;
    addText(`Campus: ${getCampusLabel(participant.campus)}`, margin, yPos, 10);
    yPos += 6;
    addText(`Concentraci칩n: ${participant.concentration}`, margin, yPos, 10);
    yPos += 15;
    
    addText('Fecha de generaci칩n: ' + new Date().toLocaleDateString('es-ES'), margin, yPos, 9);
    addText('ID: ' + participant.id, 120, yPos, 9);
    yPos += 10;
    addLine(yPos);
    yPos += 15;

    // ========== TIMELINE DE EVENTOS ==========
    doc.setTextColor(200, 16, 46);
    addText('TIMELINE DE ACTIVIDADES', margin, yPos, 14, 'bold');
    yPos += 10;
    doc.setTextColor(0, 0, 0);
    
    history.forEach((event, index) => {
        checkSpace(50);
        
        const date = new Date(event.timestamp);
        const formattedDate = date.toLocaleDateString('es-ES');
        const formattedTime = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        const icon = getEventIcon(event.eventType);
        const title = getEventTitle(event.eventType);
        
        // Fondo del evento
        const bgColors = {
            'registration': [232, 245, 233],
            'application': [227, 242, 253],
            'referral': [232, 245, 233],
            'rejection': [255, 235, 238],
            'placement': [255, 243, 224],
            'appointment_scheduled': [243, 229, 245],
            'appointment_completed': [232, 245, 233],
            'appointment_cancelled': [255, 235, 238],
            'appointment_rescheduled': [255, 243, 224],
            'resume_builder': [225, 245, 254],
            'manual_note': [245, 245, 245]
        };
        
        const bgColor = bgColors[event.eventType] || [245, 245, 245];
        doc.setFillColor(...bgColor);
        doc.rect(margin - 3, yPos - 3, 173, 25, 'F');
        
        // Icono y t칤tulo
        addText(icon, margin, yPos + 4, 14);
        doc.setTextColor(200, 16, 46);
        addText(title, margin + 10, yPos + 4, 11, 'bold');
        
        // Fecha y hora
        doc.setTextColor(108, 117, 125);
        addText(`${formattedDate} - ${formattedTime}`, margin + 10, yPos + 10, 8);
        yPos += 15;
        
        // Descripci칩n
        doc.setTextColor(0, 0, 0);
        const descLines = doc.splitTextToSize(event.description, 150);
        doc.text(descLines, margin + 10, yPos);
        yPos += descLines.length * 4 + 3;
        
        // Detalles espec칤ficos seg칰n tipo
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        
        switch(event.eventType) {
            case 'application':
            case 'referral':
            case 'rejection':
                if (event.data?.companyName) {
                    addText(` Empresa: ${event.data.companyName} | Posici칩n: ${event.data.offerTitle}`, margin + 12, yPos, 8);
                    yPos += 4;
                }
                if (event.eventType === 'rejection' && event.data?.reason) {
                    const reasonLines = doc.splitTextToSize(`Raz칩n: ${event.data.reason}`, 140);
                    doc.text(reasonLines, margin + 12, yPos);
                    yPos += reasonLines.length * 4;
                }
                if (event.eventType === 'referral' && event.data?.notes) {
                    const notesLines = doc.splitTextToSize(`Notas: ${event.data.notes}`, 140);
                    doc.text(notesLines, margin + 12, yPos);
                    yPos += notesLines.length * 4;
                }
                break;
                
            case 'placement':
                if (event.data?.company) {
                    addText(` Empresa: ${event.data.company} | Posici칩n: ${event.data.position}`, margin + 12, yPos, 8);
                    yPos += 4;
                    addText(` Tipo: ${event.data.positionType === 'full-time' ? 'Full-Time' : 'Part-Time'} | Seguimiento: ${event.data.trackingType === 'directo' ? 'Directo' : 'Indirecto'}`, margin + 12, yPos, 8);
                    yPos += 4;
                }
                break;
                
            case 'appointment_scheduled':
            case 'appointment_completed':
            case 'appointment_cancelled':
            case 'appointment_rescheduled':
                if (event.data?.appointmentDate) {
                    addText(` Fecha: ${formatLocalDate(event.data.appointmentDate)} ${event.data.appointmentTime} | Campus: ${getCampusLabel(event.data.campus)}`, margin + 12, yPos, 8);
                    yPos += 4;
                }
                break;
        }
        
        yPos += 8;
        doc.setTextColor(0, 0, 0);
        
        checkSpace(10);
    });

    // ========== RESUMEN ESTAD칈STICO ==========
    checkSpace(70);
    
    doc.addPage();
    yPos = 20;
    
    doc.setFillColor(200, 16, 46);
    doc.rect(0, yPos - 10, 210, 20, 'F');
    doc.setTextColor(255, 255, 255);
    addText('游늵 RESUMEN DE ACTIVIDAD', margin, yPos, 14, 'bold');
    
    yPos += 20;
    doc.setTextColor(0, 0, 0);
    
    const summary = {
        applications: history.filter(h => h.eventType === 'application').length,
        referrals: history.filter(h => h.eventType === 'referral').length,
        rejections: history.filter(h => h.eventType === 'rejection').length,
        placements: history.filter(h => h.eventType === 'placement').length,
        appointmentsScheduled: history.filter(h => h.eventType === 'appointment_scheduled').length,
        appointmentsCompleted: history.filter(h => h.eventType === 'appointment_completed').length,
        appointmentsCancelled: history.filter(h => h.eventType === 'appointment_cancelled').length,
        resumeBuilder: history.filter(h => h.eventType === 'resume_builder').length,
        manualNotes: history.filter(h => h.eventType === 'manual_note').length
    };
    
    // Grid de estad칤sticas
    const stats = [
        { label: 'Total de Aplicaciones', value: summary.applications, icon: '游닋' },
        { label: 'Referidos Enviados', value: summary.referrals, icon: '九' },
        { label: 'Solicitudes Rechazadas', value: summary.rejections, icon: '仇' },
        { label: 'Colocaciones Exitosas', value: summary.placements, icon: '游꿢' },
        { label: 'Citas Programadas', value: summary.appointmentsScheduled, icon: '游늰' },
        { label: 'Citas Completadas', value: summary.appointmentsCompleted, icon: '九' },
        { label: 'Citas Canceladas', value: summary.appointmentsCancelled, icon: '九' },
        { label: 'Registros Resume Builder', value: summary.resumeBuilder, icon: '游늯' },
        { label: 'Notas Manuales', value: summary.manualNotes, icon: '游닇' }
    ];
    
    let col = 0;
    let row = 0;
    const colWidth = 85;
    const rowHeight = 20;
    
    stats.forEach(stat => {
        const x = margin + (col * colWidth);
        const y = yPos + (row * rowHeight);
        
        doc.setFillColor(248, 249, 250);
        doc.rect(x, y, 80, 15, 'F');
        
        addText(stat.icon, x + 3, y + 10, 12);
        addText(stat.value.toString(), x + 12, y + 10, 16, 'bold');
        addText(stat.label, x + 25, y + 10, 9);
        
        col++;
        if (col >= 2) {
            col = 0;
            row++;
        }
    });
    
    yPos += (Math.ceil(stats.length / 2) * rowHeight) + 20;
    
    // Periodo
    const firstEvent = history[history.length - 1];
    const lastEvent = history[0];
    const startDate = new Date(firstEvent.timestamp).toLocaleDateString('es-ES');
    const endDate = new Date(lastEvent.timestamp).toLocaleDateString('es-ES');
    
    doc.setFillColor(227, 242, 253);
    doc.rect(margin - 5, yPos, 175, 15, 'F');
    addText(`游늰 Periodo de Actividad: ${startDate} - ${endDate}`, margin, yPos + 10, 10, 'bold');
    yPos += 25;
    
    addText(`游늵 Total de Eventos Registrados: ${history.length}`, margin, yPos, 10);
    yPos += 10;

    // ========== PIE DE P츼GINA ==========
    yPos = 270;
    addLine(yPos - 5);
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    addText('Documento Confidencial - Oficina de Carreras y Colocaciones UAGM', margin, yPos);
    addText('Generado el: ' + new Date().toLocaleString('es-ES'), margin, yPos + 5);
    addText('Este documento forma parte del expediente del participante', margin, yPos + 10);

    // Generar y descargar
    const fileName = `Historial_${participant.firstName}_${participant.lastName}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    
    showNotification('PDF del historial generado: ' + fileName, 'success');
}

// ============= FIN FUNCI칍N PARA GENERAR PDF DEL HISTORIAL =============

// ============= FUNCIONES PARA SEGUIMIENTOS MANPOWER =============

// Cargar tabla de seguimientos
function loadFollowupsTable() {
    const container = document.getElementById('followupsTableContainer');
    
    if (followups.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-clipboard-check"></i>
                <h3>No hay seguimientos registrados</h3>
                <p>Los seguimientos de Manpower aparecer치n aqu칤</p>
            </div>
        `;
        return;
    }

    let html = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Tel칠fono</th>
                    <th>Tipo Participante</th>
                    <th>Concentraci칩n</th>
                    <th>Servicio Ofrecido</th>
                    <th>Tipo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
    `;

    followups.forEach(followup => {
        const followupDate = followup.appointmentDate ? formatLocalDate(followup.appointmentDate) : 
                            (followup.createdAt ? new Date(followup.createdAt).toLocaleDateString('es-ES') : 'Sin fecha');
        
        const participantTypeLabel = followup.participantType === 'new' ? 'Nuevo' : 'Seguimiento';
        const typeLabel = followup.type === 'citado' ? 'Citado' : 'Walk-in';

        html += `
            <tr>
                <td>${followupDate}</td>
                <td><strong>${followup.fullName}</strong></td>
                <td>${followup.email}</td>
                <td>${followup.phone}</td>
                <td><span class="status-badge ${followup.participantType === 'new' ? 'status-active' : 'status-approved'}">${participantTypeLabel}</span></td>
                <td>${followup.concentration}</td>
                <td>${followup.serviceOffered ? followup.serviceOffered.substring(0, 50) + '...' : 'N/A'}</td>
                <td><span class="status-badge ${followup.type === 'citado' ? 'status-approved' : 'status-pending'}">${typeLabel}</span></td>
                <td>
                    <div class="actions">
                        <button class="btn btn-info btn-small" onclick="viewFollowupDetails('${followup.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteFollowup('${followup.id}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

// Ver detalles de seguimiento
function viewFollowupDetails(followupId) {
    const followup = followups.find(f => f.id === followupId);
    if (!followup) return;

    const participantTypeLabel = followup.participantType === 'new' ? 'Nuevo Participante' : 'Participante de Seguimiento';
    const typeLabel = followup.type === 'citado' ? 'Citado (Cita Agendada)' : 'Walk-in (Sin cita previa)';
    const followupDate = followup.appointmentDate ? formatLocalDate(followup.appointmentDate) : 
                        (followup.createdAt ? new Date(followup.createdAt).toLocaleDateString('es-ES') : 'Sin fecha');

    document.getElementById('modalTitle').textContent = `Seguimiento: ${followup.fullName}`;
    document.getElementById('modalBody').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
            <div>
                <h4 style="color: #28a745; margin-bottom: 15px;">游녻 Informaci칩n del Participante</h4>
                <p><strong>Nombre Completo:</strong> ${followup.fullName}</p>
                <p><strong>Email:</strong> ${followup.email}</p>
                <p><strong>Tel칠fono:</strong> ${followup.phone}</p>
                <p><strong>Concentraci칩n:</strong> ${followup.concentration}</p>
                <p><strong>Tipo:</strong> <span class="status-badge status-active">${participantTypeLabel}</span></p>
            </div>
            <div>
                <h4 style="color: #28a745; margin-bottom: 15px;">游늶 Informaci칩n de la Sesi칩n</h4>
                <p><strong>Fecha Atendida:</strong> ${followupDate}</p>
                <p><strong>Tipo de Participante:</strong> <span class="status-badge ${followup.type === 'citado' ? 'status-approved' : 'status-pending'}">${typeLabel}</span></p>
                <p><strong>Registrado:</strong> ${new Date(followup.createdAt).toLocaleString('es-ES')}</p>
                <p><strong>Fuente:</strong> ${followup.source || 'Registro de Seguimiento'}</p>
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <h4 style="color: #28a745; margin-bottom: 15px;">游눺 Servicio Ofrecido</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap;">
                ${followup.serviceOffered || 'No especificado'}
            </div>
        </div>
    `;

    document.getElementById('detailsModal').style.display = 'flex';
}

// Eliminar seguimiento
async function deleteFollowup(followupId) {
    const followup = followups.find(f => f.id === followupId);
    if (!followup) return;
    
    if (confirm(`쮼st치s seguro de que quieres eliminar el seguimiento de "${followup.fullName}"?`)) {
        try {
            let deletedFromFirebase = false;
            
            // Eliminar de Firebase
            if (isFirebaseInitialized) {
                try {
                    // Intentar encontrar por campo 'id'
                    const snapshot = await db.collection('followups')
                        .where('id', '==', followupId)
                        .get();
                    
                    if (!snapshot.empty) {
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        deletedFromFirebase = true;
                        console.log('Seguimiento eliminado de Firebase (por campo id):', followupId);
                    } else {
                        // Si no lo encuentra por campo, intentar por document ID
                        try {
                            await db.collection('followups').doc(followupId).delete();
                            deletedFromFirebase = true;
                            console.log('Seguimiento eliminado de Firebase (por document ID):', followupId);
                        } catch (docError) {
                            console.warn('No se pudo eliminar por document ID:', docError);
                        }
                    }
                } catch (fbError) {
                    console.error('Error eliminando de Firebase:', fbError);
                }
            }
            
            // Siempre eliminar de memoria local y localStorage
            followups = followups.filter(f => f.id !== followupId);
            localStorage.setItem('followups', JSON.stringify(followups));
            
            // Actualizar interfaz
            filterFollowups();
            updateStats();
            
            if (deletedFromFirebase || !isFirebaseInitialized) {
                showNotification('Seguimiento eliminado exitosamente', 'success');
            } else {
                showNotification('Seguimiento eliminado localmente (verifica Firebase)', 'warning');
            }
            
        } catch (error) {
            console.error('Error eliminando seguimiento:', error);
            showNotification('Error eliminando el seguimiento. Intenta de nuevo.', 'error');
        }
    }
}

// Filtrar seguimientos
function filterFollowups() {
    // Guardar valores actuales de los filtros
    currentFilters.followups.search = document.getElementById('followupsSearch').value.toLowerCase();
    currentFilters.followups.type = document.getElementById('followupsTypeFilter').value;
    currentFilters.followups.participantType = document.getElementById('followupsParticipantTypeFilter').value;
    currentFilters.followups.date = document.getElementById('followupsDateFilter').value;
    
    let filtered = followups;
    
    // Filtro de b칰squeda
    if (currentFilters.followups.search) {
        filtered = filtered.filter(followup => 
            followup.fullName.toLowerCase().includes(currentFilters.followups.search) ||
            followup.email.toLowerCase().includes(currentFilters.followups.search) ||
            followup.phone.includes(currentFilters.followups.search) ||
            followup.concentration.toLowerCase().includes(currentFilters.followups.search) ||
            (followup.serviceOffered && followup.serviceOffered.toLowerCase().includes(currentFilters.followups.search))
        );
    }
    
    // Filtro de tipo de participante
    if (currentFilters.followups.type) {
        filtered = filtered.filter(followup => followup.participantType === currentFilters.followups.type);
    }
    
    // Filtro de tipo (citado/walk-in)
    if (currentFilters.followups.participantType) {
        filtered = filtered.filter(followup => followup.type === currentFilters.followups.participantType);
    }
    
    // Filtro de fecha
    if (currentFilters.followups.date) {
        const today = new Date();
        filtered = filtered.filter(followup => {
            const fDate = new Date(followup.createdAt);
            
            switch(currentFilters.followups.date) {
                case 'today':
                    return fDate.toDateString() === today.toDateString();
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    return fDate >= weekAgo;
                case 'month':
                    return fDate.getMonth() === today.getMonth() && 
                           fDate.getFullYear() === today.getFullYear();
                default:
                    return true;
            }
        });
    }
    
    displayFilteredFollowups(filtered);
}

// Mostrar seguimientos filtrados
function displayFilteredFollowups(filtered) {
    const container = document.getElementById('followupsTableContainer');
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-search"></i>
                <h3>No se encontraron seguimientos</h3>
                <p>No hay seguimientos que coincidan con los filtros aplicados</p>
            </div>
        `;
        return;
    }

    let html = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Tel칠fono</th>
                    <th>Tipo Participante</th>
                    <th>Concentraci칩n</th>
                    <th>Servicio Ofrecido</th>
                    <th>Tipo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
    `;

    filtered.forEach(followup => {
        const followupDate = followup.appointmentDate ? formatLocalDate(followup.appointmentDate) : 
                            (followup.createdAt ? new Date(followup.createdAt).toLocaleDateString('es-ES') : 'Sin fecha');
        
        const participantTypeLabel = followup.participantType === 'new' ? 'Nuevo' : 'Seguimiento';
        const typeLabel = followup.type === 'citado' ? 'Citado' : 'Walk-in';

        html += `
            <tr>
                <td>${followupDate}</td>
                <td><strong>${followup.fullName}</strong></td>
                <td>${followup.email}</td>
                <td>${followup.phone}</td>
                <td><span class="status-badge ${followup.participantType === 'new' ? 'status-active' : 'status-approved'}">${participantTypeLabel}</span></td>
                <td>${followup.concentration}</td>
                <td>${followup.serviceOffered ? followup.serviceOffered.substring(0, 50) + '...' : 'N/A'}</td>
                <td><span class="status-badge ${followup.type === 'citado' ? 'status-approved' : 'status-pending'}">${typeLabel}</span></td>
                <td>
                    <div class="actions">
                        <button class="btn btn-info btn-small" onclick="viewFollowupDetails('${followup.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteFollowup('${followup.id}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

// Exportar seguimientos
function exportFollowupsData() {
    if (followups.length === 0) {
        showNotification('No hay seguimientos para exportar', 'warning');
        return;
    }

    const data = followups.map(followup => ({
        'Fecha': followup.appointmentDate ? formatLocalDate(followup.appointmentDate) : 
                (followup.createdAt ? new Date(followup.createdAt).toLocaleDateString('es-ES') : 'Sin fecha'),
        'Nombre Completo': followup.fullName,
        'Email': followup.email,
        'Tel칠fono': followup.phone,
        'Concentraci칩n': followup.concentration,
        'Tipo Participante': followup.participantType === 'new' ? 'Nuevo' : 'Seguimiento',
        'Tipo': followup.type === 'citado' ? 'Citado (Cita Agendada)' : 'Walk-in (Sin cita previa)',
        'Servicio Ofrecido': followup.serviceOffered || 'No especificado',
        'Fecha Registro': new Date(followup.createdAt).toLocaleDateString('es-ES'),
        'Fuente': followup.source || 'Registro de Seguimiento'
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Seguimientos Manpower");
    
    const filename = `Seguimientos_Manpower_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, filename);
    
    showNotification('Seguimientos exportados exitosamente', 'success');
}

// ============= FIN FUNCIONES SEGUIMIENTOS MANPOWER =============

    </script>
</body>
</html>
